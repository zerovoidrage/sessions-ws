# ะะฝะฐะปะธะท ะผะฐัััะฐะฑะธััะตะผะพััะธ ะธ ะฟะปะฐะฝ ะผะธะณัะฐัะธะธ

**ะะฐัะฐ:** 2025-01-30  
**ะกัะฐััั:** ะะฝะฐะปะธะท ะทะฐะฒะตััะตะฝ, ะฟะปะฐะฝ ะผะธะณัะฐัะธะธ ะณะพัะพะฒ

---

## ะะพะธ ะบะพะผะผะตะฝัะฐัะธะธ ะฝะฐ ะฐะฝะฐะปะธะท

### โ ะก ัะตะผ ะฟะพะปะฝะพัััั ัะพะณะปะฐัะตะฝ

1. **ะััะธัะตะบัััะฐ ะบะพะดะฐ โ ะดะตะนััะฒะธัะตะปัะฝะพ ะฝะฐ ััะพะฒะฝะต ะฟัะพะดะฐะบัะตะฝะฐ**
   - ะะฐะทะดะตะปะตะฝะธะต domain/infra/application/api โ ัะธััะพะต ะธ ะผะฐัััะฐะฑะธััะตะผะพะต
   - ะะพะดัะปัะฝะฐั ััััะบัััะฐ ะฟะพะทะฒะพะปัะตั ะปะตะณะบะพ ะฟะตัะตัะฐะฑะฐััะฒะฐัั ะบะพะผะฟะพะฝะตะฝัั
   - UI ะพัะดะตะปะตะฝ ะพั ะฑะธะทะฝะตั-ะปะพะณะธะบะธ โ ะฟัะฐะฒะธะปัะฝะพ

2. **ะะพะดะตะปั ััะฐะฝัะบัะธะฟัะธะธ โ ะณะปะฐะฒะฝะพะต ัะทะบะพะต ะผะตััะพ**
   - 1000 ะฟะพะปัะทะพะฒะฐัะตะปะตะน = 1000 WebSocket ะบะพะฝะฝะตะบัะพะฒ = 1000 Gladia ัะตััะธะน
   - ะญัะพ ะดะตะนััะฒะธัะตะปัะฝะพ ัะฑัะตั ะฟะพ ะดะตะฝัะณะฐะผ (Gladia) ะธ ะฟะพ ัะตััััะฐะผ (WS-ัะตัะฒะตั)
   - **ะะพะน ะฒะตัะดะธะบั: ะฟะตัะตัะพะด ะฝะฐ "1 ััะฐะฝัะบัะธะฟัะธั ะฝะฐ ัะตััะธั" โ ััะพ MUST-HAVE, ะฝะต nice-to-have**

3. **ะะ ะทะฐะฟะธัะธ โ ะบัะธัะธัะฝัะน ะผะพะผะตะฝั**
   - ะกะตะนัะฐั: `upsertTranscriptSegmentByUtterance` ะฝะฐ **ะบะฐะถะดัะน** partial ะพั Gladia
   - ะัะธ 1000 ะฟะพะปัะทะพะฒะฐัะตะปัั ััะพ ะผะพะถะตั ะฑััั **ัะพัะฝะธ ะทะฐะฟัะพัะพะฒ ะฒ ัะตะบัะฝะดั** ะฝะฐ ะพะดะฝั ัะตััะธั
   - **ะะตัะตะฝะธะต: ะฟะธัะฐัั ัะพะปัะบะพ final ัะตะณะผะตะฝัั** โ ัะพะณะปะฐัะตะฝ ะฝะฐ 100%

4. **ะะฒัะพัะธะทะฐัะธั WS โ ัะตััะตะทะฝะฐั ะดััะฐ**
   - ะกะตะนัะฐั: `ws://.../api/realtime/transcribe?sessionSlug=...` โ ะปัะฑะพะน, ะบัะพ ะทะฝะฐะตั slug, ะผะพะถะตั ะฟะพะดะบะปััะธัััั
   - **ะญัะพ security risk** ะดะฐะถะต ะดะปั MVP, ะฝะต ะณะพะฒะพัั ะฟัะพ ะฟัะพะดะฐะบัะตะฝ

### ๐ค ะก ัะตะผ ัะฐััะธัะฝะพ ะฝะต ัะพะณะปะฐัะตะฝ / ััะตะฑััั ััะพัะฝะตะฝะธั

1. **"ะะปะธะตะฝััะบะธะน, ะฝะพ ะพะดะธะฝ ะฒะปะฐะดะตะปะตั ััะฐะฝัะบัะธะฟัะธะธ"**
   - ะญัะพ ะฒัะต ะตัะต ะฝะฐะณััะทะบะฐ ะฝะฐ ะบะปะธะตะฝัะฐ (host ะดะพะปะถะตะฝ ะฑััั ะพะฝะปะฐะนะฝ)
   - ะัะปะธ host ัะนะดะตั โ ััะฐะฝัะบัะธะฟัะธั ัะฟะฐะดะตั
   - **ะัะตะดะฟะพััะธัะตะปัะฝะตะต: server-side ะผะธะบั ัะตัะตะท LiveKit egress**

2. **"ะะต ัะพััะฐะฝััั partial-ั ะฒ ะะ"**
   - ะกะพะณะปะฐัะตะฝ ะดะปั ะผะฐัััะฐะฑะฐ 500-1000 ะพะฝะปะฐะนะฝะฐ
   - ะะพ ะดะปั ะธััะพัะธะธ/ะฐะฝะฐะปะธัะธะบะธ partial-ั ะผะพะณัั ะฑััั ะฟะพะปะตะทะฝั (ะฟะพะบะฐะทัะฒะฐัั ะฟัะพะณัะตัั ัะตะบััะฐ)
   - **ะะพะผะฟัะพะผะธัั:** ััะฐะฝะธัั partial-ั ะฒ ะฟะฐะผััะธ/Redis, ัะธะฝะฐะปัะฝัะต โ ะฒ ะะ

3. **ะะพัะธะทะพะฝัะฐะปัะฝะพะต ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธะต WS-ัะตัะฒะตัะฐ**
   - ะะปั ััะฐััะฐ (50-200 ะพะฝะปะฐะนะฝะฐ) ะพะดะธะฝ ะธะฝััะฐะฝั ัะฟัะฐะฒะธััั
   - ะะพ ะฟะปะฐะฝ ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธั ะฝัะถะตะฝ ัะถะต ัะตะนัะฐั

---

## ะะปะฐะฝ ะผะธะณัะฐัะธะธ: 3 ััะฐะฟะฐ

### ะญัะฐะฟ 1: ะัะธัะธัะตัะบะธะต ัะธะบัั (MVP โ 200-500 ะพะฝะปะฐะนะฝะฐ)

**ะฆะตะปั:** ะฃะฑัะฐัั ะฑะปะพะบะตัั, ะบะพัะพััะต ัะฑััั ะฟัะพะดัะบั ัะถะต ะฟัะธ 200+ ะฟะพะปัะทะพะฒะฐัะตะปัั

**ะกัะพะบ:** 1-2 ะฝะตะดะตะปะธ

#### 1.1. ะะณัะฐะฝะธัะธัั ะทะฐะฟะธัั ะฒ ะะ ัะพะปัะบะพ final ัะตะณะผะตะฝัะฐะผะธ

**ะขะตะบััะฐั ะฟัะพะฑะปะตะผะฐ:**
```typescript
// ws/server/client-connection.ts
bridge.onTranscript(async (event: TranscriptEvent) => {
  await appendTranscriptChunk({
    isFinal: event.isFinal, // โ ะฟะธัะตััั ะะกะ, ะฒะบะปััะฐั partial
  })
})
```

**ะะตัะตะฝะธะต:**
```typescript
bridge.onTranscript(async (event: TranscriptEvent) => {
  // ะะธัะตะผ ะฒ ะะ ัะพะปัะบะพ ัะธะฝะฐะปัะฝัะต ัะตะณะผะตะฝัั
  if (event.isFinal) {
    await appendTranscriptChunk({
      ...event,
      isFinal: true,
    })
  } else {
    // Partial ะพัะฟัะฐะฒะปัะตะผ ัะพะปัะบะพ ะบะปะธะตะฝัั ัะตัะตะท WebSocket
    // ะะต ัะพััะฐะฝัะตะผ ะฒ ะะ
    if (ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({
        type: 'transcription',
        text: event.text,
        is_final: false,
        utterance_id: event.utteranceId,
      }))
    }
  }
})
```

**ะคะฐะนะปั ะดะปั ะธะทะผะตะฝะตะฝะธั:**
- `ws/server/client-connection.ts` โ ะดะพะฑะฐะฒะธัั ะฟัะพะฒะตัะบั `isFinal`
- `src/modules/core/sessions/infra/transcription/appendTranscriptChunk.ts` โ ะพะฟัะธะพะฝะฐะปัะฝะพ ะดะพะฑะฐะฒะธัั ะฒะฐะปะธะดะฐัะธั

**ะัะตะฝะบะฐ ัััะตะบัะฐ:**
- ะกะฝะธะถะตะฝะธะต write-ะพะฒ ะฒ ะะ ะฒ **50-100 ัะฐะท** (partial ะพะฑะฝะพะฒะปัะตััั ะบะฐะถะดัะต 200-500ะผั)
- ะะตะฝััะต lock-ะบะพะฝัะปะธะบัะพะฒ ะฝะฐ unique index

#### 1.2. ะะพะฑะฐะฒะธัั JWT-ะฐะฒัะพัะธะทะฐัะธั ะดะปั WebSocket

**ะขะตะบััะฐั ะฟัะพะฑะปะตะผะฐ:**
```typescript
// ws://.../api/realtime/transcribe?sessionSlug=abc123
// ะัะฑะพะน, ะบัะพ ะทะฝะฐะตั slug, ะผะพะถะตั ะฟะพะดะบะปััะธัััั
```

**ะะตัะตะฝะธะต:**

**ะจะฐะณ 1:** ะะตะฝะตัะฐัะธั transcription token ะฒ API

```typescript
// src/modules/core/sessions/infra/livekit/token.service.ts

export interface TranscriptionTokenResult {
  transcriptionToken: string // JWT ะดะปั WS
  expiresIn: number
}

export async function generateTranscriptionToken(input: {
  sessionSlug: string
  userId?: string
  identity: string
}): Promise<TranscriptionTokenResult> {
  const session = await getSessionBySlug({ slug: input.sessionSlug })
  if (!session) {
    throw new Error('Session not found')
  }

  // ะัะพะฒะตััะตะผ, ััะพ ะฟะพะปัะทะพะฒะฐัะตะปั ะธะผะตะตั ะดะพัััะฟ ะบ ัะตััะธะธ
  // (ัะตัะตะท spaceId, ะตัะปะธ ะฝัะถะฝะพ)

  const payload = {
    sub: input.userId || input.identity,
    sessionId: session.id,
    sessionSlug: session.slug,
    identity: input.identity,
    exp: Math.floor(Date.now() / 1000) + 3600, // 1 ัะฐั
  }

  const token = jwt.sign(payload, process.env.TRANSCRIPTION_JWT_SECRET!, {
    algorithm: 'HS256',
  })

  return {
    transcriptionToken: token,
    expiresIn: 3600,
  }
}
```

**ะจะฐะณ 2:** ะะพะทะฒัะฐั token ะฒะผะตััะต ั LiveKit token

```typescript
// src/app/api/sessions/[slug]/token/route.ts

export async function GET(req: Request, { params }: Params) {
  // ... ัััะตััะฒัััะธะน ะบะพะด ...
  
  const tokenResult = await generateToken({...})
  
  // ะะะะะะะขะฌ:
  const transcriptionTokenResult = await generateTranscriptionToken({
    sessionSlug: session.slug,
    userId: userId || undefined,
    identity,
  })

  return NextResponse.json({
    ...tokenResult,
    transcriptionToken: transcriptionTokenResult.transcriptionToken,
  })
}
```

**ะจะฐะณ 3:** ะะฐะปะธะดะฐัะธั token ะฝะฐ WS-ัะตัะฒะตัะต

```typescript
// ws/server/client-connection.ts

import jwt from 'jsonwebtoken'

function verifyTranscriptionToken(token: string): {
  sessionSlug: string
  identity: string
  userId?: string
} | null {
  try {
    const decoded = jwt.verify(
      token,
      process.env.TRANSCRIPTION_JWT_SECRET!
    ) as {
      sessionSlug: string
      identity: string
      sub?: string
      exp: number
    }

    return {
      sessionSlug: decoded.sessionSlug,
      identity: decoded.identity,
      userId: decoded.sub,
    }
  } catch (error) {
    return null
  }
}

export function handleClientConnection({ ws, req }: ClientConnectionOptions): void {
  const url = new URL(req.url || '', `http://${req.headers.host}`)
  
  // ะะะะะะะขะฌ: ะฟัะพะฒะตัะบะฐ token
  const token = url.searchParams.get('token')
  if (!token) {
    ws.close(4001, 'Missing transcription token')
    return
  }

  const tokenData = verifyTranscriptionToken(token)
  if (!tokenData) {
    ws.close(4001, 'Invalid transcription token')
    return
  }

  const { sessionSlug, identity } = tokenData
  // ... ะพััะฐะปัะฝะพะน ะบะพะด ะธัะฟะพะปัะทัะตั sessionSlug ะธ identity ะธะท token
}
```

**ะจะฐะณ 4:** ะะฑะฝะพะฒะปะตะฝะธะต ะบะปะธะตะฝัะฐ

```typescript
// src/hooks/useLocalParticipantTranscription.ts

// ะัะธ ะฟะพะดะบะปััะตะฝะธะธ ะบ WebSocket:
const wsUrl = `ws://${wsHost}:${wsPort}/api/realtime/transcribe?token=${encodeURIComponent(transcriptionToken)}`
```

**ะคะฐะนะปั ะดะปั ะธะทะผะตะฝะตะฝะธั:**
- `src/modules/core/sessions/infra/livekit/token.service.ts` โ ะดะพะฑะฐะฒะธัั `generateTranscriptionToken`
- `src/app/api/sessions/[slug]/token/route.ts` โ ะฒะพะทะฒัะฐัะฐัั transcription token
- `ws/server/client-connection.ts` โ ะฒะฐะปะธะดะธัะพะฒะฐัั token
- `src/hooks/useLocalParticipantTranscription.ts` โ ะฟะตัะตะดะฐะฒะฐัั token ะฒ URL

**ะัะตะฝะบะฐ ัััะตะบัะฐ:**
- ะะฐะบััะฒะฐะตั security hole
- ะะฐัะธัะฐ ะพั unauthorized access

#### 1.3. ะะพะฑะฐะฒะธัั ะฑะฐะทะพะฒัะต ะผะตััะธะบะธ ะดะปั WS-ัะตัะฒะตัะฐ

**ะะตัะตะฝะธะต:**

```typescript
// ws/server/metrics.ts

interface Metrics {
  activeConnections: number
  activeGladiaBridges: number
  totalMessagesReceived: number
  totalMessagesSent: number
  errors: number
  lastError?: {
    message: string
    timestamp: Date
  }
}

const metrics: Metrics = {
  activeConnections: 0,
  activeGladiaBridges: 0,
  totalMessagesReceived: 0,
  totalMessagesSent: 0,
  errors: 0,
}

export function incrementConnections() {
  metrics.activeConnections++
}

export function decrementConnections() {
  metrics.activeConnections--
}

export function incrementGladiaBridges() {
  metrics.activeGladiaBridges++
}

export function decrementGladiaBridges() {
  metrics.activeGladiaBridges--
}

export function incrementMessagesReceived() {
  metrics.totalMessagesReceived++
}

export function incrementMessagesSent() {
  metrics.totalMessagesSent++
}

export function recordError(message: string) {
  metrics.errors++
  metrics.lastError = { message, timestamp: new Date() }
}

export function getMetrics(): Metrics {
  return { ...metrics }
}

// HTTP endpoint ะดะปั ะผะตััะธะบ
// ws/server/index.ts
server.get('/metrics', (req, res) => {
  res.json(getMetrics())
})
```

**ะคะฐะนะปั ะดะปั ะธะทะผะตะฝะตะฝะธั:**
- `ws/server/metrics.ts` โ ะฝะพะฒัะน ัะฐะนะป
- `ws/server/client-connection.ts` โ ะธัะฟะพะปัะทะพะฒะฐัั ะผะตััะธะบะธ
- `ws/server/index.ts` โ ะดะพะฑะฐะฒะธัั /metrics endpoint

---

### ะญัะฐะฟ 2: ะะฟัะธะผะธะทะฐัะธั (200-500 โ 1000+ ะพะฝะปะฐะนะฝะฐ)

**ะฆะตะปั:** ะะตัะตะนัะธ ะฝะฐ ะผะพะดะตะปั "1 ััะฐะฝัะบัะธะฟัะธั ะฝะฐ ัะตััะธั"

**ะกัะพะบ:** 3-4 ะฝะตะดะตะปะธ

#### 2.1. ะัะฑะพั ะฐััะธัะตะบัััั: Server-side vs Client-side

**ะะตะบะพะผะตะฝะดะฐัะธั:** **Server-side ะผะธะบั ัะตัะตะท LiveKit Egress** (ะฟัะตะดะฟะพััะธัะตะปัะฝะตะต)

**ะะพัะตะผั:**
- ะะต ะทะฐะฒะธัะธั ะพั ะบะปะธะตะฝัะฐ (host ะผะพะถะตั ัะนัะธ)
- ะะตะฝััะต ะฝะฐะณััะทะบะธ ะฝะฐ ะบะปะธะตะฝั
- ะฆะตะฝััะฐะปะธะทะพะฒะฐะฝะฝะพะต ัะฟัะฐะฒะปะตะฝะธะต

**ะะปััะตัะฝะฐัะธะฒะฐ:** Client-side "designated host" (ะฟัะพัะต ัะตะฐะปะธะทะพะฒะฐัั)

#### 2.2. ะะปะฐะฝ: Server-side ะผะธะบั (LiveKit Egress)

**ะััะธัะตะบัััะฐ:**

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  LiveKit Cloud                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  Room (session-slug)                                   โ  โ
โ  โ  - Participant 1 (ะผะธะบัะพัะพะฝ)                            โ  โ
โ  โ  - Participant 2 (ะผะธะบัะพัะพะฝ)                            โ  โ
โ  โ  - Participant N (ะผะธะบัะพัะพะฝ)                            โ  โ
โ  โ                                                         โ  โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ  โ
โ  โ  โ  Egress Service (server-side)                    โ โ  โ
โ  โ  โ  - ะะธะบัะธััะตั ะฒัะต ะฐัะดะธะพ ััะตะบะธ ะฒ ะพะดะธะฝ ะฟะพัะพะบ        โ โ  โ
โ  โ  โ  - ะัะฟัะฐะฒะปัะตั ะผะธะบั ะฒ Transcription Service       โ โ  โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โ WebSocket / RTMP
                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Transcription Service (backend)                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ  - ะัะธะฝะธะผะฐะตั ะผะธะบั ะพั LiveKit Egress                      โ โ
โ  โ  - ะัะฟัะฐะฒะปัะตั ะฒ Gladia (1 ัะตััะธั ะฝะฐ ะบะพะผะฝะฐัั)            โ โ
โ  โ  - ะะพะปััะฐะตั ััะฐะฝัะบัะธะฟัั ั diarization                    โ โ
โ  โ  - ะกะพััะฐะฝัะตั final ะฒ ะะ                                  โ โ
โ  โ  - ะะฐัััะปะฐะตั ััะฐะฝัะบัะธะฟัั ัะตัะตะท LiveKit data channel     โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**ะจะฐะณะธ ัะตะฐะปะธะทะฐัะธะธ:**

1. **ะะฐัััะพะธัั LiveKit Egress**
   - ะัะฟะพะปัะทะพะฒะฐัั LiveKit Egress API ะดะปั ะฟะพะปััะตะฝะธั ะผะธะบัะฐ ะบะพะผะฝะฐัั
   - ะะฐัััะพะธัั RTMP/WebSocket ะฒััะพะด ะดะปั ััะฐะฝัะบัะธะฟัะธะธ

2. **ะกะพะทะดะฐัั Transcription Service**
   - ะัะดะตะปัะฝัะน ัะตัะฒะธั (ะธะปะธ ัะฐััะธัะตะฝะธะต WS-ัะตัะฒะตัะฐ)
   - ะัะธะฝะธะผะฐะตั ะผะธะบั ะพั LiveKit
   - ะกะพะทะดะฐะตั 1 Gladia ัะตััะธั ะฝะฐ ะบะพะผะฝะฐัั
   - ะะฑัะฐะฑะฐััะฒะฐะตั ััะฐะฝัะบัะธะฟัั ั diarization

3. **ะะฑะฝะพะฒะธัั ะบะปะธะตะฝั**
   - ะฃะฑัะฐัั ะปะพะบะฐะปัะฝัั ััะฐะฝัะบัะธะฟัะธั (AudioWorklet โ WS)
   - ะะพะปััะฐัั ััะฐะฝัะบัะธะฟัั ัะพะปัะบะพ ัะตัะตะท LiveKit data channel

**ะคะฐะนะปั ะดะปั ะธะทะผะตะฝะตะฝะธั:**
- ะะพะฒัะน ัะตัะฒะธั: `services/transcription-service/` (ะธะปะธ ัะฐััะธัะธัั `ws/server/`)
- `src/hooks/useLocalParticipantTranscription.ts` โ ัะฟัะพััะธัั (ัะฑัะฐัั WS/Gladia)
- ะะปะธะตะฝั ะฟะพะปััะฐะตั ััะฐะฝัะบัะธะฟัั ัะพะปัะบะพ ัะตัะตะท `useTranscriptStream`

#### 2.3. ะะปััะตัะฝะฐัะธะฒะฐ: Client-side "designated host"

**ะัะปะธ server-side ะผะธะบั ัะปะพะถะฝะพ ัะตะฐะปะธะทะพะฒะฐัั ัะตะนัะฐั:**

**ะััะธัะตะบัััะฐ:**

```typescript
// 1. ะะฐะทะฝะฐัะธัั "host" ะดะปั ััะฐะฝัะบัะธะฟัะธะธ ะฟัะธ ัะพะทะดะฐะฝะธะธ ัะตััะธะธ
//    ะธะปะธ ะฟัะธ ะฟะตัะฒะพะผ ะฒัะพะดะต ะฒ ะบะพะผะฝะฐัั

// 2. ะขะพะปัะบะพ host ะทะฐะฟััะบะฐะตั ััะฐะฝัะบัะธะฟัะธั
const isTranscriptionHost = session.createdByUserId === currentUserId || 
                           localParticipant.identity === session.hostIdentity

if (isTranscriptionHost) {
  // ะะฐะฟััะบะฐะตะผ ััะฐะฝัะบัะธะฟัะธั (ัััะตััะฒัััะธะน ะบะพะด)
  startTranscription()
} else {
  // ะขะพะปัะบะพ ัะปััะฐะตะผ ััะฐะฝัะบัะธะฟัั ัะตัะตะท LiveKit data
  // ะะต ัะพะทะดะฐะตะผ WS/Gladia ัะพะตะดะธะฝะตะฝะธั
}

// 3. ะัะธ ััะพะดะต host โ ะฟะตัะตะดะฐัั ัะพะปั ัะปะตะดัััะตะผั ััะฐััะฝะธะบั
```

**ะะธะฝััั:**
- ะะฐะฒะธัะธั ะพั ะบะปะธะตะฝัะฐ
- ะัะปะธ host ัะนะดะตั, ััะฐะฝัะบัะธะฟัะธั ะพััะฐะฝะพะฒะธััั
- ะะพ ะฟัะพัะต ัะตะฐะปะธะทะพะฒะฐัั, ัะตะผ server-side ะผะธะบั

---

### ะญัะฐะฟ 3: ะะฐัััะฐะฑะธัะพะฒะฐะฝะธะต ะธะฝััะฐััััะบัััั (1000+ ะพะฝะปะฐะนะฝะฐ)

**ะฆะตะปั:** ะะพะดะณะพัะพะฒะบะฐ ะบ ะณะพัะธะทะพะฝัะฐะปัะฝะพะผั ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธั

**ะกัะพะบ:** ะะพ ะฝะตะพะฑัะพะดะธะผะพััะธ (ะบะพะณะดะฐ ะฑัะดะตั 500+ ะฟะพััะพัะฝะฝัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน)

#### 3.1. ะะพัะธะทะพะฝัะฐะปัะฝะพะต ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธะต WS-ัะตัะฒะตัะฐ

**ะะปะฐะฝ:**
1. Docker-ะพะฑัะฐะท ะดะปั transcription service
2. Load balancer (nginx/Traefik) ั sticky sessions ะฟะพ sessionId
3. ะัะดะตะปัะฝัะต ะธะฝััะฐะฝัั transcription service

**ะััะธัะตะบัััะฐ:**

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Load Balancer (nginx/Traefik)                         โ
โ  - Sticky session ะฟะพ sessionId                         โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโ
             โ                              โ
    โโโโโโโโโโผโโโโโโโโโ          โโโโโโโโโโโผโโโโโโโโโ
    โ Transcription   โ          โ Transcription    โ
    โ Service #1      โ          โ Service #2       โ
    โ (Docker)        โ          โ (Docker)         โ
    โโโโโโโโโโโโโโโโโโโ          โโโโโโโโโโโโโโโโโโโโ
```

#### 3.2. ะัะตัะตะดั ะดะปั ะทะฐะฟะธัะธ ััะฐะฝัะบัะธะฟัะพะฒ

**ะะพะณะดะฐ ะฝัะถะฝะฐ:**
- ะัะธ 100+ ะฐะบัะธะฒะฝัั ัะตััะธัั
- ะัะธ ะฒััะพะบะพะน ัะฐััะพัะต ััะฐะฝัะบัะธะฟัะพะฒ

**ะะตัะตะฝะธะต:**
- Redis + BullMQ ะดะปั ะพัะตัะตะดะธ ะทะฐะดะฐั
- ะัะดะตะปัะฝัะน ะฒะพัะบะตั ะดะปั ะทะฐะฟะธัะธ ะฒ ะะ

**ะกะพะณะปะฐัะฝะพ ะฟัะฐะฒะธะปะฐะผ ะฟัะพะตะบัะฐ:** ะะฟะธัะฐัั ะฐััะธัะตะบัััะฝัะน ะฟะปะฐะฝ, ะฝะต ะฒะฝะตะดัััั ะฑะตะท ะทะฐะฟัะพัะฐ

**ะะปะฐะฝ:**
```
Transcription Service โ Redis Queue (BullMQ) โ Worker โ PostgreSQL
```

---

## ะัะธะพัะธัะธะทะฐัะธั

### ๐ด ะัะธัะธัะฝะพ (ัะดะตะปะฐัั ััะฐะทั)

1. โ **ะะณัะฐะฝะธัะธัั ะทะฐะฟะธัั ะฒ ะะ ัะพะปัะบะพ final ัะตะณะผะตะฝัะฐะผะธ** (1-2 ะดะฝั)
2. โ **JWT-ะฐะฒัะพัะธะทะฐัะธั ะดะปั WebSocket** (2-3 ะดะฝั)
3. โ **ะะฐะทะพะฒัะต ะผะตััะธะบะธ WS-ัะตัะฒะตัะฐ** (1 ะดะตะฝั)

**ะัะพะณะพ:** ~1 ะฝะตะดะตะปั ัะฐะฑะพัั

### ๐ก ะะฐะถะฝะพ (ัะปะตะดัััะธะต 2-4 ะฝะตะดะตะปะธ)

4. โ **ะะตัะตัะพะด ะฝะฐ "1 ััะฐะฝัะบัะธะฟัะธั ะฝะฐ ัะตััะธั"** (3-4 ะฝะตะดะตะปะธ)
   - ะะฐัะฐัั ั client-side "designated host" (ะฟัะพัะต)
   - ะะพัะพะผ ะผะธะณัะธัะพะฒะฐัั ะฝะฐ server-side ะผะธะบั

### ๐ข ะะตะปะฐัะตะปัะฝะพ (ะบะพะณะดะฐ ะฑัะดะตั 500+ ะฟะพะปัะทะพะฒะฐัะตะปะตะน)

5. โ **ะะพัะธะทะพะฝัะฐะปัะฝะพะต ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธะต** (2-3 ะฝะตะดะตะปะธ)
6. โ **ะัะตัะตะดั ะดะปั ะทะฐะฟะธัะธ ััะฐะฝัะบัะธะฟัะพะฒ** (1-2 ะฝะตะดะตะปะธ)

---

## ะัะตะฝะบะฐ ัััะตะบัะฐ ะผะธะณัะฐัะธะธ

### ะะพ ะผะธะณัะฐัะธะธ (ัะตะบััะตะต ัะพััะพัะฝะธะต)

**ะัะธ 1000 ะฟะพะปัะทะพะฒะฐัะตะปัั:**
- 1000 WebSocket ะบะพะฝะฝะตะบัะพะฒ ะบ WS-ัะตัะฒะตัั
- 1000 Gladia ัะตััะธะน (ััะพะธะผะพััั: ~$X/ะผะธะฝััะฐ ร 1000)
- ~100-200 ะทะฐะฟัะพัะพะฒ/ัะตะบ ะฒ ะะ (partial + final)
- ะะดะธะฝ WS-ัะตัะฒะตั ะธะฝััะฐะฝั (ัะธัะบ single point of failure)

### ะะพัะปะต ะญัะฐะฟะฐ 1 (ะบัะธัะธัะตัะบะธะต ัะธะบัั)

**ะัะธ 1000 ะฟะพะปัะทะพะฒะฐัะตะปัั:**
- 1000 WebSocket ะบะพะฝะฝะตะบัะพะฒ (ะฑะตะท ะธะทะผะตะฝะตะฝะธะน)
- 1000 Gladia ัะตััะธะน (ะฑะตะท ะธะทะผะตะฝะตะฝะธะน)
- **~1-2 ะทะฐะฟัะพัะฐ/ัะตะบ ะฒ ะะ** (ัะพะปัะบะพ final) โ **ัะปัััะตะฝะธะต ะฒ 50-100 ัะฐะท**
- **Security hole ะทะฐะบัััะฐ** โ ะบัะธัะธัะฝะพ

### ะะพัะปะต ะญัะฐะฟะฐ 2 (1 ััะฐะฝัะบัะธะฟัะธั ะฝะฐ ัะตััะธั)

**ะัะธ 1000 ะฟะพะปัะทะพะฒะฐัะตะปัั (100 ัะตััะธะน ร 10 ััะฐััะฝะธะบะพะฒ):**
- **100 WebSocket ะบะพะฝะฝะตะบัะพะฒ** (1 ะฝะฐ ัะตััะธั) โ **ัะปัััะตะฝะธะต ะฒ 10 ัะฐะท**
- **100 Gladia ัะตััะธะน** โ **ัะฝะธะถะตะฝะธะต ััะพะธะผะพััะธ ะฒ 10 ัะฐะท**
- ~1-2 ะทะฐะฟัะพัะฐ/ัะตะบ ะฒ ะะ (ะฑะตะท ะธะทะผะตะฝะตะฝะธะน)
- ะะตะฝััะต ะฝะฐะณััะทะบะธ ะฝะฐ ะบะปะธะตะฝั

---

## ะงะตะบ-ะปะธัั ะดะปั MVP โ Production

- [ ] **ะญัะฐะฟ 1.1:** ะะฐะฟะธัั ะฒ ะะ ัะพะปัะบะพ final ัะตะณะผะตะฝัะพะฒ
- [ ] **ะญัะฐะฟ 1.2:** JWT-ะฐะฒัะพัะธะทะฐัะธั ะดะปั WebSocket
- [ ] **ะญัะฐะฟ 1.3:** ะะฐะทะพะฒัะต ะผะตััะธะบะธ WS-ัะตัะฒะตัะฐ
- [ ] **ะญัะฐะฟ 2:** ะะตัะตัะพะด ะฝะฐ "1 ััะฐะฝัะบัะธะฟัะธั ะฝะฐ ัะตััะธั"
- [ ] ะะฐะณััะทะพัะฝะพะต ัะตััะธัะพะฒะฐะฝะธะต (k6/Artillery: 100 ัะตััะธะน ร 5 ััะฐััะฝะธะบะพะฒ)
- [ ] ะะพะฝะธัะพัะธะฝะณ (Prometheus + Grafana ะธะปะธ ะฐะฝะฐะปะพะณะธ)
- [ ] Alerting (ะพัะธะฑะบะธ, ะฒััะพะบะฐั ะฝะฐะณััะทะบะฐ)
- [ ] ะะพะบัะผะตะฝัะฐัะธั ะดะปั ะดะตะฟะปะพั

---

## ะะพะฟะพะปะฝะธัะตะปัะฝัะต ัะตะบะพะผะตะฝะดะฐัะธะธ

### 1. Connection pooling ะดะปั Prisma

**ะัะพะฑะปะตะผะฐ:** WS-ัะตัะฒะตั ะผะพะถะตั ัะพะทะดะฐะฒะฐัั ะผะฝะพะณะพ Prisma-ะบะปะธะตะฝัะพะฒ

**ะะตัะตะฝะธะต:**
```typescript
// ะัะฟะพะปัะทะพะฒะฐัั Prisma Data Proxy ะธะปะธ connection pooler (PgBouncer)
// ะ Neon ะตััั ะฒัััะพะตะฝะฝัะน connection pooling
```

### 2. Rate limiting ะฝะฐ WS-ัะตัะฒะตัะต

**ะะพะฑะฐะฒะธัั:**
- ะะณัะฐะฝะธัะตะฝะธะต ัะฐะทะผะตัะฐ ัะพะพะฑัะตะฝะธั (ะผะฐะบั. ัะฐะทะผะตั audio chunk)
- Rate limit ะฟะพ ะบะพะปะธัะตััะฒั ัะพะพะฑัะตะฝะธะน ะฒ ัะตะบัะฝะดั ะพั ะพะดะฝะพะณะพ ะบะปะธะตะฝัะฐ
- ะะฒัะพะผะฐัะธัะตัะบะพะต ะพัะบะปััะตะฝะธะต ะบะปะธะตะฝัะพะฒ, ะฝะฐัััะฐััะธั ะปะธะผะธัั

### 3. Health checks

**ะะพะฑะฐะฒะธัั:**
- `/health` endpoint ะดะปั WS-ัะตัะฒะตัะฐ
- ะัะพะฒะตัะบะฐ ะฟะพะดะบะปััะตะฝะธั ะบ Gladia
- ะัะพะฒะตัะบะฐ ะฟะพะดะบะปััะตะฝะธั ะบ ะะ

---

## ะะฐะบะปััะตะฝะธะต

**ะขะตะบััะฐั ะฐััะธัะตะบัััะฐ ะบะพะดะฐ** โ ะพัะปะธัะฝะฐั ะพัะฝะพะฒะฐ ะดะปั ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธั.

**ะะปะฐะฒะฝัะต ัะธัะบะธ:**
1. ะะพะดะตะปั ััะฐะฝัะบัะธะฟัะธะธ (1 ะฟะพัะพะบ ะฝะฐ ััะฐััะฝะธะบะฐ ะฒะผะตััะพ 1 ะฝะฐ ัะตััะธั)
2. ะะฐะฟะธัั ะฒัะตั partial-ะพะฒ ะฒ ะะ
3. ะััััััะฒะธะต ะฐะฒัะพัะธะทะฐัะธะธ ะดะปั WebSocket

**ะะตัะตะฝะธะต:**
- **ะญัะฐะฟ 1** (1 ะฝะตะดะตะปั) โ ัะฑัะฐัั ะบัะธัะธัะตัะบะธะต ะฑะปะพะบะตัั
- **ะญัะฐะฟ 2** (3-4 ะฝะตะดะตะปะธ) โ ะฟะตัะตะพัะผััะปะธัั ะผะพะดะตะปั ััะฐะฝัะบัะธะฟัะธะธ
- **ะญัะฐะฟ 3** (ะฟะพ ะฝะตะพะฑัะพะดะธะผะพััะธ) โ ะธะฝััะฐััััะบัััะฝะพะต ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธะต

**ะะพัะปะต ะฒัะฟะพะปะฝะตะฝะธั ะญัะฐะฟะฐ 1 + 2:**
- ะกะธััะตะผะฐ ะณะพัะพะฒะฐ ะบ 500-1000 ะพะฝะปะฐะนะฝะฐ
- ะกัะพะธะผะพััั Gladia ัะฝะธะถะตะฝะฐ ะฒ 10 ัะฐะท
- ะะ ะฝะฐะณััะทะบะฐ ัะฝะธะถะตะฝะฐ ะฒ 50-100 ัะฐะท
- Security hole ะทะฐะบัััะฐ

---

*ะะพะบัะผะตะฝั ัะพะทะดะฐะฝ: 2025-01-30*

