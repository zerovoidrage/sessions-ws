# План реализации серверной транскрипции

## Текущая ситуация

**Что работает сейчас:**
- Каждый участник транскрибирует свой собственный голос на клиенте
- Транскрипты отправляются через LiveKit data channel для всех участников
- Транскрипты сохраняются в БД (только финальные сегменты)
- Все участники видят транскрипты всех других участников

**Что нужно для серверной транскрипции:**
- Сервер подключается к LiveKit room как "bot" subscriber
- Сервер получает аудио-потоки всех участников
- Сервер миксит аудио и отправляет в Gladia (1 WebSocket на комнату вместо N)
- Сервер отправляет транскрипты клиентам через LiveKit data channel

## Проблема: WebRTC в Node.js

LiveKit Client SDK (`livekit-client`) использует WebRTC API, которые доступны только в браузере. Для работы в Node.js нужны:

1. **`node-webrtc`** - порт WebRTC для Node.js
   - Установка: `npm install node-webrtc`
   - Требует компиляцию native модулей
   - Может быть проблематично на некоторых платформах

2. **Альтернативные подходы:**
   - LiveKit Egress API (запись аудио, не real-time)
   - Собственный WebSocket клиент для LiveKit протокола
   - Использование `livekit-server-sdk` с дополнительными библиотеками

## Варианты реализации

### Вариант 1: Использовать `node-webrtc` (рекомендуется)

**Шаги:**
1. Установить зависимости:
   ```bash
   npm install node-webrtc
   ```

2. Обновить `transcription-service.ts`:
   - Импортировать `livekit-client` (будет работать с `node-webrtc`)
   - Подключиться к комнате как bot
   - Получить аудио-треки всех участников
   - Использовать Web Audio API (доступно через `node-webrtc`)

3. Реализовать микширование аудио:
   - Создать AudioContext для каждого участника
   - Миксить потоки в один
   - Отправлять в Gladia

**Плюсы:**
- Полная совместимость с существующим кодом
- Real-time транскрипция
- Использует существующие компоненты (gladia-bridge, appendTranscriptChunk)

**Минусы:**
- Требует компиляцию native модулей
- Может быть проблематично на некоторых серверах
- Дополнительная нагрузка на сервер

### Вариант 2: LiveKit Egress API (проще, но не real-time)

**Шаги:**
1. Использовать LiveKit Server SDK для запуска Egress
2. Записывать аудио комнаты в файл
3. Отправлять файл в Gladia для транскрипции (через REST API)
4. Получать транскрипт и отправлять клиентам

**Плюсы:**
- Проще реализовать
- Не требует WebRTC в Node.js
- Использует стандартные API

**Минусы:**
- Не real-time (задержка от записи до транскрипта)
- Требует LiveKit Egress (может быть платно)
- Сложнее обрабатывать частичные транскрипты

### Вариант 3: Гибридный подход (рекомендуется для MVP)

**Текущая реализация остается:**
- Клиенты транскрибируют себя
- Транскрипты отправляются через data channel
- Все работает в real-time

**Дополнительно:**
- Добавить серверную транскрипцию как опциональную функцию
- Использовать для комнат, где нужна централизованная транскрипция
- Постепенно мигрировать при необходимости

**Плюсы:**
- Работает уже сейчас
- Не требует дополнительной инфраструктуры
- Масштабируется (каждый участник транскрибирует себя)

**Минусы:**
- N WebSocket коннектов к Gladia (вместо 1)
- Зависит от клиентского железа

## Рекомендуемый путь для production

**Этап 1 (сейчас):**
- Оставить клиентскую транскрипцию (работает для всех участников)
- Документировать архитектуру

**Этап 2 (будущее):**
- Установить `node-webrtc` на production сервер
- Реализовать полную серверную транскрипцию через `TranscriptionService`
- Сделать опциональным (можно включать/выключать на уровне сессии)

**Этап 3 (масштабирование):**
- При необходимости (100+ комнат) перейти на серверную транскрипцию
- Использовать отдельный сервис/воркер для transcription-service
- Мониторить нагрузку и оптимизировать

## Структура файлов (уже создана)

```
ws/server/
  transcription-service.ts      # Базовая структура (требует доработки)
  
src/modules/core/sessions/api/
  startTranscriptionServiceEndpoint.ts  # API для запуска сервиса
  
src/app/api/sessions/[slug]/transcription/
  start/route.ts                # HTTP endpoint
```

## Что нужно для полной реализации

1. **Установить зависимости:**
   ```bash
   npm install node-webrtc
   npm install @types/node-webrtc --save-dev
   ```

2. **Обновить `transcription-service.ts`:**
   - Раскомментировать и реализовать подключение к LiveKit room
   - Реализовать получение аудио-треков
   - Реализовать микширование
   - Реализовать отправку в Gladia

3. **Протестировать:**
   - Подключение к комнате
   - Получение аудио
   - Транскрипцию
   - Отправку транскриптов клиентам

4. **Оптимизировать:**
   - Обработку ошибок
   - Переподключение при сбоях
   - Мониторинг и метрики

## Вывод

**Для MVP:** Текущая клиентская реализация работает хорошо и масштабируется. Каждый участник транскрибирует себя, все видят транскрипты всех.

**Для production при 100+ комнатах:** Нужна серверная транскрипция через `node-webrtc` или альтернативный подход. Это требует дополнительной настройки и тестирования.

