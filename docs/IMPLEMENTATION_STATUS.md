# –°—Ç–∞—Ç—É—Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

### 1. –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ Opus ‚Üí PCM16 (–ö—Ä–∏—Ç–∏—á–Ω–æ) ‚úÖ

**–°—Ç–∞—Ç—É—Å:** –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω `@discordjs/opus`
- ‚úÖ –°–æ–∑–¥–∞–Ω –∫–ª–∞—Å—Å `AudioDecoder` (`ws/server/audio-decoder.ts`)
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `handleEgressAudioData`
- ‚úÖ –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ Opus ‚Üí PCM16 16kHz –º–æ–Ω–æ –¥–ª—è Gladia

**–§–∞–π–ª—ã:**
- `ws/server/audio-decoder.ts` - –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
- `ws/server/livekit-egress-transcriber.ts` - –æ–±–Ω–æ–≤–ª—ë–Ω –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–µ–∫–æ–¥–µ—Ä–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- Gladia —Ç–µ–ø–µ—Ä—å –ø–æ–ª—É—á–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (PCM16 16kHz)
- –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å Retry –ª–æ–≥–∏–∫–æ–π ‚úÖ

**–°—Ç–∞—Ç—É—Å:** –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- ‚úÖ Retry –ª–æ–≥–∏–∫–∞ –ø—Ä–∏ —Å–±–æ—è—Ö Egress (–¥–æ 3 –ø–æ–ø—ã—Ç–æ–∫)
- ‚úÖ –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ (1s, 2s, 3s)
- ‚úÖ –†–∞–∑–ª–∏—á–µ–Ω–∏–µ retryable –∏ non-retryable –æ—à–∏–±–æ–∫
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–æ–≤

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```typescript
// Retry –¥–æ 3 —Ä–∞–∑ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
// –†–∞–∑–ª–∏—á–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –ª–∏–º–∏—Ç–æ–≤ (–Ω–µ retry) –∏ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫ (retry)
// Graceful degradation —á–µ—Ä–µ–∑ fallback –º–µ—Ö–∞–Ω–∏–∑–º
```

### 3. Graceful Degradation ‚úÖ

**–°—Ç–∞—Ç—É—Å:** –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (–±–∞–∑–æ–≤–∞—è –≤–µ—Ä—Å–∏—è)

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- ‚úÖ Fallback –º–µ—Ö–∞–Ω–∏–∑–º –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö Egress
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- ‚úÖ –°—á—ë—Ç—á–∏–∫ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –æ—à–∏–±–æ–∫

**TODO:**
- ‚ö†Ô∏è –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π fallback —á–µ—Ä–µ–∑ livekit-client (–ø–æ–∫–∞ —Ç–æ–ª—å–∫–æ –∑–∞–≥–ª—É—à–∫–∞)

### 4. –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ WebSocket –æ—à–∏–±–æ–∫ ‚úÖ

**–°—Ç–∞—Ç—É—Å:** –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–æ–≤ –∑–∞–∫—Ä—ã—Ç–∏—è WebSocket
- ‚úÖ –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø—Ä–∏ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏

## ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### Fallback —á–µ—Ä–µ–∑ livekit-client

**–°—Ç–∞—Ç—É—Å:** –ó–∞–≥–ª—É—à–∫–∞ (TODO)

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- ‚úÖ –ú–µ—Ç–æ–¥ `fallbackToClientTranscription` —Å–æ–∑–¥–∞–Ω
- ‚úÖ –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö Egress

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**
- ‚ö†Ô∏è –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π fallback —á–µ—Ä–µ–∑ `livekit-transcriber.ts`
- ‚ö†Ô∏è –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º

## üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ Opus
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ Egress –ø–æ—Ç–æ–∫–∞–º–∏
3. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ Gladia –ø–æ–ª—É—á–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –£–ª—É—á—à–µ–Ω–∏—è
1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π fallback —á–µ—Ä–µ–∑ livekit-client
2. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
3. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
1. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å Room Composite –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
2. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–∏–∫—à–∏—Ä–æ–≤–∞–Ω–∏–µ
3. –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

## üìä –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
LiveKit Room
    ‚Üì
Track Egress (–¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç—Ä–µ–∫–∞)
    ‚Üì
WebSocket ‚Üí –ù–∞—à —Å–µ—Ä–≤–µ—Ä
    ‚Üì
AudioDecoder (Opus ‚Üí PCM16) ‚úÖ
    ‚Üì
AudioProcessor (–º–∏–∫—à–∏—Ä–æ–≤–∞–Ω–∏–µ)
    ‚Üì
Gladia API ‚úÖ
    ‚Üì
LiveKit Data Channel (–ø—É–±–ª–∏–∫–∞—Ü–∏—è)
```

## ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã:
- ‚úÖ –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ Opus
- ‚úÖ Retry –ª–æ–≥–∏–∫–∞
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ Graceful degradation (–±–∞–∑–æ–≤–∞—è)

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ Egress –ø–æ—Ç–æ–∫–∞–º–∏.

