# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º: OAuth –∏ WebSocket

## üîç –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ OAuth Redirect

### –ü—Ä–æ–±–ª–µ–º–∞: –ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Google –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

**–ü—Ä–∏—á–∏–Ω—ã:**

1. **NEXTAUTH_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π**
   - ‚úÖ –î–æ–ª–∂–µ–Ω –±—ã—Ç—å: `https://www.4sessions.space` (–ë–ï–ó —Å–ª–µ—à–∞ –≤ –∫–æ–Ω—Ü–µ)
   - ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: `https://www.4sessions.space/`
   - ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤–æ–æ–±—â–µ

2. **Google Cloud Console - Redirect URI**
   - ‚úÖ –î–æ–ª–∂–µ–Ω –±—ã—Ç—å: `https://www.4sessions.space/api/auth/callback/google`
   - ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: `https://www.4sessions.space/auth/callback/google` (–±–µ–∑ `/api/`)

3. **Google Cloud Console - Authorized JavaScript origins**
   - ‚úÖ –î–æ–ª–∂–µ–Ω –±—ã—Ç—å: `https://www.4sessions.space`
   - ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: `http://www.4sessions.space` (HTTP –≤–º–µ—Å—Ç–æ HTTPS)

4. **Cookies –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ DevTools ‚Üí Application ‚Üí Cookies
   - –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å cookie: `__Secure-next-auth.session-token` –∏–ª–∏ `next-auth.session-token`

### –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

```bash
# –í –±—Ä–∞—É–∑–µ—Ä–µ –ø–æ—Å–ª–µ –ø–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Google
# DevTools ‚Üí Console ‚Üí –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—à–∏–±–∫–∏
# DevTools ‚Üí Application ‚Üí Cookies ‚Üí –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ cookies
```

### –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ Vercel:

1. ‚úÖ `NEXTAUTH_SECRET` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
2. ‚úÖ `NEXTAUTH_URL` = `https://www.4sessions.space` (–ë–ï–ó —Å–ª–µ—à–∞!)
3. ‚úÖ `GOOGLE_CLIENT_ID` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
4. ‚úÖ `GOOGLE_CLIENT_SECRET` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

### –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ Google Cloud Console:

1. APIs & Services ‚Üí Credentials ‚Üí OAuth 2.0 Client IDs
2. Authorized JavaScript origins:
   ```
   https://www.4sessions.space
   ```
3. Authorized redirect URIs:
   ```
   https://www.4sessions.space/api/auth/callback/google
   ```

---

## üîç –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ WebSocket

### –ü—Ä–æ–±–ª–µ–º–∞: Mixed Content –∏–ª–∏ WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è

**–¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
- `NEXT_PUBLIC_WS_HOST` = `sessions-ws.onrender.com` ‚úÖ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ, –±–µ–∑ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞)
- –ü–æ—Ä—Ç —É–¥–∞–ª–µ–Ω ‚úÖ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–ª—è production)

**–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å:**

1. –ö–æ–¥ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —á—Ç–æ –º—ã –≤ production (HTTPS)
2. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª `wss://`
3. –§–æ—Ä–º–∏—Ä—É–µ—Ç URL: `wss://sessions-ws.onrender.com/api/realtime/transcribe?token=...`
4. –ù–µ –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–æ—Ä—Ç (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π 443)

**–ù–æ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º–∞!**

Render –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ—Ä—Ç –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `PORT` (–æ–±—ã—á–Ω–æ —ç—Ç–æ 10000), –Ω–æ –±—Ä–∞—É–∑–µ—Ä –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É –ø–æ—Ä—Ç—É 443.

**–†–µ—à–µ–Ω–∏—è:**

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Render –ø–æ—Ä—Ç —è–≤–Ω–æ

–í Vercel –¥–æ–±–∞–≤—å—Ç–µ:
```
NEXT_PUBLIC_WS_PORT=10000
```

–ù–æ —ç—Ç–æ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ Render —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 10000 –ø–æ HTTPS/WSS.

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Render –¥–æ–º–µ–Ω —Å –ø–æ—Ä—Ç–æ–º (–µ—Å–ª–∏ Render –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç)

Render –æ–±—ã—á–Ω–æ –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç WSS –Ω–∞ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º –ø–æ—Ä—Ç—É. –ù—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π 443.

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∫–∞–∫–æ–π –ø–æ—Ä—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Render

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Render - –Ω–∞ –∫–∞–∫–æ–º –ø–æ—Ä—Ç—É —Å–ª—É—à–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä
2. –ï—Å–ª–∏ –ø–æ—Ä—Ç 10000, —Ç–æ –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –µ–≥–æ —è–≤–Ω–æ

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞:**

–ù—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É, —á—Ç–æ–±—ã –≤ production —Ç–æ–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ—Ä—Ç, –µ—Å–ª–∏ –æ–Ω —É–∫–∞–∑–∞–Ω:

```typescript
// –î–ª—è WSS –≤ production –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Ä—Ç –∏–∑ NEXT_PUBLIC_WS_PORT, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω
const wsPort = process.env.NEXT_PUBLIC_WS_PORT || (isProduction ? '' : '3001')
const portSuffix = wsPort ? `:${wsPort}` : ''
```

---

## üîç –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT —Ç–æ–∫–µ–Ω–∞

**JWT —Ç–æ–∫–µ–Ω:** `99b38577b08830fce2493607c263559b36696308fca91e01d3c3058cc3634d30`

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ Vercel:
- ‚úÖ `TRANSCRIPTION_JWT_SECRET` = `99b38577b08830fce2493607c263559b36696308fca91e01d3c3058cc3634d30`

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ Render:
- ‚úÖ `TRANSCRIPTION_JWT_SECRET` = `99b38577b08830fce2493607c263559b36696308fca91e01d3c3058cc3634d30`

–û–Ω–∏ –¥–æ–ª–∂–Ω—ã **–ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–ø–∞–¥–∞—Ç—å**!

---

## üîß –ë—ã—Å—Ç—Ä–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (DevTools ‚Üí Console):

–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –æ—à–∏–±–∫–∏ —Ç–∏–ø–∞:
- `Mixed Content: The page was loaded over HTTPS, but attempted to connect to the insecure WebSocket endpoint...`
  ‚Üí –ü—Ä–æ–±–ª–µ–º–∞: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `ws://` –≤–º–µ—Å—Ç–æ `wss://`
  
- `WebSocket connection failed`
  ‚Üí –ü—Ä–æ–±–ª–µ–º–∞: —Å–µ—Ä–≤–µ—Ä –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL

### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Network tab (DevTools ‚Üí Network ‚Üí WS):

–°–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:
- URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å: `wss://sessions-ws.onrender.com:10000/api/realtime/transcribe?token=...`
- Status –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å: `101 Switching Protocols`

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ cookies –ø–æ—Å–ª–µ OAuth:

–ü–æ—Å–ª–µ –ø–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Google:
- DevTools ‚Üí Application ‚Üí Cookies
- –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å cookie: `next-auth.session-token` –∏–ª–∏ `__Secure-next-auth.session-token`
- –ï—Å–ª–∏ –Ω–µ—Ç - –ø—Ä–æ–±–ª–µ–º–∞ —Å cookies –∏–ª–∏ —Å–µ—Å—Å–∏–µ–π

---

## üêõ –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

### –û—à–∏–±–∫–∞ 1: "Mixed Content"

**–ü—Ä–∏—á–∏–Ω–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `ws://` –≤–º–µ—Å—Ç–æ `wss://`

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ:
1. `NEXT_PUBLIC_WS_HOST` –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç `https://`
2. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ HTTPS
3. –ö–æ–¥ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç production

### –û—à–∏–±–∫–∞ 2: WebSocket connection timeout

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—Ç –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω

**–†–µ—à–µ–Ω–∏–µ:** 
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ Render —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç: `https://sessions-ws.onrender.com/health`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Render –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ—Ä—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π

### –û—à–∏–±–∫–∞ 3: OAuth redirect loop

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `NEXTAUTH_URL` –∏–ª–∏ Google Cloud Console

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `NEXTAUTH_URL` –≤ Vercel (–ë–ï–ó —Å–ª–µ—à–∞!)
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Google Cloud Console redirect URI
3. –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç –Ω–∞ Vercel –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

---

## üìù –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

- [ ] –í Vercel: `NEXTAUTH_URL` = `https://www.4sessions.space` (–±–µ–∑ —Å–ª–µ—à–∞)
- [ ] –í Vercel: `TRANSCRIPTION_JWT_SECRET` = `99b38577b08830fce2493607c263559b36696308fca91e01d3c3058cc3634d30`
- [ ] –í Render: `TRANSCRIPTION_JWT_SECRET` = `99b38577b08830fce2493607c263559b36696308fca91e01d3c3058cc3634d30`
- [ ] –í Vercel: `NEXT_PUBLIC_WS_HOST` = `sessions-ws.onrender.com` (–±–µ–∑ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞)
- [ ] –í Vercel: `NEXT_PUBLIC_WS_PORT` = `10000` (–µ—Å–ª–∏ Render –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ—Ä—Ç 10000)
- [ ] Google Cloud Console: Redirect URI = `https://www.4sessions.space/api/auth/callback/google`
- [ ] Google Cloud Console: Authorized origins = `https://www.4sessions.space`
- [ ] –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç –Ω–∞ Vercel –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- [ ] –û—á–∏—Å—Ç–∏—Ç—å cookies –±—Ä–∞—É–∑–µ—Ä–∞ –∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞

