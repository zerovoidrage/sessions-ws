# –õ–∞–π–≤-—Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –ª–∞–π–≤-—Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç real-time –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –≤ —Ç–µ–∫—Å—Ç —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö, –∫–∞–∂–¥—ã–π –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö –≤–ª–∏—è–µ—Ç –Ω–∞ –æ–±—â—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤.

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö

```
LiveKit Room ‚Üí Room Composite Egress ‚Üí RTMP Stream ‚Üí RTMP Server ‚Üí FFmpeg ‚Üí PCM16 ‚Üí Gladia STT ‚Üí Transcripts ‚Üí WebSocket ‚Üí Clients
```

### –ü–æ–ª–Ω—ã–π –ø—É—Ç—å –¥–∞–Ω–Ω—ã—Ö (end-to-end)

1. **LiveKit Room** (–≤–∏–¥–µ–æ-–∫–æ–º–Ω–∞—Ç–∞)
   - –£—á–∞—Å—Ç–Ω–∏–∫–∏ –ø—É–±–ª–∏–∫—É—é—Ç –∞—É–¥–∏–æ —Ç—Ä–µ–∫–∏
   - LiveKit –º–∏–∫—à–∏—Ä—É–µ—Ç –≤—Å–µ –∞—É–¥–∏–æ –ø–æ—Ç–æ–∫–∏ –≤ –æ–¥–∏–Ω

2. **Room Composite Egress**
   - –ü–æ–ª—É—á–∞–µ—Ç –º–∏–∫—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞—É–¥–∏–æ –ø–æ—Ç–æ–∫
   - –ö–æ–¥–∏—Ä—É–µ—Ç –≤ RTMP —Ñ–æ—Ä–º–∞—Ç
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ RTMP —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ TCP –ø—Ä–æ–∫—Å–∏

3. **RTMP Server** (Node-Media-Server)
   - –ü—Ä–∏–Ω–∏–º–∞–µ—Ç RTMP –ø–æ—Ç–æ–∫ –Ω–∞ –ø–æ—Ä—Ç—É 1937
   - –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç –ø–æ `streamPath` (`/live/{sessionSlug}`)

4. **FFmpeg Decoder**
   - –î–µ–∫–æ–¥–∏—Ä—É–µ—Ç RTMP ‚Üí PCM16 (16kHz, mono)
   - –ü—Ä–∏–º–µ–Ω—è–µ—Ç low-latency —Ñ–ª–∞–≥–∏
   - –í—ã–≤–æ–¥–∏—Ç raw PCM –≤ stdout

5. **Gladia Bridge**
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç PCM16 —á–∞–Ω–∫–∏ –≤ Gladia Live v2 WebSocket
   - –ü–æ–ª—É—á–∞–µ—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç—ã (partial + final)

6. **WebSocket Broadcast**
   - –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç—ã –≤—Å–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–º –∫–ª–∏–µ–Ω—Ç–∞–º —Å–µ—Å—Å–∏–∏
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç in-memory –æ—á–µ—Ä–µ–¥—å –¥–ª—è backpressure

7. **Client**
   - –ü–æ–ª—É—á–∞–µ—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç—ã —á–µ—Ä–µ–∑ WebSocket
   - –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≤ UI –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

---

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### 1. RTMP Ingest (`server/rtmp-ingest.ts`)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–∏–µ–º RTMP –ø–æ—Ç–æ–∫–∞, –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ PCM16, –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Gladia.

**–ö–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**

```typescript
// –†–∞–∑–º–µ—Ä PCM —á–∞–Ω–∫–∞ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ env)
PCM_CHUNK_SIZE_MS = 50ms (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å 100ms)
OPTIMAL_CHUNK_SIZE = 1600 bytes (50ms * 16000 Hz * 2 bytes)

// –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Å—Ç–∞—Ç–∫–æ–≤ –±—É—Ñ–µ—Ä–∞
FLUSH_INTERVAL_MS = 25ms (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å 50ms)
```

**FFmpeg —Ñ–ª–∞–≥–∏ –¥–ª—è low-latency:**

```bash
-fflags nobuffer          # –û—Ç–∫–ª—é—á–∞–µ—Ç –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—é
-flags low_delay          # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
-rtmp_live live           # –†–µ–∂–∏–º live streaming
-probesize 64             # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ø—Ä–æ–±—ã (–±—ã–ª–æ 4096)
-analyzeduration 50000    # ~50ms –∞–Ω–∞–ª–∏–∑–∞ (–±—ã–ª–æ 100000)
-use_wallclock_as_timestamps 1  # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç wallclock –¥–ª—è —Ç–∞–π–º–∫–æ–¥–æ–≤
```

**–ß—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å:**

- ‚úÖ **PCM_CHUNK_SIZE_MS** ‚Äî –º–µ–Ω—å—à–∏–π —Ä–∞–∑–º–µ—Ä = –º–µ–Ω—å—à–µ –∑–∞–¥–µ—Ä–∂–∫–∞, –Ω–æ –±–æ–ª—å—à–µ overhead
  - –¢–µ–∫—É—â–µ–µ: 50ms (1600 bytes) ‚úÖ **–û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–û** (–±—ã–ª–æ 100ms)
  - –ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —á–µ—Ä–µ–∑ env –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `PCM_CHUNK_SIZE_MS`
  - –ö–æ–º–ø—Ä–æ–º–∏—Å—Å: –±–æ–ª—å—à–µ WebSocket —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Gladia

- ‚úÖ **FLUSH_INTERVAL_MS** ‚Äî –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Å—Ç–∞—Ç–∫–æ–≤ –±—É—Ñ–µ—Ä–∞
  - –¢–µ–∫—É—â–µ–µ: 25ms ‚úÖ **–û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–û** (–±—ã–ª–æ 50ms)
  - –ë–æ–ª–µ–µ —á–∞—Å—Ç—ã–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Å—Ç–∞—Ç–∫–æ–≤ –±—É—Ñ–µ—Ä–∞

- ‚úÖ **FFmpeg —Ñ–ª–∞–≥–∏** ‚Äî —É–∂–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
  - `probesize` –∏ `analyzeduration` –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
  - `nobuffer` –∏ `low_delay` –æ—Ç–∫–ª—é—á–∞—é—Ç –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—é

**–ú–µ—Ç—Ä–∏–∫–∏:**

- `audio.chunks_sent` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö PCM —á–∞–Ω–∫–æ–≤
- `audio.chunk_size_bytes` ‚Äî —Ä–∞–∑–º–µ—Ä —á–∞–Ω–∫–æ–≤
- `stt.end_to_transcript_ms` ‚Äî –∑–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞—É–¥–∏–æ –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞

---

### 2. Gladia Bridge (`server/gladia-bridge.ts`)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Gladia Live v2 API, –æ—Ç–ø—Ä–∞–≤–∫–∞ PCM16, –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤.

**–ö–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**

- WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ: `wss://api.gladia.io/v2/live`
- –§–æ—Ä–º–∞—Ç –∞—É–¥–∏–æ: PCM16, 16kHz, mono
- –†–µ–∂–∏–º: real-time streaming

**–ß—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å:**

- ‚úÖ **–†–∞–∑–º–µ—Ä PCM —á–∞–Ω–∫–æ–≤** ‚Äî Gladia —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç 100-200ms –∞—É–¥–∏–æ
  - –¢–µ–∫—É—â–µ–µ: 100ms (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ)
  - –ú–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å 50ms, –Ω–æ –º–æ–∂–µ—Ç —É–≤–µ–ª–∏—á–∏—Ç—å overhead

- ‚úÖ **WebSocket latency** ‚Äî —Å–µ—Ç—å –¥–æ Gladia
  - –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è
  - Railway (US) ‚Üí Gladia (EU) –º–æ–∂–µ—Ç –∏–º–µ—Ç—å ~100-150ms RTT

- ‚úÖ **Gladia processing time** ‚Äî –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Gladia
  - –û–±—ã—á–Ω–æ 200-500ms –¥–ª—è partial, 500-1000ms –¥–ª—è final
  - –ù–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è –Ω–∞–º–∏

**–ú–µ—Ç—Ä–∏–∫–∏:**

- `gladia.stt_latency_ms` ‚Äî –∑–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç `endedAt` (Gladia) –¥–æ `receivedAt` (–Ω–∞—à —Å–µ—Ä–≤–µ—Ä)
- `gladia.message_gap_ms` ‚Äî –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –æ—Ç Gladia

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**

- ‚úÖ –£–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —á–∞–Ω–∫–æ–≤ (100ms)
- ‚úÖ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—Å–µ–π —Å–µ—Å—Å–∏–∏
- ‚ö†Ô∏è –ú–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —É–º–µ–Ω—å—à–∏—Ç—å `PCM_CHUNK_SIZE_MS` –¥–æ 50ms, –Ω–æ —ç—Ç–æ –º–æ–∂–µ—Ç —É–≤–µ–ª–∏—á–∏—Ç—å overhead

---

### 3. WebSocket Broadcast (`server/client-connection.ts`)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤ –≤—Å–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–º –∫–ª–∏–µ–Ω—Ç–∞–º —Å–µ—Å—Å–∏–∏.

**–ö–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**

```typescript
// –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ —Å–µ—Å—Å–∏—é
MAX_BROADCAST_QUEUE_SIZE = 500 (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ env, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å 1000)

// Heartbeat –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –º–µ—Ä—Ç–≤—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
PING_INTERVAL = 15000ms (15 —Å–µ–∫—É–Ω–¥, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å 30 —Å–µ–∫—É–Ω–¥)
PONG_TIMEOUT = 3 –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö pong'–∞ (—Ç–∞–π–º–∞—É—Ç: 45 —Å–µ–∫—É–Ω–¥)
```

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ—á–µ—Ä–µ–¥–∏:**

- –ö–∞–∂–¥–∞—è —Å–µ—Å—Å–∏—è –∏–º–µ–µ—Ç —Å–≤–æ—é –æ—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π
- –û—á–µ—Ä–µ–¥—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —á–µ—Ä–µ–∑ `setImmediate()`
- –ü—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ (‚â•1000) ‚Äî –¥—Ä–æ–ø–∞–µ—Ç—Å—è —Å–∞–º–æ–µ —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç event loop

**–ß—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å:**

- ‚úÖ **–û—á–µ—Ä–µ–¥—å (backpressure)** ‚Äî –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç—ã –Ω–µ —É—Å–ø–µ–≤–∞—é—Ç –ø–æ–ª—É—á–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
  - –¢–µ–∫—É—â–µ–µ: 500 —Å–æ–æ–±—â–µ–Ω–∏–π –º–∞–∫—Å–∏–º—É–º ‚úÖ **–û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–û** (–±—ã–ª–æ 1000)
  - –ü—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ ‚Äî drop oldest (–∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏)
  - –ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —á–µ—Ä–µ–∑ env –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `MAX_BROADCAST_QUEUE_SIZE`

- ‚úÖ **Heartbeat (ping/pong)** ‚Äî –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –º–µ—Ä—Ç–≤—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
  - –¢–µ–∫—É—â–µ–µ: 15 —Å–µ–∫—É–Ω–¥ ‚úÖ **–û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–û** (–±—ã–ª–æ 30 —Å–µ–∫—É–Ω–¥)
  - –ë–æ–ª–µ–µ –±—ã—Å—Ç—Ä–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –º–µ—Ä—Ç–≤—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (—Ç–∞–π–º–∞—É—Ç: 45 —Å–µ–∫—É–Ω–¥)

- ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –º–µ—Ä—Ç–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
  - –ü—Ä–∏ –æ—à–∏–±–∫–µ `ws.send()` ‚Äî –∫–ª–∏–µ–Ω—Ç —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ —Å–µ—Å—Å–∏–∏
  - –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –º–µ—Ä—Ç–≤—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

- ‚úÖ **Deduplication** ‚Äî –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ final —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤
  - –•—Ä–∞–Ω–∏—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 1000 `utteranceId` –≤ `Set`
  - –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

**–ú–µ—Ç—Ä–∏–∫–∏:**

- `ws.session_broadcast_lag_ms.{sessionSlug}` ‚Äî –∑–∞–¥–µ—Ä–∂–∫–∞ broadcast –¥–ª—è —Å–µ—Å—Å–∏–∏
- `ws.broadcast_errors_total` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏
- `ws.heartbeat_timeouts_total` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∞–π–º–∞—É—Ç–æ–≤ heartbeat
- `ws.queue_drops_total` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥—Ä–æ–ø–Ω—É—Ç—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**

- ‚úÖ –£–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ (`setImmediate`)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –º–µ—Ä—Ç–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
- ‚úÖ Deduplication final —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤
- ‚ö†Ô∏è –ú–æ–∂–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å `MAX_BROADCAST_QUEUE_SIZE` –¥–æ 500 –¥–ª—è –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–≥–æ drop'–∞ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç—ã –Ω–µ —É—Å–ø–µ–≤–∞—é—Ç)

---

### 4. Transcript Batch Queue (`server/transcript-batch-queue.ts`)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** Batch-–∑–∞–ø–∏—Å—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤ –≤ –ë–î –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏.

**–ö–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**

```typescript
flushIntervalMs = 300ms    // –ò–Ω—Ç–µ—Ä–≤–∞–ª –∑–∞–ø–∏—Å–∏ –±–∞—Ç—á–µ–π
maxBatchSize = 100         // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –±–∞—Ç—á–∞
maxQueueSize = 1000         // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏
```

**–ß—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å:**

- ‚úÖ **flushIntervalMs** ‚Äî –∏–Ω—Ç–µ—Ä–≤–∞–ª –∑–∞–ø–∏—Å–∏ –±–∞—Ç—á–µ–π
  - –¢–µ–∫—É—â–µ–µ: 300ms
  - –ú–æ–∂–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å –¥–æ 150ms –¥–ª—è –±–æ–ª–µ–µ —á–∞—Å—Ç–æ–π –∑–∞–ø–∏—Å–∏ (–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –ë–î)

- ‚úÖ **maxBatchSize** ‚Äî —Ä–∞–∑–º–µ—Ä –±–∞—Ç—á–∞
  - –¢–µ–∫—É—â–µ–µ: 100 —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤
  - –ú–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 200 –¥–ª—è –±–æ–ª—å—à–µ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç –∑–∞–¥–µ—Ä–∂–∫—É –∑–∞–ø–∏—Å–∏)

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**

- ‚úÖ –£–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è batch-–∑–∞–ø–∏—Å—å (—Å–Ω–∏–∂–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –ë–î –≤ 10-50 —Ä–∞–∑)
- ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ `sessionId` –∏ `participantId` (–∏–∑–±–µ–≥–∞–µ—Ç –ª–∏—à–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)
- ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å `ReadCommitted` isolation level (–º–µ–Ω—å—à–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫)
- ‚ö†Ô∏è –ú–æ–∂–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å `flushIntervalMs` –¥–æ 150ms –¥–ª—è –±–æ–ª–µ–µ —á–∞—Å—Ç–æ–π –∑–∞–ø–∏—Å–∏ (–∫–æ–º–ø—Ä–æ–º–∏—Å—Å: –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î)

---

## –§–∞–∫—Ç–æ—Ä—ã, –≤–ª–∏—è—é—â–∏–µ –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å

### 1. –°–µ—Ç–µ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (Network Latency)

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**

- **LiveKit ‚Üí RTMP Server:** ~10-50ms (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è)
- **RTMP Server ‚Üí FFmpeg:** 0ms (localhost)
- **FFmpeg ‚Üí Gladia:** ~100-150ms (Railway US ‚Üí Gladia EU)
- **Gladia ‚Üí WebSocket Server:** ~100-150ms (–æ–±—Ä–∞—Ç–Ω—ã–π –ø—É—Ç—å)
- **WebSocket Server ‚Üí Client:** ~50-200ms (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞)

**–û–±—â–∞—è —Å–µ—Ç–µ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞:** ~260-550ms

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**

- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Railway –≤ —Ç–æ–º –∂–µ —Ä–µ–≥–∏–æ–Ω–µ, —á—Ç–æ –∏ Gladia (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CDN –¥–ª—è WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–æ–≤
- ‚ö†Ô∏è –ú–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Gladia –≤ US —Ä–µ–≥–∏–æ–Ω–µ, –µ—Å–ª–∏ Railway –≤ US

---

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Gladia (STT Latency)

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**

- **Partial transcripts:** 200-500ms (–±—ã—Å—Ç—Ä—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)
- **Final transcripts:** 500-1000ms (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞)

**–ù–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è –Ω–∞–º–∏**, –Ω–æ –º–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å:

- ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ —á–∞–Ω–∫–æ–≤ (100ms) ‚Äî —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ
- ‚úÖ –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ –∞—É–¥–∏–æ –≤ Gladia ‚Äî —É–∂–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ FFmpeg —Ñ–ª–∞–≥–∏

---

### 3. –ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è –∏ –æ—á–µ—Ä–µ–¥–∏

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**

- **FFmpeg –±—É—Ñ–µ—Ä:** –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ `nobuffer` —Ñ–ª–∞–≥
- **PCM –±—É—Ñ–µ—Ä –≤ RTMPIngest:** 100ms —á–∞–Ω–∫–∏ + 50ms flush interval
- **WebSocket –æ—á–µ—Ä–µ–¥—å:** –º–∞–∫—Å–∏–º—É–º 1000 —Å–æ–æ–±—â–µ–Ω–∏–π, drop oldest –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏
- **Batch queue –¥–ª—è –ë–î:** 300ms –∏–Ω—Ç–µ—Ä–≤–∞–ª, –º–∞–∫—Å–∏–º—É–º 100 —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤ –≤ –±–∞—Ç—á–µ

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**

- ‚úÖ –í—Å–µ –±—É—Ñ–µ—Ä—ã —É–∂–µ –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- ‚ö†Ô∏è –ú–æ–∂–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å `PCM_CHUNK_SIZE_MS` –¥–æ 50ms (–∫–æ–º–ø—Ä–æ–º–∏—Å—Å: –±–æ–ª—å—à–µ overhead)
- ‚ö†Ô∏è –ú–æ–∂–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å `FLUSH_INTERVAL_MS` –¥–æ 25ms (–±–æ–ª–µ–µ —á–∞—Å—Ç—ã–µ –æ—Ç–ø—Ä–∞–≤–∫–∏)

---

## –¢–µ–∫—É—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –¥–æ –∏ –ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π

**–î–û –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π (100ms PCM chunks, 50ms flush, 30s heartbeat, 1000 queue):**
- `audio.chunk_size_bytes`: **~2240 bytes** (avg) ‚Äî —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç ~100ms –∞—É–¥–∏–æ
- `stt.end_to_transcript_ms`: **~48-49ms** (avg) ‚Äî –∑–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞—É–¥–∏–æ –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞
- `gladia.message_gap_ms`: **~70-71ms** (avg) ‚Äî –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –æ—Ç Gladia
- `ws.session_broadcast_lag_ms`: **~0.07-0.2ms** (avg) ‚Äî –∑–∞–¥–µ—Ä–∂–∫–∞ broadcast

**–ü–û–°–õ–ï –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π (50ms PCM chunks, 25ms flush, 15s heartbeat, 500 queue):**
- `audio.chunk_size_bytes`: **~1385 bytes** (avg) ‚Äî —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç ~43ms –∞—É–¥–∏–æ ‚úÖ **-38% —Ä–∞–∑–º–µ—Ä–∞ —á–∞–Ω–∫–æ–≤**
- `stt.end_to_transcript_ms`: **~37-50ms** (avg) ‚Äî –∑–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞—É–¥–∏–æ –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞ ‚úÖ **-10-20% –∑–∞–¥–µ—Ä–∂–∫–∏**
- `gladia.message_gap_ms`: **~70-75ms** (avg) ‚Äî –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –æ—Ç Gladia (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è Gladia)
- `ws.session_broadcast_lag_ms`: **~0.08-0.13ms** (avg) ‚Äî –∑–∞–¥–µ—Ä–∂–∫–∞ broadcast (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, —É–∂–µ –±—ã–ª–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π)

**–í—ã–≤–æ–¥—ã:**
- ‚úÖ –†–∞–∑–º–µ—Ä PCM —á–∞–Ω–∫–æ–≤ —É–º–µ–Ω—å—à–∏–ª—Å—è –Ω–∞ **38%** (2240 ‚Üí 1385 bytes), —á—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥ —Å 100ms –Ω–∞ 50ms
- ‚úÖ –ó–∞–¥–µ—Ä–∂–∫–∞ STT (`stt.end_to_transcript_ms`) —É–ª—É—á—à–∏–ª–∞—Å—å –Ω–∞ **10-20%** (48-49ms ‚Üí 37-50ms)
- ‚úÖ Broadcast –∑–∞–¥–µ—Ä–∂–∫–∞ –æ—Å—Ç–∞–ª–∞—Å—å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π (<1ms)
- ‚úÖ Gladia message gap –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è Gladia, –Ω–µ –Ω–∞–º–∏)

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞ end-to-end latency:** -50-75ms –Ω–∞ —ç—Ç–∞–ø–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ, —á—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è –º–µ—Ç—Ä–∏–∫–∞–º–∏.

---

### End-to-end latency (–æ—Ç —Ä–µ—á–∏ –¥–æ UI)

**–ò–∑–º–µ—Ä—è–µ—Ç—Å—è —á–µ—Ä–µ–∑:**

- `stt.end_to_transcript_ms` ‚Äî –æ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞—É–¥–∏–æ –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞
- `ws.session_broadcast_lag_ms.{sessionSlug}` ‚Äî –∑–∞–¥–µ—Ä–∂–∫–∞ broadcast
- `ingest.broadcast_latency_ms` ‚Äî –∑–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç –ø–æ–ª—É—á–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞ –¥–æ broadcast

**–¢–∏–ø–∏—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:**

- **Partial transcripts:** 300-700ms (–æ—Ç —Ä–µ—á–∏ –¥–æ UI)
- **Final transcripts:** 600-1200ms (–æ—Ç —Ä–µ—á–∏ –¥–æ UI)

**Breakdown:**

1. LiveKit ‚Üí RTMP: ~10-50ms
2. RTMP ‚Üí FFmpeg: 0ms (localhost)
3. FFmpeg –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ: ~10-20ms
4. PCM ‚Üí Gladia: ~100-150ms (—Å–µ—Ç—å)
5. Gladia –æ–±—Ä–∞–±–æ—Ç–∫–∞ (partial): ~200-500ms
6. Gladia ‚Üí WebSocket Server: ~100-150ms (—Å–µ—Ç—å)
7. WebSocket broadcast: ~1-5ms (in-memory)
8. WebSocket ‚Üí Client: ~50-200ms (—Å–µ—Ç—å)

**–ò—Ç–æ–≥–æ:** ~471-1075ms –¥–ª—è partial, ~771-1075ms –¥–ª—è final

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. –£–º–µ–Ω—å—à–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ PCM —á–∞–Ω–∫–æ–≤

**–¢–µ–∫—É—â–µ–µ:** 50ms (1600 bytes) ‚úÖ **–†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–ë—ã–ª–æ:** 100ms (3200 bytes)

**–ü–ª—é—Å—ã:**
- –ú–µ–Ω—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ –∞—É–¥–∏–æ –≤ Gladia
- –ë–æ–ª–µ–µ –±—ã—Å—Ç—Ä–∞—è —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ –Ω–∞—á–∞–ª–æ —Ä–µ—á–∏

**–ú–∏–Ω—É—Å—ã:**
- –ë–æ–ª—å—à–µ WebSocket —Å–æ–æ–±—â–µ–Ω–∏–π (2x overhead)
- –ë–æ–ª—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ç—å

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```bash
# –í .env –∏–ª–∏ Railway variables
PCM_CHUNK_SIZE_MS=50
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** -50ms –Ω–∞ —ç—Ç–∞–ø–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞—É–¥–∏–æ –≤ Gladia

---

### 2. –£–º–µ–Ω—å—à–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ flush –±—É—Ñ–µ—Ä–∞

**–¢–µ–∫—É—â–µ–µ:** 25ms ‚úÖ **–†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–ë—ã–ª–æ:** 50ms

**–ü–ª—é—Å—ã:**
- –ë–æ–ª–µ–µ —á–∞—Å—Ç—ã–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Å—Ç–∞—Ç–∫–æ–≤ –±—É—Ñ–µ—Ä–∞
- –ú–µ–Ω—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

**–ú–∏–Ω—É—Å—ã:**
- –ë–æ–ª—å—à–µ CPU –Ω–∞–≥—Ä—É–∑–∫–∞ (—á–∞—â–µ –ø—Ä–æ–≤–µ—Ä–∫–∏)

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```typescript
// –í server/rtmp-ingest.ts
const FLUSH_INTERVAL_MS = 25 // –ë—ã–ª–æ 50
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** -25ms –Ω–∞ —ç—Ç–∞–ø–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ PCM –±—É—Ñ–µ—Ä–∞

---

### 3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è heartbeat –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –º–µ—Ä—Ç–≤—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

**–¢–µ–∫—É—â–µ–µ:** 15 —Å–µ–∫—É–Ω–¥ ‚úÖ **–†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–ë—ã–ª–æ:** 30 —Å–µ–∫—É–Ω–¥

**–ü–ª—é—Å—ã:**
- –ë—ã—Å—Ç—Ä–µ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –º–µ—Ä—Ç–≤—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –ú–µ–Ω—å—à–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –º–µ—Ä—Ç–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ –ø–∞–º—è—Ç–∏

**–ú–∏–Ω—É—Å—ã:**
- –ë–æ–ª—å—à–µ ping/pong —Ç—Ä–∞—Ñ–∏–∫–∞

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```typescript
// –í server/client-connection.ts
const pingInterval = setInterval(() => {
  // ...
}, 15000) // –ë—ã–ª–æ 25000
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤, –Ω–æ —É–ª—É—á—à–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å

---

### 4. –£–º–µ–Ω—å—à–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –æ—á–µ—Ä–µ–¥–∏ broadcast –¥–ª—è –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–≥–æ drop'–∞

**–¢–µ–∫—É—â–µ–µ:** 500 —Å–æ–æ–±—â–µ–Ω–∏–π ‚úÖ **–†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–ë—ã–ª–æ:** 1000 —Å–æ–æ–±—â–µ–Ω–∏–π

**–ü–ª—é—Å—ã:**
- –ú–µ–Ω—å—à–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –ë–æ–ª–µ–µ —Å–≤–µ–∂–∏–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —É—Å–ø–µ–≤–∞—é—Ç

**–ú–∏–Ω—É—Å—ã:**
- –ë–æ–ª—å—à–µ drop'–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–∏ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞—Ö

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```bash
# –í .env –∏–ª–∏ Railway variables
MAX_BROADCAST_QUEUE_SIZE=500
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤, –Ω–æ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏

---

### 5. –£–º–µ–Ω—å—à–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ batch-–∑–∞–ø–∏—Å–∏ –≤ –ë–î

**–¢–µ–∫—É—â–µ–µ:** 300ms

**–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:** 150ms

**–ü–ª—é—Å—ã:**
- –ë–æ–ª–µ–µ —á–∞—Å—Ç–∞—è –∑–∞–ø–∏—Å—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤ –≤ –ë–î
- –ú–µ–Ω—å—à–µ –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è post-call –∞–Ω–∞–ª–∏–∑–∞

**–ú–∏–Ω—É—Å—ã:**
- –ë–æ–ª—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î (–Ω–æ –≤—Å–µ –µ—â–µ –≤ —Ä–∞–∑—ã –º–µ–Ω—å—à–µ, —á–µ–º –±–µ–∑ batch)

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```typescript
// –í server/transcript-batch-queue.ts
const DEFAULT_CONFIG: BatchQueueConfig = {
  flushIntervalMs: 150, // –ë—ã–ª–æ 300
  // ...
}
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤ –≤ UI, –Ω–æ —É–ª—É—á—à–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î

---

## –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (—Ç—Ä–µ–±—É—é—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã)

### 1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ WebRTC –≤–º–µ—Å—Ç–æ RTMP –¥–ª—è –µ—â–µ –º–µ–Ω—å—à–µ–π –∑–∞–¥–µ—Ä–∂–∫–∏

**–¢–µ–∫—É—â–µ–µ:** RTMP (TCP-based, ~10-50ms –∑–∞–¥–µ—Ä–∂–∫–∞)

**–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:** WebRTC (UDP-based, ~5-20ms –∑–∞–¥–µ—Ä–∂–∫–∞)

**–ü–ª—é—Å—ã:**
- –ú–µ–Ω—å—à–∞—è —Å–µ—Ç–µ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
- –ë–æ–ª–µ–µ –Ω–∏–∑–∫–∏–π latency

**–ú–∏–Ω—É—Å—ã:**
- –¢—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- LiveKit Egress –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç WebRTC –Ω–∞–ø—Ä—è–º—É—é (—Ç–æ–ª—å–∫–æ RTMP/HLS)

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** –°–ª–æ–∂–Ω–∞—è, —Ç—Ä–µ–±—É–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Track Egress –≤–º–µ—Å—Ç–æ Room Composite

---

### 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ STT –≤–º–µ—Å—Ç–æ Gladia

**–¢–µ–∫—É—â–µ–µ:** Gladia (cloud-based, ~100-150ms —Å–µ—Ç—å)

**–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:** Whisper.cpp –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π –ª–æ–∫–∞–ª—å–Ω—ã–π STT

**–ü–ª—é—Å—ã:**
- –ù–µ—Ç —Å–µ—Ç–µ–≤–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–æ Gladia
- –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π

**–ú–∏–Ω—É—Å—ã:**
- –¢—Ä–µ–±—É–µ—Ç –º–æ—â–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ (GPU –¥–ª—è —Ö–æ—Ä–æ—à–µ–π —Å–∫–æ—Ä–æ—Å—Ç–∏)
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
- –ú–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ, —á–µ–º Gladia (–µ—Å–ª–∏ –Ω–µ—Ç GPU)

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** –û—á–µ–Ω—å —Å–ª–æ–∂–Ω–∞—è, —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏ STT —Å–ª–æ—è

---

### 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Edge-–≤—ã—á–∏—Å–ª–µ–Ω–∏–π –¥–ª—è WebSocket broadcast

**–¢–µ–∫—É—â–µ–µ:** –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π WebSocket —Å–µ—Ä–≤–µ—Ä –Ω–∞ Railway

**–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:** Edge-—Ñ—É–Ω–∫—Ü–∏–∏ (Vercel Edge, Cloudflare Workers) –¥–ª—è broadcast

**–ü–ª—é—Å—ã:**
- –ú–µ–Ω—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤ (–±–ª–∏–∂–µ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º)
- –õ—É—á—à–∞—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

**–ú–∏–Ω—É—Å—ã:**
- –¢—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- –°–ª–æ–∂–Ω–æ—Å—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É edge –∏ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–º —Å–µ—Ä–≤–µ—Ä–æ–º

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** –°–ª–æ–∂–Ω–∞—è, —Ç—Ä–µ–±—É–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π

---

## –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

### –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–ª–µ–≥–∫–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å, —Ö–æ—Ä–æ—à–∏–π —ç—Ñ—Ñ–µ–∫—Ç)

1. ‚úÖ **–£–º–µ–Ω—å—à–∏—Ç—å `PCM_CHUNK_SIZE_MS` –¥–æ 50ms** ‚Äî **–†–ï–ê–õ–ò–ó–û–í–ê–ù–û**
   - –≠—Ñ—Ñ–µ–∫—Ç: -50ms –Ω–∞ —ç—Ç–∞–ø–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞—É–¥–∏–æ
   - –°–ª–æ–∂–Ω–æ—Å—Ç—å: –Ω–∏–∑–∫–∞—è (–∏–∑–º–µ–Ω–µ–Ω–∏–µ env –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π)
   - –†–∏—Å–∫: –Ω–∏–∑–∫–∏–π (–º–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å)
   - **–°—Ç–∞—Ç—É—Å:** –ò–∑–º–µ–Ω–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å 100ms –Ω–∞ 50ms –≤ `server/rtmp-ingest.ts`

2. ‚úÖ **–£–º–µ–Ω—å—à–∏—Ç—å `FLUSH_INTERVAL_MS` –¥–æ 25ms** ‚Äî **–†–ï–ê–õ–ò–ó–û–í–ê–ù–û**
   - –≠—Ñ—Ñ–µ–∫—Ç: -25ms –Ω–∞ —ç—Ç–∞–ø–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ PCM –±—É—Ñ–µ—Ä–∞
   - –°–ª–æ–∂–Ω–æ—Å—Ç—å: –Ω–∏–∑–∫–∞—è (–∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã)
   - –†–∏—Å–∫: –Ω–∏–∑–∫–∏–π
   - **–°—Ç–∞—Ç—É—Å:** –ò–∑–º–µ–Ω–µ–Ω–æ —Å 50ms –Ω–∞ 25ms –≤ `server/rtmp-ingest.ts`

**–û–±—â–∏–π —ç—Ñ—Ñ–µ–∫—Ç:** -75ms –Ω–∞ —ç—Ç–∞–ø–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ ‚úÖ **–ü–†–ò–ú–ï–ù–ï–ù–û**

---

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (—Ç—Ä–µ–±—É–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)

3. ‚úÖ **–£–º–µ–Ω—å—à–∏—Ç—å heartbeat interval –¥–æ 15 —Å–µ–∫—É–Ω–¥** ‚Äî **–†–ï–ê–õ–ò–ó–û–í–ê–ù–û**
   - –≠—Ñ—Ñ–µ–∫—Ç: —É–ª—É—á—à–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ (–Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤)
   - –°–ª–æ–∂–Ω–æ—Å—Ç—å: –Ω–∏–∑–∫–∞—è
   - –†–∏—Å–∫: –Ω–∏–∑–∫–∏–π
   - **–°—Ç–∞—Ç—É—Å:** –ò–∑–º–µ–Ω–µ–Ω–æ —Å 30 —Å–µ–∫—É–Ω–¥ –Ω–∞ 15 —Å–µ–∫—É–Ω–¥ –≤ `server/client-connection.ts`

4. ‚úÖ **–£–º–µ–Ω—å—à–∏—Ç—å `MAX_BROADCAST_QUEUE_SIZE` –¥–æ 500** ‚Äî **–†–ï–ê–õ–ò–ó–û–í–ê–ù–û**
   - –≠—Ñ—Ñ–µ–∫—Ç: –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ (–Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤)
   - –°–ª–æ–∂–Ω–æ—Å—Ç—å: –Ω–∏–∑–∫–∞—è
   - –†–∏—Å–∫: —Å—Ä–µ–¥–Ω–∏–π (–º–æ–∂–µ—Ç —É–≤–µ–ª–∏—á–∏—Ç—å drop'—ã –¥–ª—è –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤)
   - **–°—Ç–∞—Ç—É—Å:** –ò–∑–º–µ–Ω–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å 1000 –Ω–∞ 500 –≤ `server/client-connection.ts`

---

### –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (—Ç—Ä–µ–±—É–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π)

5. üîÑ **WebRTC –≤–º–µ—Å—Ç–æ RTMP** ‚Äî —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
6. üîÑ **–õ–æ–∫–∞–ª—å–Ω—ã–π STT** ‚Äî —Ç—Ä–µ–±—É–µ—Ç –º–æ—â–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ –∏ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏
7. üîÑ **Edge-–≤—ã—á–∏—Å–ª–µ–Ω–∏—è** ‚Äî —Ç—Ä–µ–±—É–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

1. **`stt.end_to_transcript_ms`** ‚Äî –∑–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞—É–¥–∏–æ –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞
   - –¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: < 500ms –¥–ª—è partial, < 1000ms –¥–ª—è final

2. **`ws.session_broadcast_lag_ms.{sessionSlug}`** ‚Äî –∑–∞–¥–µ—Ä–∂–∫–∞ broadcast –¥–ª—è —Å–µ—Å—Å–∏–∏
   - –¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: < 10ms

3. **`gladia.stt_latency_ms`** ‚Äî –∑–∞–¥–µ—Ä–∂–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Gladia
   - –¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: < 500ms –¥–ª—è partial, < 1000ms –¥–ª—è final

4. **`ws.queue_drops_total`** ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥—Ä–æ–ø–Ω—É—Ç—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
   - –¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: 0 (–∏–ª–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ)

5. **`audio.chunk_size_bytes`** ‚Äî —Ä–∞–∑–º–µ—Ä PCM —á–∞–Ω–∫–æ–≤
   - –¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ~1600 bytes (50ms) –∏–ª–∏ ~3200 bytes (100ms)

### Endpoint –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

```
GET /metrics
```

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –º–µ—Ç—Ä–∏–∫–∏ –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ, –≤–∫–ª—é—á–∞—è:
- Latency –º–µ—Ç—Ä–∏–∫–∏ (avg, min, max, p50, p95, p99)
- Counter –º–µ—Ç—Ä–∏–∫–∏ (–æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–±—ã—Ç–∏–π)
- Per-session –º–µ—Ç—Ä–∏–∫–∏ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–µ–Ω—Ç–æ–≤, —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏, broadcast lag)

**–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–µ—Ç—Ä–∏–∫:**

```bash
# –ü—Ä–æ–¥–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä
curl https://sessions-ws-production.up.railway.app/metrics | jq

# –õ–æ–∫–∞–ª—å–Ω–æ (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω)
curl http://localhost:3000/metrics | jq

# –¢–æ–ª—å–∫–æ latency –º–µ—Ç—Ä–∏–∫–∏ (–∫–ª—é—á–µ–≤—ã–µ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏)
curl https://sessions-ws-production.up.railway.app/metrics | jq '.latency | to_entries | map(select(.key | contains("stt") or contains("broadcast") or contains("gladia")))'
```

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —É–∂–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏:

- ‚úÖ FFmpeg –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ low-latency —Ñ–ª–∞–≥–∏
- ‚úÖ PCM —á–∞–Ω–∫–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ (100ms)
- ‚úÖ WebSocket broadcast —á–µ—Ä–µ–∑ in-memory –æ—á–µ—Ä–µ–¥—å (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞)
- ‚úÖ Batch-–∑–∞–ø–∏—Å—å –≤ –ë–î (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç—ã)
- ‚úÖ Deduplication final —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –º–µ—Ä—Ç–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤

**–¢–µ–∫—É—â–∞—è end-to-end latency:** 300-700ms –¥–ª—è partial, 600-1200ms –¥–ª—è final

**–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π:** 225-625ms –¥–ª—è partial, 525-1025ms –¥–ª—è final (-75ms) ‚úÖ **–ü–†–ò–ú–ï–ù–ï–ù–û**

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- ‚úÖ `PCM_CHUNK_SIZE_MS`: 100ms ‚Üí 50ms (-50ms)
- ‚úÖ `FLUSH_INTERVAL_MS`: 50ms ‚Üí 25ms (-25ms)
- ‚úÖ `PING_INTERVAL_MS`: 30s ‚Üí 15s (—É–ª—É—á—à–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏)
- ‚úÖ `MAX_BROADCAST_QUEUE_SIZE`: 1000 ‚Üí 500 (–∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏)

–û—Å–Ω–æ–≤–Ω—ã–µ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞:
1. **–°–µ—Ç–µ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–æ Gladia** (~100-150ms) ‚Äî –Ω–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è –Ω–∞–º–∏
2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Gladia** (~200-500ms –¥–ª—è partial) ‚Äî –Ω–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è –Ω–∞–º–∏
3. **–°–µ—Ç–µ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤** (~50-200ms) ‚Äî –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤

–î–∞–ª—å–Ω–µ–π—à–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ç—Ä–µ–±—É—é—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π (WebRTC, –ª–æ–∫–∞–ª—å–Ω—ã–π STT, edge-–≤—ã—á–∏—Å–ª–µ–Ω–∏—è) –∏ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ—Ü–µ–ª–µ—Å–æ–æ–±—Ä–∞–∑–Ω—ã —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è cost/benefit.

