# Оптимизации WebSocket сервера транскрипции

## Обзор

WebSocket сервер оптимизирован для высокой нагрузки (500-1000 одновременных пользователей) с фокусом на снижение нагрузки на БД и повышение надежности.

## Ключевые оптимизации

### 1. Singleton PrismaClient

**Файл:** `db.ts`

- Использует `globalThis` для предотвращения создания множественных экземпляров
- Работает в dev и production окружениях
- Graceful shutdown: закрывает соединения при завершении процесса

**Эффект:** Предотвращает создание множественных connection pools, снижает нагрузку на БД.

### 2. Batch-запись транскриптов

**Файл:** `transcript-batch-queue.ts`

- In-memory очередь для pending транскриптов
- Периодическая запись батчами (по умолчанию каждые 300ms, до 100 элементов)
- Кэширование sessionId и participantId для снижения запросов к БД
- Обработка ошибок без падения процесса

**Эффект:** Снижает нагрузку на БД в 10-50 раз (вместо N запросов делаем 1 запрос на батч).

**Конфигурация:**
- `flushIntervalMs`: 300ms (интервал записи батчей)
- `maxBatchSize`: 100 (максимальный размер батча)
- `maxQueueSize`: 1000 (максимальный размер очереди, предупреждение при превышении)

### 3. Запись только финальных сегментов

**Файл:** `append-transcript-chunk.ts`

- В БД сохраняются только финальные транскрипты (`isFinal = true`)
- Partial транскрипты отправляются клиенту для UI, но не сохраняются в БД
- Это снижает нагрузку в 50-100 раз (partial обновляется каждые 200-500ms)

### 4. Маршрут данных

**Файл:** `client-connection.ts`

- WebSocket сервер отправляет транскрипты ТОЛЬКО подключенному клиенту (transcription host)
- НЕ бродкастит транскрипты всем участникам
- Распространение среди других участников происходит через LiveKit data channel (на клиенте)

**Схема:**
```
HOST → WS → Gladia → WS → HOST → LiveKit data channel → Other participants
```

### 5. Метрики и мониторинг

**Файлы:** `metrics.ts`, `transcript-batch-queue.ts`

- Метрики очереди: длина очереди, количество записанных транскриптов, ошибки
- Логирование переполнения очереди
- Логирование ошибок записи в БД
- Метрики доступны через `/metrics` endpoint

## Использование

### Запуск сервера

```bash
npm run dev:ws
# или
tsx ws/server/index.ts
```

### Проверка метрик

```bash
curl http://localhost:3001/metrics
```

Метрики включают:
- `activeConnections` - количество активных WebSocket подключений
- `activeGladiaBridges` - количество активных Gladia bridges
- `queue.queueLength` - текущая длина очереди транскриптов
- `queue.totalQueued` - всего добавлено в очередь
- `queue.totalFlushed` - всего записано в БД
- `queue.totalErrors` - количество ошибок

### Graceful shutdown

Сервер автоматически:
1. Закрывает новые WebSocket подключения
2. Останавливает batch-таймер
3. Записывает все pending транскрипты в БД
4. Закрывает Prisma соединения

## Производительность

### До оптимизации:
- Каждый финальный транскрипт = 1-2 запроса к БД (upsert session, upsert participant, upsert segment)
- При 1000 пользователях и 1 транскрипте в секунду = 1000-2000 запросов/сек

### После оптимизации:
- Batch-запись: 100 транскриптов = 1 транзакция (10-20 запросов внутри транзакции)
- При 1000 пользователях и 1 транскрипте в секунду = ~10-20 запросов/сек
- **Снижение нагрузки в 50-100 раз**

## Настройка для production

### Переменные окружения

```env
# Database
DATABASE_URL=postgresql://...

# Gladia
GLADIA_API_KEY=...

# JWT для транскрипции
TRANSCRIPTION_JWT_SECRET=...

# Port
PORT=10000
WS_PORT=10000
```

### Настройка batch-системы (опционально)

Можно изменить параметры через `setBatchQueueConfig()`:

```typescript
import { setBatchQueueConfig } from './transcript-batch-queue.js'

setBatchQueueConfig({
  flushIntervalMs: 500, // Увеличить интервал для меньшей нагрузки
  maxBatchSize: 200, // Увеличить размер батча
  maxQueueSize: 2000, // Увеличить лимит очереди
})
```

## Troubleshooting

### Проблема: Очередь переполняется

**Симптомы:** Логи `Queue overflow!`

**Решение:**
1. Увеличить `maxQueueSize` в конфигурации
2. Увеличить `maxBatchSize` для более быстрой обработки
3. Уменьшить `flushIntervalMs` для более частой записи
4. Проверить производительность БД

### Проблема: Ошибки записи в БД

**Симптомы:** Логи `Error flushing batch for session`

**Решение:**
1. Проверить подключение к БД
2. Проверить, что сессия существует в БД
3. Проверить логи Prisma для деталей ошибки

### Проблема: Высокая нагрузка на БД

**Симптомы:** Медленные запросы, таймауты

**Решение:**
1. Увеличить `flushIntervalMs` (реже записывать)
2. Увеличить `maxBatchSize` (больше элементов за раз)
3. Оптимизировать индексы в БД
4. Рассмотреть использование connection pooling

