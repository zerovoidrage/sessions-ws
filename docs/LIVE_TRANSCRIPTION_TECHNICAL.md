# ะะฐะนะฒ ััะฐะฝัะบัะธะฟัะธั โ ะขะตัะฝะธัะตัะบะฐั ะดะพะบัะผะตะฝัะฐัะธั

## ๐ ะกะพะดะตัะถะฐะฝะธะต

1. [ะะฑะทะพั ัะธััะตะผั](#ะพะฑะทะพั-ัะธััะตะผั)
2. [ะัะฟะพะปัะทัะตะผัะต ัะตัะฒะธัั ะธ ะธะฝััะฐััััะบัััะฐ](#ะธัะฟะพะปัะทัะตะผัะต-ัะตัะฒะธัั-ะธ-ะธะฝััะฐััััะบัััะฐ)
3. [ะััะธัะตะบัััะฐ ะฟัะพัะตััะฐ ััะฐะฝัะบัะธะฟัะธะธ](#ะฐััะธัะตะบัััะฐ-ะฟัะพัะตััะฐ-ััะฐะฝัะบัะธะฟัะธะธ)
4. [ะัะฝะพะฒะฝัะต ะบะพะผะฟะพะฝะตะฝัั ะบะพะดะฐ](#ะพัะฝะพะฒะฝัะต-ะบะพะผะฟะพะฝะตะฝัั-ะบะพะดะฐ)
5. [ะขะตะบััะธะต ะฟัะพะฑะปะตะผั ะธ ัะตัะตะฝะธั](#ัะตะบััะธะต-ะฟัะพะฑะปะตะผั-ะธ-ัะตัะตะฝะธั)
6. [ะะพัะพะบ ะดะฐะฝะฝัั (ะดะตัะฐะปัะฝะพ)](#ะฟะพัะพะบ-ะดะฐะฝะฝัั-ะดะตัะฐะปัะฝะพ)

---

## ะะฑะทะพั ัะธััะตะผั

### ะงัะพ ะดะตะปะฐะตะผ

**ะะฐะนะฒ ััะฐะฝัะบัะธะฟัะธั** โ ััะพ ัะธััะตะผะฐ ะดะปั ะฟัะตะพะฑัะฐะทะพะฒะฐะฝะธั ัะตัะธ ะฒ ัะตะบัั ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ ะฒะพ ะฒัะตะผั ะฒะธะดะตะพะทะฒะพะฝะบะพะฒ.

**ะัะฝะพะฒะฝัะต ะฒะพะทะผะพะถะฝะพััะธ:**
- โ ะขัะฐะฝัะบัะธะฟัะธั ัะตัะธ ะฒัะตั ััะฐััะฝะธะบะพะฒ ัะตััะธะธ ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ
- โ ะัะพะฑัะฐะถะตะฝะธะต ััะฐะฝัะบัะธะฟัะพะฒ ะฒ ะธะฝัะตััะตะนัะต (partial ะธ final)
- โ ะะฟัะตะดะตะปะตะฝะธะต ะฐะบัะธะฒะฝะพะณะพ ัะฟะธะบะตัะฐ (speaker diarization)
- โ ะกะพััะฐะฝะตะฝะธะต ัะธะฝะฐะปัะฝัั ััะฐะฝัะบัะธะฟัะพะฒ ะฒ ะฑะฐะทั ะดะฐะฝะฝัั
- โ ะฃััั ะธัะฟะพะปัะทะพะฒะฐะฝะธั ะธ ััะพะธะผะพััะธ ััะฐะฝัะบัะธะฟัะธะธ

**ะะพะดะตะปั ัะฐะฑะพัั:**
- **Server-Side ััะฐะฝัะบัะธะฟัะธั** (ัะตะบััะฐั ัะตะฐะปะธะทะฐัะธั)
- ะะดะธะฝ ะฟะพัะพะบ ััะฐะฝัะบัะธะฟัะธะธ ะฝะฐ ัะตััะธั (ะฝะต ะฝะฐ ััะฐััะฝะธะบะฐ)
- ะะธะบัะธัะพะฒะฐะฝะธะต ะฐัะดะธะพ ะฝะฐ ััะพัะพะฝะต LiveKit
- ะฆะตะฝััะฐะปะธะทะพะฒะฐะฝะฝะฐั ะพะฑัะฐะฑะพัะบะฐ ัะตัะตะท RTMP โ FFmpeg โ Gladia

---

## ะัะฟะพะปัะทัะตะผัะต ัะตัะฒะธัั ะธ ะธะฝััะฐััััะบัััะฐ

### ะะฝะตัะฝะธะต ัะตัะฒะธัั

#### 1. **LiveKit Cloud** (WebRTC ัะตัะฒะตั)
- **ะะฐะทะฝะฐัะตะฝะธะต:** ะะธะดะตะพะทะฒะพะฝะบะธ, WebRTC ัะพะตะดะธะฝะตะฝะธั
- **ะัะฟะพะปัะทะพะฒะฐะฝะธะต:**
  - ะะพะดะบะปััะตะฝะธะต ััะฐััะฝะธะบะพะฒ ะบ ะบะพะผะฝะฐัะฐะผ (ัะตััะธัะผ)
  - ะัะฑะปะธะบะฐัะธั ะฐัะดะธะพ/ะฒะธะดะตะพ ััะตะบะพะฒ
  - **Room Composite Egress** โ ะฟะพะปััะตะฝะธะต ะผะธะบัะธัะพะฒะฐะฝะฝะพะณะพ ะฐัะดะธะพ ะฟะพัะพะบะฐ ะดะปั ััะฐะฝัะบัะธะฟัะธะธ
- **API:** `livekit-server-sdk` (Node.js)
- **ะะพะฝัะธะณััะฐัะธั:**
  - `LIVEKIT_HTTP_URL` โ URL LiveKit ัะตัะฒะตัะฐ
  - `LIVEKIT_API_KEY` โ API ะบะปัั
  - `LIVEKIT_API_SECRET` โ API ัะตะบัะตั

#### 2. **Gladia API** (Speech-to-Text)
- **ะะฐะทะฝะฐัะตะฝะธะต:** ะขัะฐะฝัะบัะธะฟัะธั ะฐัะดะธะพ ะฒ ัะตะบัั ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ
- **ะัะฟะพะปัะทะพะฒะฐะฝะธะต:**
  - **Gladia Live v2 API** โ WebSocket ะดะปั real-time ััะฐะฝัะบัะธะฟัะธะธ
  - ะัะธะฝะธะผะฐะตั PCM16 ะฐัะดะธะพ (16kHz, mono)
  - ะะพะทะฒัะฐัะฐะตั partial ะธ final ััะฐะฝัะบัะธะฟัั
- **API:** WebSocket (`wss://api.gladia.io/v2/live`)
- **ะะพะฝัะธะณััะฐัะธั:**
  - `GLADIA_API_KEY` โ API ะบะปัั ะดะปั Gladia
- **ะะณัะฐะฝะธัะตะฝะธั:**
  - Gladia Live v2 ะฝะต ะดะฐัั ะฟะพะปะฝะพัะตะฝะฝะพะน diarization ะฒ real-time
  - Diarization ะดะพัััะฟะฝะฐ ัะพะปัะบะพ ะฒ file-based API (post-call analysis)
  - ะะพััะพะผั ะธัะฟะพะปัะทัะตะผ active-speaker-tracker ะธะท LiveKit ะบะฐะบ ะพัะฝะพะฒะฝะพะน ะธััะพัะฝะธะบ

#### 3. **Neon PostgreSQL** (ะะฐะทะฐ ะดะฐะฝะฝัั)
- **ะะฐะทะฝะฐัะตะฝะธะต:** ะฅัะฐะฝะตะฝะธะต ัะตััะธะน, ััะฐััะฝะธะบะพะฒ, ััะฐะฝัะบัะธะฟัะพะฒ, ะผะตััะธะบ
- **ะัะฟะพะปัะทะพะฒะฐะฝะธะต:**
  - `VideoSession` โ ัะตััะธะธ
  - `Participant` โ ััะฐััะฝะธะบะธ ัะตััะธะน
  - `TranscriptSegment` โ ัะธะฝะฐะปัะฝัะต ััะฐะฝัะบัะธะฟัั
  - `TranscriptionUsage` โ ะผะตััะธะบะธ ะธัะฟะพะปัะทะพะฒะฐะฝะธั
- **ORM:** Prisma
- **ะะพะฝัะธะณััะฐัะธั:**
  - `DATABASE_URL` โ connection string ะดะปั PostgreSQL

### ะะฝััะฐััััะบัััะฐ (Railway)

#### ะกะตัะฒะธั 1: **WebSocket Server** (`SERVER_MODE=ws`)

**ะะฐะทะฝะฐัะตะฝะธะต:** ะะฑัะฐะฑะพัะบะฐ ะบะปะธะตะฝััะบะธั WebSocket ะฟะพะดะบะปััะตะฝะธะน ะดะปั ะฟะพะปััะตะฝะธั ััะฐะฝัะบัะธะฟัะพะฒ.

**ะงัะพ ะดะตะปะฐะตั:**
1. โ ะัะธะฝะธะผะฐะตั WebSocket ะฟะพะดะบะปััะตะฝะธั ะพั ััะพะฝัะตะฝะดะฐ
2. โ ะะฐะปะธะดะธััะตั JWT ัะพะบะตะฝั ะดะปั ะฐะฒัะพัะธะทะฐัะธะธ
3. โ ะะตะณะธัััะธััะตั ะบะปะธะตะฝัะพะฒ ะดะปั ัะตััะธะน
4. โ ะัะธะฝะธะผะฐะตั ััะฐะฝัะบัะธะฟัั ะพั RTMP ัะตัะฒะตัะฐ ัะตัะตะท HTTP API
5. โ Broadcast ััะฐะฝัะบัะธะฟัะพะฒ ะฒัะตะผ ะฟะพะดะบะปััะตะฝะฝัะผ ะบะปะธะตะฝัะฐะผ ัะตััะธะธ
6. โ ะฃะฟัะฐะฒะปัะตั ะทะฐะฟััะบะพะผ ััะฐะฝัะบัะธะฟัะธะธ (ะฒัะทัะฒะฐะตั LiveKit Egress API)
7. โ ะะฑัะฐะฑะฐััะฒะฐะตั ะฐะบัะธะฒะฝัั ัะฟะธะบะตัะพะฒ ัะตัะตะท HTTP API

**Endpoints:**
- `ws://domain/api/realtime/transcribe` โ WebSocket ะดะปั ะฟะพะปััะตะฝะธั ััะฐะฝัะบัะธะฟัะพะฒ
- `POST /api/transcription/start` โ ะทะฐะฟััะบ ัะตัะฒะตัะฝะพะน ััะฐะฝัะบัะธะฟัะธะธ
- `POST /api/transcription/stop` โ ะพััะฐะฝะพะฒะบะฐ ััะฐะฝัะบัะธะฟัะธะธ
- `POST /api/realtime/transcribe/broadcast` โ **ะผะตะถัะตัะฒะธัะฝัะน endpoint** ะดะปั ะฟัะธะตะผะฐ ััะฐะฝัะบัะธะฟัะพะฒ ะพั RTMP ัะตัะฒะตัะฐ
- `POST /api/active-speaker` โ ะพะฑะฝะพะฒะปะตะฝะธะต ะฐะบัะธะฒะฝะพะณะพ ัะฟะธะบะตัะฐ
- `GET /health` โ health check
- `GET /metrics` โ ะผะตััะธะบะธ ัะตัะฒะตัะฐ

**ะะพััั:**
- HTTP/WebSocket: ะฟะพัั, ะฝะฐะทะฝะฐัะตะฝะฝัะน Railway ะฐะฒัะพะผะฐัะธัะตัะบะธ (ะพะฑััะฝะพ 8080)
- **ะะ** ะทะฐะฟััะบะฐะตั RTMP ัะตัะฒะตั

**ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั:**
```bash
SERVER_MODE=ws
WS_BASE_URL=https://ws-production-dbcc.up.railway.app  # URL ััะพะณะพ ัะตัะฒะธัะฐ
RTMP_SERVER_URL=https://rtmp-service.up.railway.app  # URL RTMP ัะตัะฒะตัะฐ
RTMP_SERVER_SECRET=shared-secret                     # ะกะตะบัะตั ะดะปั ะผะตะถัะตัะฒะธัะฝะพะน ัะฒัะทะธ
DATABASE_URL=...
LIVEKIT_HTTP_URL=...
LIVEKIT_API_KEY=...
LIVEKIT_API_SECRET=...
TRANSCRIPTION_JWT_SECRET=...
GLADIA_API_KEY=...  # ะัะถะตะฝ ะดะปั ะทะฐะฟััะบะฐ ััะฐะฝัะบัะธะฟัะธะธ (ัะพะทะดะฐะฝะธะต Egress)
```

**Networking (Railway):**
- **Public Networking:** `Default / Auto-detect`
- Railway ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฝะฐะทะฝะฐัะฐะตั ะฟะพัั ะดะปั HTTP/WebSocket
- โ **ะะ** ัััะฐะฝะฐะฒะปะธะฒะฐัั Custom Port

---

#### ะกะตัะฒะธั 2: **RTMP Server** (`SERVER_MODE=rtmp`)

**ะะฐะทะฝะฐัะตะฝะธะต:** ะัะธะตะผ RTMP ะฟะพัะพะบะพะฒ ะพั LiveKit Egress, ะดะตะบะพะดะธัะพะฒะฐะฝะธะต ะฐัะดะธะพ ะธ ััะฐะฝัะบัะธะฟัะธั ัะตัะตะท Gladia.

**ะงัะพ ะดะตะปะฐะตั:**
1. โ ะกะปััะฐะตั RTMP ะฟะพัั (1937) ัะตัะตะท TCP Proxy
2. โ ะัะธะฝะธะผะฐะตั RTMP ะฟะพัะพะบ ะพั LiveKit Room Composite Egress
3. โ ะะตะบะพะดะธััะตั ะฐัะดะธะพ ัะตัะตะท FFmpeg (RTMP โ PCM16)
4. โ ะัะฟัะฐะฒะปัะตั ะฐัะดะธะพ ะฒ Gladia API ะดะปั ััะฐะฝัะบัะธะฟัะธะธ
5. โ ะะพะปััะฐะตั ััะฐะฝัะบัะธะฟัั ะพั Gladia
6. โ ะัะฟัะฐะฒะปัะตั ััะฐะฝัะบัะธะฟัั ะฒ WebSocket ัะตัะฒะตั ัะตัะตะท HTTP POST
7. โ ะกะพััะฐะฝัะตั ัะธะฝะฐะปัะฝัะต ััะฐะฝัะบัะธะฟัั ะฒ ะฑะฐะทั ะดะฐะฝะฝัั

**Endpoints:**
- RTMP: `rtmp://tcp-proxy-host:port/live/{sessionSlug}` โ ะฟัะธะตะผ RTMP ะฟะพัะพะบะฐ
- **ะะะข** HTTP endpoints (ัะพะปัะบะพ RTMP)

**ะะพััั:**
- RTMP: 1937 (ัะตัะตะท TCP Proxy Railway)
- **ะะ** ะทะฐะฟััะบะฐะตั HTTP/WebSocket ัะตัะฒะตั

**ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั:**
```bash
SERVER_MODE=rtmp
RTMP_PORT=1937
RTMP_HOST=region.proxy.rlwy.net              # TCP ะฟัะพะบัะธ ัะพัั
RTMP_EXTERNAL_PORT=XXXXX                    # TCP ะฟัะพะบัะธ ะฟะพัั
WS_SERVER_URL=https://ws-service.up.railway.app  # URL WebSocket ัะตัะฒะตัะฐ
RTMP_SERVER_SECRET=shared-secret            # ะขะะข ะะ ัะตะบัะตั, ััะพ ะฝะฐ WS ัะตัะฒะตัะต
GLADIA_API_KEY=...
DATABASE_URL=...
LIVEKIT_HTTP_URL=...  # ะะพะถะตั ะฟะพะฝะฐะดะพะฑะธัััั ะดะปั ะดะพะฟะพะปะฝะธัะตะปัะฝะพะน ะปะพะณะธะบะธ
```

**Networking (Railway):**
- **TCP Proxy:** ะฟะพัั `1937`
- Railway ะฟัะตะดะพััะฐะฒะปัะตั TCP ะฟัะพะบัะธ URL (ะฝะฐะฟัะธะผะตั: `region.proxy.rlwy.net:XXXXX`)
- โ **ะะ** ะฝัะถะตะฝ Public Networking

---

## ะััะธัะตะบัััะฐ ะฟัะพัะตััะฐ ััะฐะฝัะบัะธะฟัะธะธ

### ะะฑัะฐั ััะตะผะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ะะปะธะตะฝั (ะัะฐัะทะตั)                     โ
โ                                                         โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  WebSocket: wss://ws-service/.../transcribe     โ  โ
โ  โ  - ะะพะดะบะปััะตะฝะธะต ะดะปั ะฟะพะปััะตะฝะธั ััะฐะฝัะบัะธะฟัะพะฒ       โ  โ
โ  โ  - ะัะฟัะฐะฒะบะฐ active speaker events               โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                        โ                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
                          โ wss://
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ        Service 1: WebSocket Server (PORT=8080)          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  โข WebSocket connections                         โ  โ
โ  โ  โข Client registration                           โ  โ
โ  โ  โข Broadcast transcripts                         โ  โ
โ  โ  โข Start/Stop transcription (LiveKit Egress)    โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                        โ                                โ
โ                  HTTP POST /api/realtime/transcribe/broadcast
โ                        โ                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
                          โ HTTP
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ          Service 2: RTMP Server (PORT=1937)             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  โข RTMP ingestion (TCP Proxy)                   โ  โ
โ  โ  โข FFmpeg decoding (RTMP โ PCM16)               โ  โ
โ  โ  โข Gladia transcription                         โ  โ
โ  โ  โข Send transcripts to WS server                โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                        โ                                โ
โ                  RTMP stream                           โ
โ                        โ                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
                          โ
                          โ RTMP
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  LiveKit Egress                         โ
โ                                                         โ
โ  Room Composite Egress โ RTMP stream                   โ
โ  (ะผะธะบัะธัะพะฒะฐะฝะฝะพะต ะฐัะดะธะพ ะฒัะตั ััะฐััะฝะธะบะพะฒ)                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ะะพัะพะบ ะดะฐะฝะฝัั (ะฟะพัะฐะณะพะฒะพ)

#### 1. ะะฝะธัะธะฐะปะธะทะฐัะธั ัะตััะธะธ

```
ะะปะธะตะฝั โ GET /api/sessions/[slug]/token
  โ
Next.js API Route
  โ
- ะะพะปััะฐะตั ัะตััะธั ะธะท ะะ ะฟะพ slug
- ะะตะฝะตัะธััะตั LiveKit AccessToken
- ะะตะฝะตัะธััะตั transcription JWT ัะพะบะตะฝ
  โ
Response: {
  token: "livekit-jwt-token",
  transcriptionToken: "jwt-for-websocket",
  sessionCreatedByUserId: "user-id"
}
```

#### 2. ะะพะดะบะปััะตะฝะธะต ะบ LiveKit ะบะพะผะฝะฐัะต

```
ะะปะธะตะฝั โ Room.connect(serverUrl, token)
  โ
LiveKit Cloud (WebRTC)
  โ
- ะัะพะฒะตัะบะฐ ัะพะบะตะฝะฐ
- ะกะพะทะดะฐะฝะธะต/ะฝะฐะนะดะตะฝ ะบะพะผะฝะฐัั (roomName = sessionSlug)
- ะะตะณะธัััะฐัะธั ััะฐััะฝะธะบะฐ
- ะฃััะฐะฝะพะฒะบะฐ WebRTC ัะพะตะดะธะฝะตะฝะธั
  โ
RoomEvent.Connected
  โ
localParticipant ะดะพัััะฟะตะฝ
```

#### 3. ะะพะดะบะปััะตะฝะธะต ะบ WebSocket ัะตัะฒะตัั

```
ะะปะธะตะฝั โ WebSocket.connect(ws://ws-service/api/realtime/transcribe?token=<JWT>)
  โ
WebSocket Server (ws-server/server/index.ts)
  โ
1. ะะฐะปะธะดะฐัะธั JWT ัะพะบะตะฝะฐ (verifyTranscriptionToken)
2. ะะทะฒะปะตัะตะฝะธะต sessionSlug, participantIdentity
3. ะะตะณะธัััะฐัะธั ะบะปะธะตะฝัะฐ ะดะปั ัะตััะธะธ
4. ะัะฟัะฐะฒะบะฐ initial message: {"type": "connected", ...}
  โ
ะะปะธะตะฝั ะทะฐัะตะณะธัััะธัะพะฒะฐะฝ ะธ ะณะพัะพะฒ ะฟะพะปััะฐัั ััะฐะฝัะบัะธะฟัั
```

#### 4. ะะฐะฟััะบ ัะตัะฒะตัะฝะพะน ััะฐะฝัะบัะธะฟัะธะธ

```
ะะปะธะตะฝั โ POST /api/transcription/start
  Body: { sessionId, sessionSlug }
  โ
WebSocket Server
  โ
startServerTranscription({ sessionId, sessionSlug })
  โ
startRoomCompositeTranscription()
  โ
1. ะกะพะทะดะฐะฝะธะต RTMP Ingest (ะฝะฐ RTMP ัะตัะฒะตัะต, ะตัะปะธ ะฝะต ะฒ split mode)
2. ะะฐะฟััะบ LiveKit Room Composite Egress:
   - EgressClient.startRoomCompositeEgress()
   - Audio-only ัะตะถะธะผ
   - RTMP ะฒััะพะด: rtmp://rtmp-host:port/live/{sessionSlug}
  โ
LiveKit ะฝะฐัะธะฝะฐะตั ัััะธะผะธัั ะผะธะบัะธัะพะฒะฐะฝะฝะพะต ะฐัะดะธะพ ะฒ RTMP
```

#### 5. ะัะธะตะผ RTMP ะฟะพัะพะบะฐ

```
LiveKit Egress โ RTMP stream โ rtmp://rtmp-host:port/live/{sessionSlug}
  โ
RTMP Server (ws-server/server/rtmp-server.ts)
  โ
1. RTMP ัะตัะฒะตั ะฟัะธะฝะธะผะฐะตั ะฟะพัะพะบ
2. ะัะทัะฒะฐะตััั onStreamStart callback
3. ะะฐะฟััะบะฐะตััั FFmpeg decoder:
   - ffmpeg -i rtmp://localhost:1937/live/{sessionSlug}
   - ะะตะบะพะดะธัะพะฒะฐะฝะธะต: RTMP โ PCM16 (16kHz, mono)
   - ะัะฒะพะด ะฒ stdout (pipe:1)
```

#### 6. ะะตะบะพะดะธัะพะฒะฐะฝะธะต ะธ ะพัะฟัะฐะฒะบะฐ ะฒ Gladia

```
FFmpeg โ PCM16 chunks (stdout)
  โ
RTMP Ingest (ws-server/server/rtmp-ingest.ts)
  โ
1. ะงัะตะฝะธะต PCM16 ะดะฐะฝะฝัั ะธะท FFmpeg stdout
2. ะกะพะทะดะฐะฝะธะต GladiaBridge (ะตัะปะธ ะตัะต ะฝะต ัะพะทะดะฐะฝ)
3. ะัะฟัะฐะฒะบะฐ PCM16 ัะฐะฝะบะพะฒ ะฒ Gladia WebSocket
  โ
GladiaBridge.sendAudio(chunk)
  โ
Gladia WebSocket (wss://api.gladia.io/v2/live)
```

#### 7. ะขัะฐะฝัะบัะธะฟัะธั ะฒ Gladia

```
Gladia API
  โ
- ะะฑัะฐะฑะพัะบะฐ PCM16 ะฐัะดะธะพ
- ะะฐัะฟะพะทะฝะฐะฒะฐะฝะธะต ัะตัะธ (STT)
- ะะตะฝะตัะฐัะธั partial transcripts (ะดัะฐััั)
- ะะตะฝะตัะฐัะธั final transcripts (ัะธะฝะฐะปัะฝัะต ัะตะณะผะตะฝัั)
  โ
Gladia โ WebSocket Server:
  {
    type: 'transcript',
    data: {
      id: 'utterance-id',
      is_final: false/true,
      utterance: { text: '...' }
    }
  }
```

#### 8. ะะพะปััะตะฝะธะต ััะฐะฝัะบัะธะฟัะพะฒ ะธ broadcast

```
Gladia โ RTMP Server (GladiaBridge)
  โ
handleTranscript(event: TranscriptEvent)
  โ
1. ะะพะปััะตะฝะธะต ะฐะบัะธะฒะฝะพะณะพ ัะฟะธะบะตัะฐ (getActiveSpeaker)
2. ะคะพัะผะธัะพะฒะฐะฝะธะต payload:
   {
     sessionSlug,
     utteranceId,
     text,
     isFinal,
     speaker: activeSpeaker.identity,
     speakerId: activeSpeaker.identity,
     ts: Date.now()
   }
3. ะัะฟัะฐะฒะบะฐ ะฒ WebSocket ัะตัะฒะตั:
   HTTP POST /api/realtime/transcribe/broadcast
  โ
WebSocket Server (ws-server/server/broadcast.ts)
  โ
1. ะะพะปััะตะฝะธะต ะฒัะตั ะบะปะธะตะฝัะพะฒ ัะตััะธะธ (getClientsForSession)
2. Broadcast ััะฐะฝัะบัะธะฟัะฐ ะฒัะตะผ ะบะปะธะตะฝัะฐะผ:
   ws.send(JSON.stringify(payload))
  โ
ะะปะธะตะฝัั ะฟะพะปััะฐัั ััะฐะฝัะบัะธะฟัั ัะตัะตะท WebSocket
```

#### 9. ะกะพััะฐะฝะตะฝะธะต ะฒ ะะ

```
ะขะพะปัะบะพ ัะธะฝะฐะปัะฝัะต ััะฐะฝัะบัะธะฟัั (isFinal: true):
  โ
appendTranscriptChunk() (ws-server/server/append-transcript-chunk.ts)
  โ
1. ะะพะปััะตะฝะธะต ัะตััะธะธ ะฟะพ slug
2. ะกะพะทะดะฐะฝะธะต/ะพะฑะฝะพะฒะปะตะฝะธะต Participant (ะฟะพ identity)
3. upsert TranscriptSegment (ะฟะพ videoSessionId + utteranceId)
  โ
ะะ (PostgreSQL):
  - VideoSession (ัััะตััะฒัััะฐั ัะตััะธั)
  - Participant (ัะพะทะดะฐัััั ะฟัะธ ะฟะตัะฒะพะผ ััะฐะฝัะบัะธะฟัะต)
  - TranscriptSegment (ัะธะฝะฐะปัะฝัะน ัะตะณะผะตะฝั)
```

---

## ะัะฝะพะฒะฝัะต ะบะพะผะฟะพะฝะตะฝัั ะบะพะดะฐ

### 1. WebSocket Server (`ws-server/server/index.ts`)

**ะัะฒะตัััะฒะตะฝะฝะพััั:** ะะปะฐะฒะฝัะน HTTP/WebSocket ัะตัะฒะตั.

**ะะปััะตะฒัะต ัะฐััะธ:**

```typescript
// ะะฟัะตะดะตะปะตะฝะธะต ัะตะถะธะผะฐ ัะฐะฑะพัั
const SERVER_MODE = process.env.SERVER_MODE // 'ws' | 'rtmp' | undefined

// ะฃัะปะพะฒะฝะพะต ัะพะทะดะฐะฝะธะต WebSocket ัะตัะฒะตัะพะฒ
if (SERVER_MODE !== 'rtmp') {
  wss = new WebSocketServer({
    noServer: true,
    perMessageDeflate: false, // ะะฐะถะฝะพ ะดะปั Railway proxy
  })
}

// ะะฑัะฐะฑะพัะบะฐ upgrade ะทะฐะฟัะพัะพะฒ
server.on('upgrade', (req, socket, head) => {
  // ะะฐะปะธะดะฐัะธั ัะพะบะตะฝะฐ
  const authResult = validateTokenAndSession(token, sessionSlug)
  
  // Upgrade ะบ WebSocket
  wss.handleUpgrade(req, socket, head, (ws) => {
    wss.emit('connection', ws, req)
  })
})

// Endpoint ะดะปั ะทะฐะฟััะบะฐ ััะฐะฝัะบัะธะฟัะธะธ
if (pathname?.startsWith('/api/transcription/start')) {
  // ะัะธะฝััะพะฝะฝัะน ะทะฐะฟััะบ (ะฝะต ะฑะปะพะบะธััะตะผ ะพัะฒะตั)
  startServerTranscription({ sessionId, sessionSlug })
}
```

**ะคะฐะนะป:** `ws-server/server/index.ts`

---

### 2. LiveKit Transcriber (`ws-server/server/livekit-transcriber.ts`)

**ะัะฒะตัััะฒะตะฝะฝะพััั:** ะฃะฟัะฐะฒะปะตะฝะธะต ัะตัะฒะตัะฝะพะน ััะฐะฝัะบัะธะฟัะธะตะน ัะตัะตะท LiveKit Egress.

**ะะปััะตะฒัะต ัะฐััะธ:**

```typescript
export async function startServerTranscription(
  options: StartServerTranscriptionOptions
): Promise<ServerTranscriber> {
  const { sessionId, sessionSlug } = options
  
  // ะัะฟะพะปัะทัะตะผ Room Composite Egress (ะฟัะตะดะฟะพััะธัะตะปัะฝะพ)
  const { startRoomCompositeTranscription } = await import('./livekit-room-composite-transcriber.js')
  
  const transcriber = await startRoomCompositeTranscription({
    sessionId,
    sessionSlug,
    rtmpHost: process.env.RTMP_HOST || 'localhost',
    rtmpPort: parseInt(process.env.RTMP_EXTERNAL_PORT || '1937', 10),
  })
  
  return transcriber
}
```

**ะคะฐะนะป:** `ws-server/server/livekit-transcriber.ts`

---

### 3. Room Composite Transcriber (`ws-server/server/livekit-room-composite-transcriber.ts`)

**ะัะฒะตัััะฒะตะฝะฝะพััั:** ะะฐะฟััะบ LiveKit Room Composite Egress ะธ ัะพะทะดะฐะฝะธะต RTMP Ingest.

**ะะปััะตะฒัะต ัะฐััะธ:**

```typescript
export async function startRoomCompositeTranscription(
  options: StartRoomCompositeTranscriptionOptions
): Promise<RoomCompositeTranscriber> {
  const { sessionId, sessionSlug, rtmpHost, rtmpPort } = options
  
  const egressClient = new EgressClient(
    livekitConfig.httpUrl,
    livekitConfig.apiKey,
    livekitConfig.apiSecret
  )
  
  // RTMP URL ะดะปั ะฟัะธะตะผะฐ ะฟะพัะพะบะฐ
  const rtmpUrl = `rtmp://${rtmpHost}:${rtmpPort}/live/${sessionSlug}`
  
  // ะกะพะทะดะฐะตะผ RTMP Ingest (ะตัะปะธ ะฝะต ะฒ split mode)
  const isSplitMode = process.env.SERVER_MODE === 'ws'
  let rtmpIngest: RTMPIngest | null = null
  
  if (!isSplitMode) {
    rtmpIngest = await createRTMPIngest({
      sessionId,
      sessionSlug,
      rtmpPort: internalPort,
    })
  }
  
  // ะะฐะฟััะบะฐะตะผ Room Composite Egress
  const streamOutput = new StreamOutput({
    protocol: StreamProtocol.RTMP,
    urls: [rtmpUrl],
  })
  
  const egressInfo = await egressClient.startRoomCompositeEgress(
    sessionSlug,
    streamOutput,
    { audioOnly: true }
  )
  
  return new RoomCompositeTranscriberImpl(...)
}
```

**ะคะฐะนะป:** `ws-server/server/livekit-room-composite-transcriber.ts`

---

### 4. RTMP Ingest (`ws-server/server/rtmp-ingest.ts`)

**ะัะฒะตัััะฒะตะฝะฝะพััั:** ะัะธะตะผ RTMP ะฟะพัะพะบะฐ, ะดะตะบะพะดะธัะพะฒะฐะฝะธะต ัะตัะตะท FFmpeg, ะพัะฟัะฐะฒะบะฐ ะฒ Gladia.

**ะะปััะตะฒัะต ัะฐััะธ:**

```typescript
class RTMPIngestImpl {
  private async startFFmpegDecoder(): Promise<void> {
    // FFmpeg ะบะพะผะฐะฝะดะฐ ะดะปั ะดะตะบะพะดะธัะพะฒะฐะฝะธั RTMP โ PCM16
    const ffmpegArgs = [
      '-rtmp_live', 'live',
      '-i', this.rtmpUrl, // RTMP ะฟะพัะพะบ
      '-vn', // ะัะบะปััะฐะตะผ ะฒะธะดะตะพ
      '-acodec', 'pcm_s16le', // PCM16
      '-ar', '16000', // 16kHz
      '-ac', '1', // ะะพะฝะพ
      '-f', 's16le', // Raw PCM16
      'pipe:1', // ะัะฒะพะด ะฒ stdout
    ]
    
    this.ffmpegProcess = spawn('ffmpeg', ffmpegArgs)
    
    // ะงัะตะฝะธะต PCM16 ะดะฐะฝะฝัั ะธะท stdout
    this.ffmpegProcess.stdout.on('data', (chunk: Buffer) => {
      if (this.gladiaBridge && chunk.length > 0) {
        this.gladiaBridge.sendAudio(chunk)
      }
    })
  }
  
  private handleTranscript(event: TranscriptEvent): void {
    // ะะพะปััะฐะตะผ ะฐะบัะธะฒะฝะพะณะพ ัะฟะธะบะตัะฐ
    const activeSpeaker = getActiveSpeaker(this.config.sessionSlug)
    const speakerIdentity = activeSpeaker?.identity || event.speakerId || 'room'
    
    // ะัะฟัะฐะฒะปัะตะผ ััะฐะฝัะบัะธะฟั ะฒ WebSocket ัะตัะฒะตั
    this.sendTranscriptToWebSocketServer(this.config.sessionSlug, {
      sessionSlug: this.config.sessionSlug,
      utteranceId: event.utteranceId,
      text: event.text,
      isFinal: event.isFinal,
      speaker: speakerIdentity,
      speakerId: speakerIdentity,
      ts: Date.now(),
    })
    
    // ะกะพััะฐะฝัะตะผ ัะธะฝะฐะปัะฝัะต ััะฐะฝัะบัะธะฟัั ะฒ ะะ
    if (event.isFinal) {
      appendTranscriptChunk({...})
    }
  }
}
```

**ะคะฐะนะป:** `ws-server/server/rtmp-ingest.ts`

---

### 5. Gladia Bridge (`ws-server/server/gladia-bridge.ts`)

**ะัะฒะตัััะฒะตะฝะฝะพััั:** ะะฑัััะบะฐ ะฝะฐะด Gladia Live v2 WebSocket API.

**ะะปััะตะฒัะต ัะฐััะธ:**

```typescript
export async function createGladiaBridge(): Promise<GladiaBridge> {
  const apiKey = getGladiaApiKey()
  
  // ะะฝะธัะธะฐะปะธะทะฐัะธั ัะตััะธะธ ัะตัะตะท POST /v2/live
  const websocketUrl = await initGladiaSession(apiKey)
  
  // ะะพะดะบะปััะตะฝะธะต ะบ WebSocket
  const gladiaWs = new WebSocket(websocketUrl)
  
  gladiaWs.on('message', (data: Buffer | string) => {
    const message: GladiaMessage = JSON.parse(data.toString())
    
    // ะะฐััะธะผ ััะฐะฝัะบัะธะฟัั
    const transcriptEvent = parseTranscriptMessage(message)
    
    if (transcriptEvent && transcriptCallback) {
      transcriptCallback(transcriptEvent)
    }
  })
  
  return {
    sendAudio(chunk: ArrayBuffer | Buffer) {
      if (isReady && gladiaWs.readyState === WebSocket.OPEN) {
        gladiaWs.send(chunk)
      }
    },
    onTranscript(cb: (event: TranscriptEvent) => void) {
      transcriptCallback = cb
    },
    close() {
      gladiaWs.close()
    },
  }
}
```

**ะคะฐะนะป:** `ws-server/server/gladia-bridge.ts`

---

### 6. Client Connection (`ws-server/server/client-connection.ts`)

**ะัะฒะตัััะฒะตะฝะฝะพััั:** ะฃะฟัะฐะฒะปะตะฝะธะต ะบะปะธะตะฝััะบะธะผะธ WebSocket ะฟะพะดะบะปััะตะฝะธัะผะธ.

**ะะปััะตะฒัะต ัะฐััะธ:**

```typescript
// ะฅัะฐะฝะธะปะธัะต ะบะปะธะตะฝัะพะฒ ะฟะพ ัะตััะธัะผ
const sessionClients = new Map<string, Set<WsClientMeta>>()

export function registerClientForSession(
  sessionSlug: string,
  ws: WebSocket,
  meta?: { userId?: string }
): void {
  const clientMeta: WsClientMeta = {
    ws,
    sessionSlug,
    userId: meta?.userId,
    connectedAt: Date.now(),
  }
  
  const clients = sessionClients.get(sessionSlug) || new Set()
  clients.add(clientMeta)
  sessionClients.set(sessionSlug, clients)
}

export function broadcastToSessionClients(
  sessionSlug: string,
  payload: any
): void {
  const clients = sessionClients.get(sessionSlug)
  if (!clients || clients.size === 0) {
    return
  }
  
  const message = JSON.stringify(payload)
  
  for (const clientMeta of clients) {
    if (clientMeta.ws.readyState === WebSocket.OPEN) {
      clientMeta.ws.send(message)
    }
  }
}
```

**ะคะฐะนะป:** `ws-server/server/client-connection.ts`

---

### 7. Active Speaker Tracker (`ws-server/server/active-speaker-tracker.ts`)

**ะัะฒะตัััะฒะตะฝะฝะพััั:** ะััะปะตะถะธะฒะฐะฝะธะต ะฐะบัะธะฒะฝัั ัะฟะธะบะตัะพะฒ ะดะปั ะบะฐะถะดะพะน ัะตััะธะธ.

**ะะปััะตะฒัะต ัะฐััะธ:**

```typescript
// ะฅัะฐะฝะธะปะธัะต ะฐะบัะธะฒะฝัั ัะฟะธะบะตัะพะฒ
const activeSpeakers = new Map<string, {
  identity: string
  name?: string
  timestamp: number
}>()

export function updateActiveSpeaker(event: ActiveSpeakerEvent): void {
  const { sessionSlug, participantIdentity, participantName, timestamp } = event
  
  // ะะฑะฝะพะฒะปัะตะผ ัะพะปัะบะพ ะตัะปะธ ััะพ ะฑะพะปะตะต ัะฒะตะถะตะต ัะพะฑััะธะต
  const current = activeSpeakers.get(sessionSlug)
  if (!current || timestamp > current.timestamp) {
    activeSpeakers.set(sessionSlug, {
      identity: participantIdentity,
      name: participantName,
      timestamp,
    })
  }
}

export function getActiveSpeaker(sessionSlug: string): {
  identity: string
  name?: string
  timestamp: number
} | null {
  return activeSpeakers.get(sessionSlug) || null
}
```

**ะคะฐะนะป:** `ws-server/server/active-speaker-tracker.ts`

---

## ะขะตะบััะธะต ะฟัะพะฑะปะตะผั ะธ ัะตัะตะฝะธั

### ๐ด ะัะพะฑะปะตะผะฐ 1: WebSocket ะทะฐะบััะฒะฐะตััั ััะฐะทั ะฟะพัะปะต ะฟะพะดะบะปััะตะฝะธั

#### ะกะธะผะฟัะพะผั:

1. **WebSocket ะฟะพะดะบะปััะตะฝะธะต ัััะฐะฝะฐะฒะปะธะฒะฐะตััั ััะฟะตัะฝะพ:**
   ```
   โ WebSocket connection established
   โ Initial message sent to client
   ```

2. **ะะพ ััะฐะทั ะทะฐะบััะฒะฐะตััั:**
   ```
   โ Client disconnected
   code: 1006 (Abnormal Closure)
   reason: 'no reason'
   ```

3. **ะัะธะฑะบะฐ ะฒ ะฑัะฐัะทะตัะต:**
   ```
   WebSocket connection to 'wss://ws-production-dbcc.up.railway.app/...' 
   failed: Invalid frame header
   ```

#### ะงัะพ ะฟัะพะธััะพะดะธั:

1. **Handshake ะฟัะพัะพะดะธั ััะฟะตัะฝะพ:**
   - ะัะฐัะทะตั ะพัะฟัะฐะฒะปัะตั HTTP ะทะฐะฟัะพั ั ะทะฐะณะพะปะพะฒะบะฐะผะธ `Upgrade: websocket`
   - Railway ะฟัะพะบัะธััะตั ะทะฐะฟัะพั ะฒ WebSocket ัะตัะฒะตั
   - ะกะตัะฒะตั ะพัะฒะตัะฐะตั `101 Switching Protocols`
   - ะกะพะตะดะธะฝะตะฝะธะต ัััะฐะฝะฐะฒะปะธะฒะฐะตััั (`readyState: 1`)

2. **ะกะตัะฒะตั ะพัะฟัะฐะฒะปัะตั initial message:**
   - ะัะฟัะฐะฒะปัะตััั JSON ัะพะพะฑัะตะฝะธะต: `{"type": "connected", ...}`
   - ะะพ ะฑัะฐัะทะตั ะฟะพะปััะฐะตั "Invalid frame header"

3. **ะกะพะตะดะธะฝะตะฝะธะต ะทะฐะบััะฒะฐะตััั:**
   - ะัะฐัะทะตั ะทะฐะบััะฒะฐะตั ัะพะตะดะธะฝะตะฝะธะต (ะบะพะด 1006 = Abnormal Closure)
   - ะญัะพ ะพะทะฝะฐัะฐะตั, ััะพ close frame ะฝะต ะฑัะป ะฟะพะปััะตะฝ ะฝะพัะผะฐะปัะฝะพ

#### ะะธะฟะพัะตะทั:

1. **Railway proxy ะผะพะดะธัะธัะธััะตั WebSocket ะฟะพัะพะบ**
   - Railway ะผะพะถะตั ัะถะธะผะฐัั/ะผะพะดะธัะธัะธัะพะฒะฐัั ะดะฐะฝะฝัะต
   - **ะะตัะตะฝะธะต:** ะัะบะปััะธะปะธ `perMessageDeflate: false`

2. **ะกะปะธัะบะพะผ ัะฐะฝะฝัั ะพัะฟัะฐะฒะบะฐ ัะพะพะฑัะตะฝะธั**
   - ะกะพะพะฑัะตะฝะธะต ะพัะฟัะฐะฒะปัะตััั ะดะพ ะฟะพะปะฝะพะณะพ ะทะฐะฒะตััะตะฝะธั upgrade
   - **ะะตัะตะฝะธะต:** ะะดะตะผ ัะพะฑััะธั `'open'` ะฟะตัะตะด ะพัะฟัะฐะฒะบะพะน

3. **Railway proxy ะทะฐะบััะฒะฐะตั "ะฟััััะต" ัะพะตะดะธะฝะตะฝะธั**
   - Proxy ะผะพะถะตั ะทะฐะบััะฒะฐัั ัะพะตะดะธะฝะตะฝะธั, ะบะพัะพััะต ะฝะต ะพะฑะผะตะฝะธะฒะฐัััั ะดะฐะฝะฝัะผะธ ะฑััััะพ
   - **ะะตัะตะฝะธะต:** ะัะฟัะฐะฒะปัะตะผ initial message ััะฐะทั ะฟะพัะปะต ะฟะพะดะบะปััะตะฝะธั

4. **HTTP ะพะฑัะฐะฑะพััะธะบ ะฟะตัะตัะฒะฐััะฒะฐะตั WebSocket ะทะฐะฟัะพัั**
   - ะะพะทะผะพะถะฝะพ, HTTP endpoint ะฟััะฐะตััั ะพะฑัะฐะฑะพัะฐัั WebSocket ะทะฐะฟัะพั
   - **ะะตัะตะฝะธะต:** ะัะฟะพะปัะทัะตะผ `noServer: true` ะธ ัะฒะฝัั ะพะฑัะฐะฑะพัะบั upgrade

#### ะงัะพ ะฟัะพะฒะตัะตะฝะพ:

- โ Upgrade ะทะฐะฟัะพั ะดะพัะพะดะธั ะดะพ ัะตัะฒะตัะฐ (ะปะพะณะธ ะฟะพะบะฐะทัะฒะฐัั `Upgrade request received`)
- โ WebSocket ัะพะตะดะธะฝะตะฝะธะต ัััะฐะฝะฐะฒะปะธะฒะฐะตััั (`readyState: 1` ะฒ ะปะพะณะฐั)
- โ Initial message ะพัะฟัะฐะฒะปัะตััั (ะปะพะณะธ ะฟะพะบะฐะทัะฒะฐัั `Initial message sent`)
- โ ะะพ ััะฐะทั ะฟะพัะปะต ััะพะณะพ ัะพะตะดะธะฝะตะฝะธะต ะทะฐะบััะฒะฐะตััั (`code: 1006`)

#### ะะตะฐะปะธะทะพะฒะฐะฝะฝัะต ะธัะฟัะฐะฒะปะตะฝะธั:

1. **ะะถะธะดะฐะฝะธะต ัะพะฑััะธั 'open':**
   ```typescript
   // ws-server/server/ws-handlers.ts
   ws.once('open', () => {
     if (ws.readyState === WebSocket.OPEN) {
       const message = JSON.stringify({
         type: 'connected',
         sessionSlug,
         message: 'WebSocket connection established',
         ts: Date.now(),
       })
       ws.send(message)
     }
   })
   ```

2. **ะัะบะปััะตะฝะธะต perMessageDeflate:**
   ```typescript
   // ws-server/server/index.ts
   wss = new WebSocketServer({
     noServer: true,
     perMessageDeflate: false, // ะะฐะถะฝะพ ะดะปั Railway proxy
   })
   ```

3. **ะฏะฒะฝะฐั ะพะฑัะฐะฑะพัะบะฐ upgrade:**
   ```typescript
   // ws-server/server/index.ts
   server.on('upgrade', (req, socket, head) => {
     // ะะฐะปะธะดะฐัะธั ัะพะบะตะฝะฐ ะะ upgrade
     const authResult = validateTokenAndSession(token, sessionSlug)
     if (!authResult.ok) {
       socket.write('HTTP/1.1 401 Unauthorized\r\n\r\n')
       socket.destroy()
       return
     }
     
     // ะะตัะตะดะฐะตะผ ัะฟัะฐะฒะปะตะฝะธะต WebSocketServer
     wss.handleUpgrade(req, socket, head, (ws) => {
       wss.emit('connection', ws, req)
     })
   })
   ```

4. **Ping/pong ะดะปั ะฟะพะดะดะตัะถะฐะฝะธั ัะพะตะดะธะฝะตะฝะธั:**
   ```typescript
   // ws-server/server/ws-handlers.ts
   const pingInterval = setInterval(() => {
     if (ws.readyState === WebSocket.OPEN) {
       ws.ping()
     }
   }, 30000) // ะะฐะถะดัะต 30 ัะตะบัะฝะด
   ```

#### ะงัะพ ะฝัะถะฝะพ ะฟัะพะฒะตัะธัั ะดะฐะปััะต:

1. **ะะพะณะธ Railway ะฟัะธ ะทะฐะบัััะธะธ:**
   - ะงัะพ ะธะผะตะฝะฝะพ ะพัะฟัะฐะฒะปัะตััั ะฟะตัะตะด ะทะฐะบัััะธะตะผ?
   - ะััั ะปะธ ะพัะธะฑะบะธ ะฒ ะปะพะณะฐั ัะตัะฒะตัะฐ?

2. **ะขะตัั ัะตัะตะท `wscat`:**
   ```bash
   npx wscat -c "wss://ws-production-dbcc.up.railway.app/api/realtime/transcribe?token=..."
   ```
   - ะัะปะธ `wscat` ัะพะถะต ะฟะฐะดะฐะตั โ ะฟัะพะฑะปะตะผะฐ ะฝะฐ ัะตัะฒะตัะต
   - ะัะปะธ ัะฐะฑะพัะฐะตั โ ะฟัะพะฑะปะตะผะฐ ะฒ ะฑัะฐัะทะตัะต ะธะปะธ CORS

3. **ะัะพะฒะตัะบะฐ HTTP endpoint:**
   ```bash
   curl -i "https://ws-production-dbcc.up.railway.app/api/realtime/transcribe"
   ```
   - ะัะปะธ ะฒะพะทะฒัะฐัะฐะตั HTTP (ะฝะต ะพัะธะฑะบั 426) โ endpoint ะพะฑัะฐะฑะฐััะฒะฐะตััั ะบะฐะบ HTTP

---

### โ๏ธ ะัะพะฑะปะตะผะฐ 2: ะะฐะทะดะตะปะตะฝะธะต ัะตัะฒะธัะพะฒ (WebSocket ะธ RTMP)

#### ะะพะฝัะตะบัั:

ะะตัะฒะพะฝะฐัะฐะปัะฝะพ WebSocket ัะตัะฒะตั ะธ RTMP ัะตัะฒะตั ัะฐะฑะพัะฐะปะธ ะฒ ะพะดะฝะพะผ ะฟัะพัะตััะต, ััะพ ะฒัะทัะฒะฐะปะพ ะบะพะฝัะปะธะบัั ะฟะพััะพะฒ ะฒ Railway:
- Railway ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฝะฐะทะฝะฐัะฐะป ะฟะพัั ะดะปั HTTP/WebSocket
- ะญัะพั ะฟะพัั ะธะฝะพะณะดะฐ ัะพะฒะฟะฐะดะฐะป ั RTMP ะฟะพััะพะผ (1937)
- ะ ัะตะทัะปััะฐัะต RTMP ัะตัะฒะตั ะฝะต ะผะพะณ ะทะฐะฟัััะธัััั ะธะปะธ HTTP ัะตัะฒะตั ะทะฐะฝะธะผะฐะป ะฝะตะฟัะฐะฒะธะปัะฝัะน ะฟะพัั

#### ะะตัะตะฝะธะต:

ะะฐะทะดะตะปะธะปะธ ะฝะฐ ะดะฒะฐ ะฝะตะทะฐะฒะธัะธะผัั ัะตัะฒะธัะฐ ั ัะตัะบะธะผ ัะฐะทะดะตะปะตะฝะธะตะผ ะพัะฒะตัััะฒะตะฝะฝะพััะธ:

1. **WebSocket Server** (`SERVER_MODE=ws`)
   - ะขะพะปัะบะพ HTTP/WebSocket endpoints
   - ะฃะฟัะฐะฒะปะตะฝะธะต ะบะปะธะตะฝััะบะธะผะธ ะฟะพะดะบะปััะตะฝะธัะผะธ
   - Broadcast ััะฐะฝัะบัะธะฟัะพะฒ
   - ะะฐะฟััะบ ััะฐะฝัะบัะธะฟัะธะธ (ะฒัะทะพะฒ LiveKit Egress API)

2. **RTMP Server** (`SERVER_MODE=rtmp`)
   - ะขะพะปัะบะพ RTMP ัะตัะฒะตั (ะฟะพัั 1937 ัะตัะตะท TCP Proxy)
   - ะัะธะตะผ RTMP ะฟะพัะพะบะพะฒ ะพั LiveKit Egress
   - ะะตะบะพะดะธัะพะฒะฐะฝะธะต ัะตัะตะท FFmpeg
   - ะขัะฐะฝัะบัะธะฟัะธั ัะตัะตะท Gladia
   - ะัะฟัะฐะฒะบะฐ ััะฐะฝัะบัะธะฟัะพะฒ ะฒ WebSocket ัะตัะฒะตั ัะตัะตะท HTTP

#### ะะตะถัะตัะฒะธัะฝะฐั ัะฒัะทั:

**RTMP โ WebSocket (HTTP POST):**
```typescript
// ws-server/server/rtmp-ingest.ts
const wsServerUrl = process.env.WS_SERVER_URL
const postData = JSON.stringify({
  sessionSlug,
  utteranceId,
  text,
  isFinal,
  speaker,
  speakerId,
  ts: Date.now(),
})

const req = http.request({
  hostname: new URL(wsServerUrl).hostname,
  port: new URL(wsServerUrl).port || 443,
  path: '/api/realtime/transcribe/broadcast',
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${RTMP_SERVER_SECRET}`, // ะะฟัะธะพะฝะฐะปัะฝะพ
  },
})

req.write(postData)
req.end()
```

**WebSocket Server (ะฟัะธะตะผ ััะฐะฝัะบัะธะฟัะพะฒ):**
```typescript
// ws-server/server/index.ts
if (pathname === '/api/realtime/transcribe/broadcast' && req.method === 'POST') {
  // ะัะพะฒะตัะบะฐ ะฐะฒัะพัะธะทะฐัะธะธ (ะพะฟัะธะพะฝะฐะปัะฝะพ)
  const authHeader = req.headers.authorization
  if (expectedSecret && authHeader !== `Bearer ${expectedSecret}`) {
    res.statusCode = 401
    return
  }
  
  // Broadcast ััะฐะฝัะบัะธะฟัะฐ ะบะปะธะตะฝัะฐะผ
  broadcastToSessionClients(sessionSlug, payload)
}
```

---

## ะะพัะพะบ ะดะฐะฝะฝัั (ะดะตัะฐะปัะฝะพ)

### ะะพะปะฝัะน ัะธะบะป ััะฐะฝัะบัะธะฟัะธะธ

```
1. ะะปะธะตะฝั ะฟะพะดะบะปััะฐะตััั ะบ LiveKit ะบะพะผะฝะฐัะต
   โโ Room.connect(serverUrl, token)
   โโ localParticipant ะดะพัััะฟะตะฝ

2. ะะปะธะตะฝั ะฟะพะดะบะปััะฐะตััั ะบ WebSocket ัะตัะฒะตัั
   โโ WebSocket.connect(ws://ws-service/api/realtime/transcribe?token=<JWT>)
   โโ ะะปะธะตะฝั ะทะฐัะตะณะธัััะธัะพะฒะฐะฝ ะดะปั ัะตััะธะธ

3. ะะปะธะตะฝั ะทะฐะฟััะบะฐะตั ััะฐะฝัะบัะธะฟัะธั
   โโ POST /api/transcription/start
   โโ WebSocket Server ะฒัะทัะฒะฐะตั startServerTranscription()

4. WebSocket Server ะทะฐะฟััะบะฐะตั LiveKit Egress
   โโ startRoomCompositeTranscription()
   โโ EgressClient.startRoomCompositeEgress()
   โโ LiveKit ะฝะฐัะธะฝะฐะตั ัััะธะผะธัั RTMP

5. RTMP Server ะฟัะธะฝะธะผะฐะตั ะฟะพัะพะบ
   โโ RTMP ัะตัะฒะตั ะฟะพะปััะฐะตั ะฟะพัะพะบ ะฝะฐ rtmp://localhost:1937/live/{sessionSlug}
   โโ onStreamStart callback
   โโ ะะฐะฟััะบะฐะตััั FFmpeg decoder

6. FFmpeg ะดะตะบะพะดะธััะตั ะฐัะดะธะพ
   โโ RTMP โ PCM16 (16kHz, mono)
   โโ ะัะฒะพะด ะฒ stdout

7. RTMP Ingest ะพัะฟัะฐะฒะปัะตั ะฒ Gladia
   โโ ะงัะตะฝะธะต PCM16 ะธะท FFmpeg stdout
   โโ GladiaBridge.sendAudio(chunk)
   โโ Gladia WebSocket ะฟะพะปััะฐะตั ะฐัะดะธะพ

8. Gladia ะพะฑัะฐะฑะฐััะฒะฐะตั ะฐัะดะธะพ
   โโ ะะฐัะฟะพะทะฝะฐะฒะฐะฝะธะต ัะตัะธ (STT)
   โโ ะะตะฝะตัะฐัะธั partial/final ััะฐะฝัะบัะธะฟัะพะฒ
   โโ ะัะฟัะฐะฒะบะฐ ััะฐะฝัะบัะธะฟัะพะฒ ะพะฑัะฐัะฝะพ

9. RTMP Server ะฟะพะปััะฐะตั ััะฐะฝัะบัะธะฟัั
   โโ GladiaBridge.onTranscript callback
   โโ handleTranscript() ะฟะพะปััะฐะตั ะฐะบัะธะฒะฝะพะณะพ ัะฟะธะบะตัะฐ
   โโ ะัะฟัะฐะฒะบะฐ ะฒ WebSocket ัะตัะฒะตั ัะตัะตะท HTTP POST

10. WebSocket Server broadcast ััะฐะฝัะบัะธะฟัะพะฒ
    โโ POST /api/realtime/transcribe/broadcast
    โโ broadcastToSessionClients()
    โโ ะัะต ะบะปะธะตะฝัั ัะตััะธะธ ะฟะพะปััะฐัั ััะฐะฝัะบัะธะฟั

11. ะะปะธะตะฝัั ะพัะพะฑัะฐะถะฐัั ััะฐะฝัะบัะธะฟัั
    โโ WebSocket.onmessage
    โโ ะะฑะฝะพะฒะปะตะฝะธะต UI

12. ะกะพััะฐะฝะตะฝะธะต ะฒ ะะ (ัะพะปัะบะพ final)
    โโ appendTranscriptChunk()
    โโ upsert TranscriptSegment
```

---

## ะะตะทัะผะต

### ะงัะพ ัะฐะฑะพัะฐะตั:

โ **Server-Side ััะฐะฝัะบัะธะฟัะธั:**
- ะะดะธะฝ ะฟะพัะพะบ ััะฐะฝัะบัะธะฟัะธะธ ะฝะฐ ัะตััะธั (ะฝะต ะฝะฐ ััะฐััะฝะธะบะฐ)
- ะะธะบัะธัะพะฒะฐะฝะธะต ะฐัะดะธะพ ะฝะฐ ััะพัะพะฝะต LiveKit
- ะฆะตะฝััะฐะปะธะทะพะฒะฐะฝะฝะฐั ะพะฑัะฐะฑะพัะบะฐ ัะตัะตะท RTMP โ FFmpeg โ Gladia

โ **ะะฐะทะดะตะปะตะฝะธะต ัะตัะฒะธัะพะฒ:**
- WebSocket Server ะธ RTMP Server ัะฐะฑะพัะฐัั ะฝะตะทะฐะฒะธัะธะผะพ
- ะะตะถัะตัะฒะธัะฝะฐั ัะฒัะทั ัะตัะตะท HTTP API
- ะะตะทะพะฟะฐัะฝะพััั ัะตัะตะท shared secret

โ **ะะฟัะตะดะตะปะตะฝะธะต ะฐะบัะธะฒะฝะพะณะพ ัะฟะธะบะตัะฐ:**
- Active-speaker-tracker ะธะท LiveKit (ะพัะฝะพะฒะฝะพะน ะธััะพัะฝะธะบ)
- Gladia speakerId ะบะฐะบ fallback (ัะพัั Gladia Live v2 ะฝะต ะดะฐะตั ะฟะพะปะฝะพัะตะฝะฝะพะน diarization)

โ **ะกะพััะฐะฝะตะฝะธะต ััะฐะฝัะบัะธะฟัะพะฒ:**
- ะขะพะปัะบะพ ัะธะฝะฐะปัะฝัะต ััะฐะฝัะบัะธะฟัั ัะพััะฐะฝััััั ะฒ ะะ
- Partial ััะฐะฝัะบัะธะฟัั ัะพะปัะบะพ ะดะปั real-time ะพัะพะฑัะฐะถะตะฝะธั

### ะขะตะบััะธะต ะฟัะพะฑะปะตะผั:

โ๏ธ **WebSocket ะทะฐะบััะฒะฐะตััั ััะฐะทั ะฟะพัะปะต ะฟะพะดะบะปััะตะฝะธั:**
- ะัะธะฑะบะฐ "Invalid frame header" ะฒ ะฑัะฐัะทะตัะต
- ะกะพะตะดะธะฝะตะฝะธะต ะทะฐะบััะฒะฐะตััั ั ะบะพะดะพะผ 1006 (Abnormal Closure)
- ะะพะทะผะพะถะฝะฐั ะฟัะธัะธะฝะฐ: Railway proxy ะผะพะดะธัะธัะธััะตั WebSocket ะฟะพัะพะบ
- ะะตะฐะปะธะทะพะฒะฐะฝั ะธัะฟัะฐะฒะปะตะฝะธั (ะพะถะธะดะฐะฝะธะต 'open', ะพัะบะปััะตะฝะธะต perMessageDeflate)

### ะกะปะตะดัััะธะต ัะฐะณะธ:

1. **ะัะพะฒะตัะธัั ะธัะฟัะฐะฒะปะตะฝะธั WebSocket:**
   - ะขะตัั ัะตัะตะท `wscat`
   - ะัะพะฒะตัะบะฐ ะปะพะณะพะฒ Railway ะฟัะธ ะทะฐะบัััะธะธ
   - ะัะพะฒะตัะบะฐ HTTP endpoint

2. **ะะพะฝะธัะพัะธะฝะณ:**
   - ะััะปะตะถะธะฒะฐะฝะธะต ะผะตััะธะบ WebSocket ัะตัะฒะตัะฐ
   - ะะปะตััั ะฟัะธ ะฟัะตะฒััะตะฝะธะธ ะปะธะผะธัะพะฒ
   - ะะพะณะธัะพะฒะฐะฝะธะต ะพัะธะฑะพะบ

3. **ะะฟัะธะผะธะทะฐัะธั:**
   - Batch insert ะดะปั ััะฐะฝัะบัะธะฟัะพะฒ ะฒ ะะ
   - ะััะธัะพะฒะฐะฝะธะต ััะฐัะธััะธะบะธ
   - ะฃะปัััะตะฝะธะต ะพะฑัะฐะฑะพัะบะธ ะพัะธะฑะพะบ

---

*ะะพะบัะผะตะฝั ะพะฑะฝะพะฒะปัะฝ: 2024-12-01*

