# ะกัะฐััั ััะฐะฝัะบัะธะฟัะธะธ, ะพะฟัะตะดะตะปะตะฝะธะต ัะฟะธะบะตัะพะฒ ะธ ะฟัะพะฑะปะตะผั

**ะะฐัะฐ ะพะฑะฝะพะฒะปะตะฝะธั:** 2024-12-28  
**ะกัะฐััั:** ะ ัะฐะทัะฐะฑะพัะบะต, ัะตัะฒะตัะฝะฐั ััะฐะฝัะบัะธะฟัะธั ะฐะบัะธะฒะฝะฐ, ะฝะพ ะตััั ะฟัะพะฑะปะตะผั ั WebSocket ะฟะพะดะบะปััะตะฝะธะตะผ

---

## ะกะพะดะตัะถะฐะฝะธะต

1. [ะงัะพ ะฑัะปะพ ัะดะตะปะฐะฝะพ](#ััะพ-ะฑัะปะพ-ัะดะตะปะฐะฝะพ)
2. [ะััะธัะตะบัััะฐ ััะฐะฝัะบัะธะฟัะธะธ](#ะฐััะธัะตะบัััะฐ-ััะฐะฝัะบัะธะฟัะธะธ)
3. [ะะฟัะตะดะตะปะตะฝะธะต ัะฟะธะบะตัะพะฒ](#ะพะฟัะตะดะตะปะตะฝะธะต-ัะฟะธะบะตัะพะฒ)
4. [ะัะพะฑะปะตะผั ะธ ะธั ัะตัะตะฝะธั](#ะฟัะพะฑะปะตะผั-ะธ-ะธั-ัะตัะตะฝะธั)
5. [ะขะตะบััะฐั ะฟัะพะฑะปะตะผะฐ](#ัะตะบััะฐั-ะฟัะพะฑะปะตะผะฐ)
6. [ะะดะต ััะพ ะปะตะถะธั](#ะณะดะต-ััะพ-ะปะตะถะธั)
7. [ะกะปะตะดัััะธะต ัะฐะณะธ](#ัะปะตะดัััะธะต-ัะฐะณะธ)

---

## ะงัะพ ะฑัะปะพ ัะดะตะปะฐะฝะพ

### 1. ะะปะธะตะฝััะบะฐั ััะฐะฝัะบัะธะฟัะธั (ะฝะฐัะฐะปัะฝะฐั ัะตะฐะปะธะทะฐัะธั)

**ะะตะฐะปะธะทะพะฒะฐะฝะพ:**
- โ ะะฐะถะดัะน ััะฐััะฝะธะบ ััะฐะฝัะบัะธะฑะธััะตั ัะฒะพะน ะผะธะบัะพัะพะฝ ะฝะฐ ะบะปะธะตะฝัะต
- โ Web Audio API (AudioContext + AudioWorklet) ะดะปั ะพะฑัะฐะฑะพัะบะธ ะฐัะดะธะพ
- โ ะัะฟัะฐะฒะบะฐ PCM16 ะฐัะดะธะพ ัะฐะฝะบะพะฒ ะฝะฐ WebSocket ัะตัะฒะตั
- โ ะัะพะบัะธัะพะฒะฐะฝะธะต ัะตัะตะท WebSocket ัะตัะฒะตั ะฒ Gladia API
- โ ะะพะปััะตะฝะธะต ััะฐะฝัะบัะธะฟัะพะฒ ะธ ะฟัะฑะปะธะบะฐัะธั ัะตัะตะท LiveKit data channel
- โ ะกะพััะฐะฝะตะฝะธะต ัะธะฝะฐะปัะฝัั ััะฐะฝัะบัะธะฟัะพะฒ ะฒ ะะ
- โ ะะตััะธะบะธ ะธัะฟะพะปัะทะพะฒะฐะฝะธั ะธ ัััั ััะพะธะผะพััะธ

**ะัะพะฑะปะตะผั ะบะปะธะตะฝััะบะพะน ััะฐะฝัะบัะธะฟัะธะธ:**
- โ๏ธ N ััะฐััะฝะธะบะพะฒ = N ะบะพะฝะฝะตะบัะพะฒ ะบ Gladia (ะฒััะพะบะฐั ััะพะธะผะพััั)
- โ๏ธ ะะฐะฒะธัะธะผะพััั ะพั ะบะปะธะตะฝััะบะพะณะพ ะถะตะปะตะทะฐ
- โ๏ธ ะกะปะพะถะฝะพััั ะบะพะฝััะพะปั ะธัะฟะพะปัะทะพะฒะฐะฝะธั

### 2. ะกะตัะฒะตัะฝะฐั ััะฐะฝัะบัะธะฟัะธั (ัะตะบััะฐั ัะตะฐะปะธะทะฐัะธั)

**ะะตะฐะปะธะทะพะฒะฐะฝะพ:**
- โ LiveKit Room Composite Egress ะดะปั ะฟะพะปััะตะฝะธั ะผะธะบัะธัะพะฒะฐะฝะฝะพะณะพ ะฐัะดะธะพ ะฟะพัะพะบะฐ
- โ RTMP ัะตัะฒะตั ะดะปั ะฟัะธัะผะฐ ะฟะพัะพะบะฐ ะพั Egress
- โ FFmpeg ะดะปั ะดะตะบะพะดะธัะพะฒะฐะฝะธั RTMP ะฟะพัะพะบะฐ ะฒ PCM16
- โ ะัะฟัะฐะฒะบะฐ ะฒ Gladia (1 ะบะพะฝะฝะตะบั ะฝะฐ ัะตััะธั ะฒะผะตััะพ N)
- โ Broadcast ััะฐะฝัะบัะธะฟัะพะฒ ะฒัะตะผ ะบะปะธะตะฝัะฐะผ ัะตัะตะท WebSocket
- โ ะะฒัะพะผะฐัะธัะตัะบะธะน ะทะฐะฟััะบ ะฟัะธ ะฟะพะดะบะปััะตะฝะธะธ ััะฐััะฝะธะบะฐ
- โ ะััะฐะฝะพะฒะบะฐ ะฟัะธ ะทะฐะฒะตััะตะฝะธะธ ัะตััะธะธ

**ะัะตะธะผััะตััะฒะฐ:**
- โ 1 ะบะพะฝะฝะตะบั ะบ Gladia ะฝะฐ ัะตััะธั (ะฒะผะตััะพ N)
- โ ะกะฝะธะถะตะฝะธะต ััะพะธะผะพััะธ ะฒ 10 ัะฐะท
- โ ะะต ะทะฐะฒะธัะธั ะพั ะบะปะธะตะฝััะบะพะณะพ ะถะตะปะตะทะฐ
- โ ะฆะตะฝััะฐะปะธะทะพะฒะฐะฝะฝะพะต ัะฟัะฐะฒะปะตะฝะธะต

**ะะพะผะฟะพะฝะตะฝัั:**
- `ws-server/server/livekit-transcriber.ts` - ะณะปะฐะฒะฝัะน ะผะพะดัะปั ะทะฐะฟััะบะฐ/ะพััะฐะฝะพะฒะบะธ
- `ws-server/server/livekit-room-composite-transcriber.ts` - Room Composite Egress
- `ws-server/server/rtmp-ingest.ts` - RTMP ingest ะธ FFmpeg ะดะตะบะพะดะธัะพะฒะฐะฝะธะต
- `ws-server/server/rtmp-server.ts` - ะณะปะพะฑะฐะปัะฝัะน RTMP ัะตัะฒะตั
- `ws-server/server/client-connection.ts` - WebSocket ะดะปั broadcast ััะฐะฝัะบัะธะฟัะพะฒ

### 3. ะะฟัะตะดะตะปะตะฝะธะต ัะฟะธะบะตัะพะฒ (Active Speaker Detection)

**ะะตะฐะปะธะทะพะฒะฐะฝะพ:**
- โ ะะปะธะตะฝััะบะธะน ััะตะบะตั ะฐะบัะธะฒะฝะพะณะพ ัะฟะธะบะตัะฐ (`src/hooks/useActiveSpeakerTracker.ts`)
- โ ะัะฟัะฐะฒะบะฐ ัะพะฑััะธะน ะฝะฐ ัะตัะฒะตั ัะตัะตะท HTTP API (`/api/active-speaker`)
- โ ะกะตัะฒะตัะฝัะน ััะตะบะตั (`ws-server/server/active-speaker-tracker.ts`)
- โ ะัะฟะพะปัะทะพะฒะฐะฝะธะต ะฒ ััะฐะฝัะบัะธะฟัะฐั ะดะปั ะพะฟัะตะดะตะปะตะฝะธั ัะฟะธะบะตัะฐ

**ะะฐะบ ัะฐะฑะพัะฐะตั:**
1. ะะปะธะตะฝั ะพััะปะตะถะธะฒะฐะตั `participant.isSpeaking` ะบะฐะถะดัะต 200ms
2. ะัะธ ะธะทะผะตะฝะตะฝะธะธ ะฐะบัะธะฒะฝะพะณะพ ัะฟะธะบะตัะฐ ะพัะฟัะฐะฒะปัะตั HTTP POST ะฝะฐ `/api/active-speaker`
3. ะกะตัะฒะตั ัะพััะฐะฝัะตั ัะตะบััะตะณะพ ะฐะบัะธะฒะฝะพะณะพ ัะฟะธะบะตัะฐ ะดะปั ัะตััะธะธ
4. ะัะธ ะฟะพะปััะตะฝะธะธ ััะฐะฝัะบัะธะฟัะฐ ะพั Gladia ะธัะฟะพะปัะทัะตััั ะฐะบัะธะฒะฝัะน ัะฟะธะบะตั ะดะปั ะฐััะธะฑััะธะธ

**ะะพะผะฟะพะฝะตะฝัั:**
- `src/hooks/useActiveSpeakerTracker.ts` - ะบะปะธะตะฝััะบะธะน ััะตะบะตั
- `ws-server/server/active-speaker-tracker.ts` - ัะตัะฒะตัะฝัะน ััะตะบะตั
- `ws-server/server/index.ts` - HTTP endpoint `/api/active-speaker`

### 4. ะะฟัะธะผะธะทะฐัะธะธ

**Batch Queue ะดะปั ััะฐะฝัะบัะธะฟัะพะฒ:**
- โ `ws-server/server/transcript-batch-queue.ts`
- โ ะััะฟะฟะธัะพะฒะบะฐ ัะธะฝะฐะปัะฝัั ััะฐะฝัะบัะธะฟัะพะฒ ะฟะตัะตะด ะทะฐะฟะธััั ะฒ ะะ
- โ ะะตัะธะพะดะธัะตัะบะฐั ะทะฐะฟะธัั (ะบะฐะถะดัะต 2 ัะตะบัะฝะดั ะธะปะธ ะฟัะธ ะฝะฐะบะพะฟะปะตะฝะธะธ 10 ัะตะณะผะตะฝัะพะฒ)
- โ ะกะฝะธะถะตะฝะธะต ะฝะฐะณััะทะบะธ ะฝะฐ ะะ

**ะะตััะธะบะธ:**
- โ ะะปะธะตะฝััะบะธะต ะผะตััะธะบะธ (ะฒ ะฟะฐะผััะธ ะฑัะฐัะทะตัะฐ)
- โ ะกะตัะฒะตัะฝัะต ะผะตััะธะบะธ (`ws-server/server/metrics.ts`)
- โ ะญะฝะดะฟะพะธะฝั `/metrics` ะดะปั ะผะพะฝะธัะพัะธะฝะณะฐ
- โ ะกะพััะฐะฝะตะฝะธะต ะธัะฟะพะปัะทะพะฒะฐะฝะธั ะฒ ะะ (`TranscriptionUsage`)

---

## ะััะธัะตะบัััะฐ ััะฐะฝัะบัะธะฟัะธะธ

### ะขะตะบััะฐั ะฐััะธัะตะบัััะฐ (Server-Side)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    CLIENT (Browser)                          โ
โ                                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  SessionContent                                       โ  โ
โ  โ  - useLocalParticipantTranscription()                โ  โ
โ  โ  - useActiveSpeakerTracker()                         โ  โ
โ  โ  - useTranscriptStream()                             โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                           โ                                  โ
โ         โโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโ               โ
โ         โ                 โ                 โ               โ
โ         โผ                 โผ                 โผ               โ
โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ      โ
โ  โ LiveKit     โ  โ HTTP API     โ  โ WebSocket   โ      โ
โ  โ Room        โ  โ (active      โ  โ (receive    โ      โ
โ  โ (WebRTC)    โ  โ speaker)     โ  โ transcripts)โ      โ
โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                             โ
                             โ WebRTC
                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    LiveKit Cloud                            โ
โ              (omni-pxx5e1ko.livekit.cloud)                โ
โ                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ  Room Composite Egress                              โ โ
โ  โ  - ะะธะบัะธััะตั ะฐัะดะธะพ ะฒัะตั ััะฐััะฝะธะบะพะฒ                  โ โ
โ  โ  - ะัะฟัะฐะฒะปัะตั RTMP ะฟะพัะพะบ                             โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                             โ RTMP
                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              Railway WebSocket Server                         โ
โ         (sessions-ws-production.up.railway.app)             โ
โ                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ  RTMP Server (ะฟะพัั 1935)                             โ โ
โ  โ  - ะัะธะฝะธะผะฐะตั RTMP ะฟะพัะพะบ ะพั Egress                    โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                           โ                                  โ
โ                           โผ                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ  FFmpeg Decoder                                      โ โ
โ  โ  - ะะตะบะพะดะธััะตั RTMP โ PCM16                           โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                           โ                                  โ
โ                           โผ                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ  Gladia Bridge                                        โ โ
โ  โ  - ะัะฟัะฐะฒะปัะตั PCM16 ะฒ Gladia                         โ โ
โ  โ  - ะะพะปััะฐะตั ััะฐะฝัะบัะธะฟัั                               โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                           โ                                  โ
โ                           โผ                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ  Active Speaker Tracker                              โ โ
โ  โ  - ะะฟัะตะดะตะปัะตั ัะตะบััะตะณะพ ัะฟะธะบะตัะฐ                       โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                           โ                                  โ
โ                           โผ                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ  Broadcast to Clients                                โ โ
โ  โ  - broadcastToSessionClients()                       โ โ
โ  โ  - WebSocket ัะพะตะดะธะฝะตะฝะธั ะฟะพ sessionSlug               โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                             โ WebSocket
                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    CLIENT (Browser)                          โ
โ                                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  useLocalParticipantTranscription                    โ  โ
โ  โ  - ะะพะปััะฐะตั ััะฐะฝัะบัะธะฟัั ัะตัะตะท WebSocket             โ  โ
โ  โ  - ะัะฑะปะธะบัะตั ัะตัะตะท LiveKit data channel              โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                           โ                                  โ
โ                           โผ                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  useTranscriptStream                                 โ  โ
โ  โ  - ะัะพะฑัะฐะถะฐะตั ััะฐะฝัะบัะธะฟัั ะฒ UI                       โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ะะพัะพะบ ะดะฐะฝะฝัั

1. **ะะฝะธัะธะฐะปะธะทะฐัะธั ัะตััะธะธ:**
   - ะฃัะฐััะฝะธะบ ะฟะพะดะบะปััะฐะตััั ะบ LiveKit ะบะพะผะฝะฐัะต
   - Next.js API ะฒัะทัะฒะฐะตั `upsertParticipantOnJoin()`
   - ะะฒัะพะผะฐัะธัะตัะบะธ ะทะฐะฟััะบะฐะตััั ัะตัะฒะตัะฝะฐั ััะฐะฝัะบัะธะฟัะธั ัะตัะตะท HTTP API

2. **ะะฐะฟััะบ ัะตัะฒะตัะฝะพะน ััะฐะฝัะบัะธะฟัะธะธ:**
   - `POST /api/transcription/start` ะฝะฐ Railway WebSocket ัะตัะฒะตั
   - ะกะพะทะดะฐัััั LiveKit Room Composite Egress
   - Egress ะฝะฐัะธะฝะฐะตั ัััะธะผะธัั RTMP ะฟะพัะพะบ

3. **ะะฑัะฐะฑะพัะบะฐ RTMP ะฟะพัะพะบะฐ:**
   - RTMP ัะตัะฒะตั ะฟัะธะฝะธะผะฐะตั ะฟะพัะพะบ ะฝะฐ `rtmp://localhost:1935/live/{sessionSlug}`
   - FFmpeg ะดะตะบะพะดะธััะตั RTMP โ PCM16
   - PCM16 ะพัะฟัะฐะฒะปัะตััั ะฒ Gladia

4. **ะะพะปััะตะฝะธะต ััะฐะฝัะบัะธะฟัะพะฒ:**
   - Gladia ะฒะพะทะฒัะฐัะฐะตั ััะฐะฝัะบัะธะฟัั (partial ะธ final)
   - ะะฟัะตะดะตะปัะตััั ะฐะบัะธะฒะฝัะน ัะฟะธะบะตั ัะตัะตะท `getActiveSpeaker()`
   - ะขัะฐะฝัะบัะธะฟัั broadcast'ัััั ะฒัะตะผ ะฟะพะดะบะปััะตะฝะฝัะผ ะบะปะธะตะฝัะฐะผ ัะตัะตะท `broadcastToSessionClients()`

5. **ะะพะปััะตะฝะธะต ะฝะฐ ะบะปะธะตะฝัะต:**
   - ะะปะธะตะฝั ะฟะพะดะบะปััะฐะตััั ะบ WebSocket: `wss://sessions-ws-production.up.railway.app/api/realtime/transcribe?token=...`
   - ะะพะปััะฐะตั ััะฐะฝัะบัะธะฟัั ัะตัะตะท `ws.onmessage`
   - ะัะฑะปะธะบัะตั ัะตัะตะท LiveKit data channel ะดะปั ะดััะณะธั ััะฐััะฝะธะบะพะฒ
   - ะัะพะฑัะฐะถะฐะตั ะฒ UI ัะตัะตะท `useTranscriptStream`

---

## ะะฟัะตะดะตะปะตะฝะธะต ัะฟะธะบะตัะพะฒ

### ะะปะธะตะฝััะบะธะน ััะตะบะตั

**ะคะฐะนะป:** `src/hooks/useActiveSpeakerTracker.ts`

**ะะฐะบ ัะฐะฑะพัะฐะตั:**
1. ะััะปะตะถะธะฒะฐะตั `participant.isSpeaking` ะดะปั ะฒัะตั ััะฐััะฝะธะบะพะฒ (local + remote)
2. ะัะพะฒะตััะตั ะบะฐะถะดัะต 200ms
3. ะัะธ ะธะทะผะตะฝะตะฝะธะธ ะฐะบัะธะฒะฝะพะณะพ ัะฟะธะบะตัะฐ ะพัะฟัะฐะฒะปัะตั HTTP POST:
   ```typescript
   POST /api/active-speaker
   {
     sessionSlug: string,
     identity: string,
     name?: string,
     timestamp: number,
     token: string
   }
   ```

**ะัะพะฑะตะฝะฝะพััะธ:**
- ะะตะฑะฐัะฝั: ะฝะต ะพัะฟัะฐะฒะปัะตั ัะพะฑััะธั ัะฐัะต, ัะตะผ ัะฐะท ะฒ 500ms
- ะัะฟะพะปัะทัะตั HTTP ะฒะผะตััะพ WebSocket ะดะปั ะปัััะตะน ัะพะฒะผะตััะธะผะพััะธ ั Railway

### ะกะตัะฒะตัะฝัะน ััะตะบะตั

**ะคะฐะนะป:** `ws-server/server/active-speaker-tracker.ts`

**ะะฐะบ ัะฐะฑะพัะฐะตั:**
1. ะัะธะฝะธะผะฐะตั ัะพะฑััะธั ัะตัะตะท HTTP endpoint `/api/active-speaker`
2. ะกะพััะฐะฝัะตั ัะตะบััะตะณะพ ะฐะบัะธะฒะฝะพะณะพ ัะฟะธะบะตัะฐ ะดะปั ัะตััะธะธ ะฒ ะฟะฐะผััะธ
3. ะัะธ ะฟะพะปััะตะฝะธะธ ััะฐะฝัะบัะธะฟัะฐ ะพั Gladia ะธัะฟะพะปัะทัะตััั `getActiveSpeaker(sessionSlug)`

**ะฅัะฐะฝะตะฝะธะต:**
```typescript
Map<string, {
  identity: string,
  name?: string,
  timestamp: number
}>
```

**ะัะฟะพะปัะทะพะฒะฐะฝะธะต ะฒ ััะฐะฝัะบัะธะฟัะฐั:**
```typescript
// ะ rtmp-ingest.ts
const activeSpeaker = getActiveSpeaker(this.config.sessionSlug)
const speakerIdentity = activeSpeaker?.identity || 'room'
const speakerName = activeSpeaker?.name || 'Meeting'
```

### ะัะพะฑะปะตะผั ะพะฟัะตะดะตะปะตะฝะธั ัะฟะธะบะตัะพะฒ

**ะขะตะบััะธะต ะพะณัะฐะฝะธัะตะฝะธั:**
- โ๏ธ ะะฟัะตะดะตะปะตะฝะธะต ะพัะฝะพะฒะฐะฝะพ ะฝะฐ `isSpeaking` ะพั LiveKit (ะผะพะถะตั ะฑััั ะฝะตัะพัะฝัะผ)
- โ๏ธ ะะตั ะธะฝัะตะณัะฐัะธะธ ั Gladia speaker diarization
- โ๏ธ ะัะธ ะฝะตัะบะพะปัะบะธั ัะฟะธะบะตัะฐั ะพะดะฝะพะฒัะตะผะตะฝะฝะพ ะผะพะถะตั ะฑััั ะฝะตัะพัะฝะพััั

**ะะปะฐะฝั ะฝะฐ ะฑัะดััะตะต:**
- ะะฝัะตะณัะฐัะธั ั Gladia speaker diarization (speaker IDs)
- ะัะฟะพะปัะทะพะฒะฐะฝะธะต ะฒัะตะผะตะฝะฝัั ะผะตัะพะบ ะดะปั ะฑะพะปะตะต ัะพัะฝะพะณะพ ะผะฐะฟะฟะธะฝะณะฐ
- `ws-server/server/speaker-mapper.ts` - ะทะฐะณะพัะพะฒะบะฐ ะดะปั ะฑัะดััะตะน ัะตะฐะปะธะทะฐัะธะธ

---

## ะัะพะฑะปะตะผั ะธ ะธั ัะตัะตะฝะธั

### 1. โ ะัะพะฑะปะตะผะฐ: ะขัะฐะฝัะบัะธะฟัะธั ะฝะต ัะฐะฑะพัะฐะตั (WebSocket "Invalid frame header")

**ะะฟะธัะฐะฝะธะต:**
ะะปะธะตะฝั ะฝะต ะผะพะถะตั ะฟะพะดะบะปััะธัััั ะบ WebSocket ัะตัะฒะตัั ะฝะฐ Railway. ะัะธะฑะบะฐ: `Invalid frame header`.

**ะกะธะผะฟัะพะผั:**
```
WebSocket connection to 'wss://sessions-ws-production.up.railway.app/api/realtime/transcribe?token=...' failed: Invalid frame header
```

**ะัะธัะธะฝะฐ:**
- Railway ะผะพะถะตั ะฝะต ะฟัะพะบัะธัะพะฒะฐัั WebSocket ัะตัะตะท ััะฐะฝะดะฐััะฝัะน ะฟะพัั 443
- ะะปะธะตะฝั ะฟะพะดะบะปััะฐะตััั ะฑะตะท ัะบะฐะทะฐะฝะธั ะฟะพััะฐ, ะฝะพ ัะตัะฒะตั ัะปััะฐะตั ะฝะฐ ะฟะพััั 3001
- ะะตัะพะพัะฒะตัััะฒะธะต ะผะตะถะดั ะบะปะธะตะฝัะพะผ ะธ ัะตัะฒะตัะพะผ

**ะงัะพ ะฑัะปะพ ัะดะตะปะฐะฝะพ:**
1. โ ะัะฟัะฐะฒะปะตะฝะฐ ะปะพะณะธะบะฐ ะพะฟัะตะดะตะปะตะฝะธั ะฟะพััะฐ ะฒ `useLocalParticipantTranscription.ts`
2. โ ะัะปะธ `NEXT_PUBLIC_WS_PORT` ะทะฐะดะฐะฝ, ะธัะฟะพะปัะทัะตััั ะดะฐะถะต ะดะปั production
3. โ ะัะฟัะฐะฒะปะตะฝ ัะพัะผะฐั ัะพะพะฑัะตะฝะธะน: `isFinal` โ `is_final`
4. โ ะัะฟัะฐะฒะปะตะฝ ะฟะฐัะฐะผะตัั broadcast: `sessionId` โ `sessionSlug`
5. โ ะะปะธะตะฝั ัะตะฟะตัั ะฟะพะดะบะปััะฐะตััั ะบ WebSocket ะดะฐะถะต ะฟัะธ ัะตัะฒะตัะฝะพะน ััะฐะฝัะบัะธะฟัะธะธ (ะดะปั ะฟะพะปััะตะฝะธั ััะฐะฝัะบัะธะฟัะพะฒ)

**ะขะตะบััะธะน ััะฐััั:**
- โ๏ธ ะขัะตะฑัะตััั ะฟัะพะฒะตัะธัั, ะบะฐะบะพะน ะฟะพัั ะธัะฟะพะปัะทัะตั Railway ะดะปั WebSocket
- โ๏ธ ะะพะทะผะพะถะฝะพ, ะฝัะถะฝะพ ัััะฐะฝะพะฒะธัั `NEXT_PUBLIC_WS_PORT` ะฒ Vercel

### 2. โ ะะตัะตะฝะพ: ะะปะธะตะฝั ะฝะต ะฟะพะดะบะปััะฐะปัั ะบ WebSocket ะฟัะธ ัะตัะฒะตัะฝะพะน ััะฐะฝัะบัะธะฟัะธะธ

**ะัะพะฑะปะตะผะฐ:**
ะัะธ ะฒะบะปัััะฝะฝะพะน ัะตัะฒะตัะฝะพะน ััะฐะฝัะบัะธะฟัะธะธ ะบะปะธะตะฝั ะฟะพะปะฝะพัััั ะฟัะพะฟััะบะฐะป ะฟะพะดะบะปััะตะฝะธะต ะบ WebSocket, ัะพัั ะดะพะปะถะตะฝ ะฑัะป ะฟะพะดะบะปััะฐัััั ะดะปั ะฟะพะปััะตะฝะธั ััะฐะฝัะบัะธะฟัะพะฒ.

**ะะตัะตะฝะธะต:**
- ะะทะผะตะฝะตะฝะฐ ะปะพะณะธะบะฐ ะฒ `useLocalParticipantTranscription.ts`
- ะะปะธะตะฝั ะฒัะตะณะดะฐ ะฟะพะดะบะปััะฐะตััั ะบ WebSocket ะดะปั ะฟะพะปััะตะฝะธั ััะฐะฝัะบัะธะฟัะพะฒ
- ะัะฟัะฐะฒะบะฐ ะฐัะดะธะพ ั ะบะปะธะตะฝัะฐ ะฟัะพะฟััะบะฐะตััั ะฟัะธ `SERVER_TRANSCRIPTION_ENABLED`

### 3. โ ะะตัะตะฝะพ: ะะตะฟัะฐะฒะธะปัะฝัะน ัะพัะผะฐั ัะพะพะฑัะตะฝะธะน

**ะัะพะฑะปะตะผะฐ:**
ะกะตัะฒะตั ะพัะฟัะฐะฒะปัะป `isFinal`, ะฐ ะบะปะธะตะฝั ะพะถะธะดะฐะป `is_final`.

**ะะตัะตะฝะธะต:**
- ะัะฟัะฐะฒะปะตะฝะพ ะฒ `ws-server/server/rtmp-ingest.ts`: `isFinal` โ `is_final`

### 4. โ ะะตัะตะฝะพ: ะะตะฟัะฐะฒะธะปัะฝัะน ะฟะฐัะฐะผะตัั ะฟัะธ broadcast

**ะัะพะฑะปะตะผะฐ:**
ะกะตัะฒะตั ะธัะฟะพะปัะทะพะฒะฐะป `sessionId` ะฒะผะตััะพ `sessionSlug` ะฟัะธ ะฒัะทะพะฒะต `broadcastToSessionClients()`.

**ะะตัะตะฝะธะต:**
- ะัะฟัะฐะฒะปะตะฝะพ ะฒ `ws-server/server/rtmp-ingest.ts`: `sessionId` โ `sessionSlug`

### 5. โ๏ธ ะงะฐััะธัะฝะพ ัะตัะตะฝะพ: AudioContext suspended ะฒ Chrome

**ะัะพะฑะปะตะผะฐ:**
Chrome ะฑะปะพะบะธััะตั ะฐะฒัะพะผะฐัะธัะตัะบะธะน ะทะฐะฟััะบ AudioContext ะฑะตะท ะฟะพะปัะทะพะฒะฐัะตะปััะบะพะณะพ ะถะตััะฐ.

**ะะตัะตะฝะธะต:**
- ะะพะฑะฐะฒะปะตะฝะฐ ะฟัะพะฒะตัะบะฐ ัะพััะพัะฝะธั `audioContext.state === 'suspended'`
- ะะพะฑะฐะฒะปะตะฝั ะพะฑัะฐะฑะพััะธะบะธ `click` ะธ `touchstart` ะดะปั ะฒะพะทะพะฑะฝะพะฒะปะตะฝะธั
- โ๏ธ ะะพ ััะพ ะฝะต ะบัะธัะธัะฝะพ ะดะปั ัะตัะฒะตัะฝะพะน ััะฐะฝัะบัะธะฟัะธะธ (ะฐัะดะธะพ ะฝะต ะพะฑัะฐะฑะฐััะฒะฐะตััั ะฝะฐ ะบะปะธะตะฝัะต)

### 6. โ ะะตัะตะฝะพ: ะฃัะฐััะฝะธะบะธ ัะพะทะดะฐะฒะฐะปะธัั ัะพะปัะบะพ ะฟัะธ ะฟะตัะฒะพะผ ััะฐะฝัะบัะธะฟัะต

**ะัะพะฑะปะตะผะฐ:**
ะฃัะฐััะฝะธะบะธ ะฝะต ัะพะทะดะฐะฒะฐะปะธัั ะฒ ะะ ะดะพ ะฟะตัะฒะพะณะพ ััะฐะฝัะบัะธะฟัะฐ.

**ะะตัะตะฝะธะต:**
- ะกะพะทะดะฐะฝะธะต ััะฐััะฝะธะบะพะฒ ะฟะตัะตะฝะตัะตะฝะพ ะฒ `upsertParticipantOnJoin()`
- ะฃัะฐััะฝะธะบะธ ัะพะทะดะฐัััั ะฟัะธ ะฟะพะดะบะปััะตะฝะธะธ ะบ ะบะพะผะฝะฐัะต

### 7. โ ะะตัะตะฝะพ: Race condition ะฟัะธ ัะดะฐะปะตะฝะธะธ ัะตััะธะน

**ะัะพะฑะปะตะผะฐ:**
ะัะธ ัะดะฐะปะตะฝะธะธ ัะตััะธะธ ะฟัะพะธััะพะดะธะปะฐ race condition ะผะตะถะดั ะพะฟัะธะผะธััะธัะฝัะผ ะพะฑะฝะพะฒะปะตะฝะธะตะผ ะธ ะทะฐะณััะทะบะพะน ัะฟะธัะบะฐ.

**ะะตัะตะฝะธะต:**
- ะะพะฑะฐะฒะปะตะฝ `isDeletingRef` ะดะปั ะฑะปะพะบะธัะพะฒะบะธ ะฟะตัะตะทะฐะณััะทะบะธ ะฒะพ ะฒัะตะผั ัะดะฐะปะตะฝะธั

### 8. โ ะะตัะตะฝะพ: Foreign key constraints ะฟัะธ ัะดะฐะปะตะฝะธะธ ัะตััะธะน

**ะัะพะฑะปะตะผะฐ:**
ะัะธ ัะดะฐะปะตะฝะธะธ ัะตััะธะธ ะฒะพะทะฝะธะบะฐะปะธ ะพัะธะฑะบะธ ะธะท-ะทะฐ foreign key constraints.

**ะะตัะตะฝะธะต:**
- ะัะฟะพะปัะทัะตััั ััะฐะฝะทะฐะบัะธั Prisma ะดะปั ัะดะฐะปะตะฝะธั ะฒัะตั ัะฒัะทะฐะฝะฝัั ะทะฐะฟะธัะตะน

---

## ะขะตะบััะฐั ะฟัะพะฑะปะตะผะฐ

### ๐ด ะัะธัะธัะตัะบะฐั: WebSocket ะฟะพะดะบะปััะตะฝะธะต ะฝะต ัะฐะฑะพัะฐะตั

**ะะฟะธัะฐะฝะธะต:**
ะะปะธะตะฝั ะฝะต ะผะพะถะตั ะฟะพะดะบะปััะธัััั ะบ WebSocket ัะตัะฒะตัั ะฝะฐ Railway. ะัะธะฑะบะฐ `Invalid frame header` ัะบะฐะทัะฒะฐะตั ะฝะฐ ัะพ, ััะพ ัะตัะฒะตั ะฝะต ะฒัะฟะพะปะฝัะตั WebSocket upgrade.

**ะะพะทะผะพะถะฝัะต ะฟัะธัะธะฝั:**
1. Railway ะฝะต ะฟัะพะบัะธััะตั WebSocket ัะตัะตะท ััะฐะฝะดะฐััะฝัะน ะฟะพัั 443
2. ะัะถะตะฝ ัะฒะฝัะน ะฟะพัั ะฒ URL (ะฝะฐะฟัะธะผะตั, `:3001`)
3. Railway ััะตะฑัะตั ัะฟะตัะธะฐะปัะฝะพะน ะฝะฐัััะพะนะบะธ ะดะปั WebSocket

**ะงัะพ ะฝัะถะฝะพ ะฟัะพะฒะตัะธัั:**
1. โ ะะพะณะธะบะฐ ะพะฟัะตะดะตะปะตะฝะธั ะฟะพััะฐ ะธัะฟัะฐะฒะปะตะฝะฐ (ะธัะฟะพะปัะทัะตั `NEXT_PUBLIC_WS_PORT` ะตัะปะธ ะทะฐะดะฐะฝ)
2. โ๏ธ ะัะถะฝะพ ะฟัะพะฒะตัะธัั, ะบะฐะบะพะน ะฟะพัั ะธัะฟะพะปัะทัะตั Railway ะดะปั WebSocket
3. โ๏ธ ะะพะทะผะพะถะฝะพ, ะฝัะถะฝะพ ัััะฐะฝะพะฒะธัั `NEXT_PUBLIC_WS_PORT=3001` ะฒ Vercel
4. โ๏ธ ะัะถะฝะพ ะฟัะพะฒะตัะธัั ะปะพะณะธ Railway WebSocket ัะตัะฒะตัะฐ

**ะกะปะตะดัััะธะต ัะฐะณะธ:**
1. ะัะพะฒะตัะธัั ะปะพะณะธ Railway WebSocket ัะตัะฒะตัะฐ
2. ะัะพะฒะตัะธัั ะฝะฐัััะพะนะบะธ Railway (ะฟะพััั, ะฟัะพะบัะธัะพะฒะฐะฝะธะต)
3. ะฃััะฐะฝะพะฒะธัั `NEXT_PUBLIC_WS_PORT` ะฒ Vercel, ะตัะปะธ Railway ะธัะฟะพะปัะทัะตั ะฝะตััะฐะฝะดะฐััะฝัะน ะฟะพัั
4. ะัะพัะตััะธัะพะฒะฐัั ะฟะพะดะบะปััะตะฝะธะต ั ัะฒะฝัะผ ะฟะพััะพะผ

---

## ะะดะต ััะพ ะปะตะถะธั

### Frontend (Next.js ะฝะฐ Vercel)

**ะัะฝะพะฒะฝะพะน ัะตะฟะพะทะธัะพัะธะน:** `zerovoidrage/rooms` (ััะพั ัะตะฟะพะทะธัะพัะธะน)

**ะะปััะตะฒัะต ัะฐะนะปั:**
- `src/hooks/useLocalParticipantTranscription.ts` - ะพัะฝะพะฒะฝะพะน ััะบ ััะฐะฝัะบัะธะฟัะธะธ
- `src/hooks/useActiveSpeakerTracker.ts` - ััะตะบะตั ะฐะบัะธะฒะฝะพะณะพ ัะฟะธะบะตัะฐ
- `src/hooks/useTranscriptStream.ts` - ะฟะพะปััะตะฝะธะต ััะฐะฝัะบัะธะฟัะพะฒ ัะตัะตะท LiveKit data channel
- `src/contexts/TranscriptContext.tsx` - ะบะพะฝัะตะบัั ะดะปั ััะฐะฝัะบัะธะฟัะพะฒ
- `src/app/session/[slug]/page.tsx` - ัััะฐะฝะธัะฐ ัะตััะธะธ
- `src/modules/core/sessions/application/` - ะฑะธะทะฝะตั-ะปะพะณะธะบะฐ ัะตััะธะน

**ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั (Vercel):**
- `NEXT_PUBLIC_WS_HOST` - ัะพัั WebSocket ัะตัะฒะตัะฐ (ะฝะฐะฟัะธะผะตั, `sessions-ws-production.up.railway.app`)
- `NEXT_PUBLIC_WS_PORT` - ะฟะพัั WebSocket ัะตัะฒะตัะฐ (ะพะฟัะธะพะฝะฐะปัะฝะพ, ะดะปั Railway ะผะพะถะตั ะฑััั `3001`)
- `WS_SERVER_URL` - URL ะดะปั HTTP API ะฒัะทะพะฒะพะฒ (ะฝะฐะฟัะธะผะตั, `https://sessions-ws-production.up.railway.app`)
- `LIVEKIT_API_KEY`, `LIVEKIT_API_SECRET` - ะบะปััะธ LiveKit
- `NEXT_PUBLIC_LIVEKIT_URL` - WebSocket URL LiveKit
- `DATABASE_URL` - PostgreSQL (Neon)
- `TRANSCRIPTION_JWT_SECRET` - ัะตะบัะตั ะดะปั JWT ัะพะบะตะฝะพะฒ ััะฐะฝัะบัะธะฟัะธะธ

### Backend WebSocket Server (Railway)

**ะะตะฟะพะทะธัะพัะธะน:** `zerovoidrage/sessions-ws` (ะพัะดะตะปัะฝัะน ัะตะฟะพะทะธัะพัะธะน)

**ะะพะผะตะฝ:** `sessions-ws-production.up.railway.app`

**ะะปััะตะฒัะต ัะฐะนะปั:**
- `ws-server/server/index.ts` - ะณะปะฐะฒะฝัะน ัะฐะนะป ัะตัะฒะตัะฐ
- `ws-server/server/livekit-transcriber.ts` - ะทะฐะฟััะบ/ะพััะฐะฝะพะฒะบะฐ ััะฐะฝัะบัะธะฟัะธะธ
- `ws-server/server/livekit-room-composite-transcriber.ts` - Room Composite Egress
- `ws-server/server/rtmp-ingest.ts` - RTMP ingest ะธ FFmpeg
- `ws-server/server/rtmp-server.ts` - RTMP ัะตัะฒะตั
- `ws-server/server/client-connection.ts` - WebSocket ะดะปั ะบะปะธะตะฝัะพะฒ
- `ws-server/server/active-speaker-tracker.ts` - ััะตะบะตั ะฐะบัะธะฒะฝะพะณะพ ัะฟะธะบะตัะฐ
- `ws-server/server/gladia-bridge.ts` - ะธะฝัะตะณัะฐัะธั ั Gladia
- `ws-server/server/transcript-batch-queue.ts` - batch queue ะดะปั ััะฐะฝัะบัะธะฟัะพะฒ

**ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั (Railway):**
- `PORT=3001` - ะฟะพัั WebSocket ัะตัะฒะตัะฐ
- `RTMP_PORT=1935` - ะฟะพัั RTMP ัะตัะฒะตัะฐ
- `RTMP_HOST=sessions-ws-production.up.railway.app` - ัะพัั ะดะปั RTMP (ะธัะฟะพะปัะทัะตััั ะฒ Egress)
- `LIVEKIT_HTTP_URL` - HTTP URL LiveKit
- `LIVEKIT_API_KEY`, `LIVEKIT_API_SECRET` - ะบะปััะธ LiveKit
- `GLADIA_API_KEY` - ะบะปัั Gladia API
- `DATABASE_URL` - PostgreSQL (Neon)
- `TRANSCRIPTION_JWT_SECRET` - ัะตะบัะตั ะดะปั JWT ัะพะบะตะฝะพะฒ (ะดะพะปะถะตะฝ ัะพะฒะฟะฐะดะฐัั ั Vercel)

**ะะพััั ะฒ Railway:**
- **ะะพัั 3001** (HTTP/WebSocket) - ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฝะฐัััะพะตะฝ Railway
- **ะะพัั 1935** (TCP/RTMP) - ะดะพะฑะฐะฒะปะตะฝ ะฒัััะฝัั ะฒ Networking โ Add Port

### ะะฐะทะฐ ะดะฐะฝะฝัั (Neon PostgreSQL)

**ะัะฟะพะปัะทัะตััั ะพะฑะพะธะผะธ ัะตัะฒะธัะฐะผะธ:**
- Frontend (Next.js) - ะดะปั ััะตะฝะธั/ะทะฐะฟะธัะธ ัะตััะธะน, ััะฐััะฝะธะบะพะฒ, ััะฐะฝัะบัะธะฟัะพะฒ
- WebSocket Server (Railway) - ะดะปั ะทะฐะฟะธัะธ ััะฐะฝัะบัะธะฟัะพะฒ

**ะกัะตะผะฐ:**
- `VideoSession` - ัะตััะธะธ
- `Participant` - ััะฐััะฝะธะบะธ
- `TranscriptSegment` - ััะฐะฝัะบัะธะฟัั (ัะพะปัะบะพ ัะธะฝะฐะปัะฝัะต)
- `TranscriptionUsage` - ะผะตััะธะบะธ ะธัะฟะพะปัะทะพะฒะฐะฝะธั

### LiveKit Cloud

**ะะพะผะตะฝ:** `omni-pxx5e1ko.livekit.cloud`

**ะัะฟะพะปัะทัะตััั ะดะปั:**
- WebRTC ัะพะตะดะธะฝะตะฝะธะน ะผะตะถะดั ััะฐััะฝะธะบะฐะผะธ
- Room Composite Egress ะดะปั ะฟะพะปััะตะฝะธั ะผะธะบัะธัะพะฒะฐะฝะฝะพะณะพ ะฐัะดะธะพ
- Data channel ะดะปั ัะฐัะฟัะพัััะฐะฝะตะฝะธั ััะฐะฝัะบัะธะฟัะพะฒ

### Gladia API

**ะัะฟะพะปัะทัะตััั ะดะปั:**
- ะขัะฐะฝัะบัะธะฟัะธะธ ะฐัะดะธะพ ะฒ ัะตะบัั
- WebSocket ัะพะตะดะธะฝะตะฝะธะต ะดะปั real-time ััะฐะฝัะบัะธะฟัะธะธ

---

## ะกะปะตะดัััะธะต ัะฐะณะธ

### ะัะธะพัะธัะตั 1: ะัะฟัะฐะฒะธัั WebSocket ะฟะพะดะบะปััะตะฝะธะต

1. **ะัะพะฒะตัะธัั ะปะพะณะธ Railway:**
   - ะฃะฑะตะดะธัััั, ััะพ WebSocket ัะตัะฒะตั ะทะฐะฟััะตะฝ
   - ะัะพะฒะตัะธัั, ะฟัะธัะพะดัั ะปะธ ะทะฐะฟัะพัั ะฝะฐ `/api/realtime/transcribe`
   - ะัะพะฒะตัะธัั ะพัะธะฑะบะธ ะฟัะธ ะพะฑัะฐะฑะพัะบะต WebSocket upgrade

2. **ะัะพะฒะตัะธัั ะฝะฐัััะพะนะบะธ Railway:**
   - ะฃะฑะตะดะธัััั, ััะพ ะฟะพัั 3001 ะดะพัััะฟะตะฝ ะธะทะฒะฝะต
   - ะัะพะฒะตัะธัั, ะฟัะพะบัะธััะตััั ะปะธ WebSocket ัะตัะตะท ััะฐะฝะดะฐััะฝัะน ะฟะพัั 443

3. **ะฃััะฐะฝะพะฒะธัั ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั:**
   - ะ Vercel: `NEXT_PUBLIC_WS_PORT=3001` (ะตัะปะธ Railway ะฝะต ะฟัะพะบัะธััะตั ัะตัะตะท 443)
   - ะัะพะฒะตัะธัั, ััะพ `NEXT_PUBLIC_WS_HOST` ะฟัะฐะฒะธะปัะฝัะน

4. **ะัะพัะตััะธัะพะฒะฐัั ะฟะพะดะบะปััะตะฝะธะต:**
   - ะะพะฟัะพะฑะพะฒะฐัั ะฟะพะดะบะปััะธัััั ั ัะฒะฝัะผ ะฟะพััะพะผ: `wss://sessions-ws-production.up.railway.app:3001/api/realtime/transcribe?token=...`
   - ะัะพะฒะตัะธัั ะฒ ะฑัะฐัะทะตัะฝะพะน ะบะพะฝัะพะปะธ ะพัะธะฑะบะธ ะฟะพะดะบะปััะตะฝะธั

### ะัะธะพัะธัะตั 2: ะฃะปัััะธัั ะพะฟัะตะดะตะปะตะฝะธะต ัะฟะธะบะตัะพะฒ

1. **ะะฝัะตะณัะฐัะธั ั Gladia speaker diarization:**
   - ะัะฟะพะปัะทะพะฒะฐัั speaker IDs ะพั Gladia
   - ะะฐะฟะฟะธัั speaker IDs ะฝะฐ participant identities
   - ะะตะฐะปะธะทะพะฒะฐัั `ws-server/server/speaker-mapper.ts`

2. **ะฃะปัััะธัั ัะพัะฝะพััั:**
   - ะัะฟะพะปัะทะพะฒะฐัั ะฒัะตะผะตะฝะฝัะต ะผะตัะบะธ ะดะปั ะฑะพะปะตะต ัะพัะฝะพะณะพ ะผะฐะฟะฟะธะฝะณะฐ
   - ะฃัะธััะฒะฐัั ะฝะตัะบะพะปัะบะพ ัะฟะธะบะตัะพะฒ ะพะดะฝะพะฒัะตะผะตะฝะฝะพ

### ะัะธะพัะธัะตั 3: ะะพะฝะธัะพัะธะฝะณ ะธ ะผะตััะธะบะธ

1. **ะะพะฑะฐะฒะธัั ะผะพะฝะธัะพัะธะฝะณ:**
   - ะััะปะตะถะธะฒะฐะฝะธะต ะฐะบัะธะฒะฝัั ััะฐะฝัะบัะธะฟัะธะน
   - ะะพะฝะธัะพัะธะฝะณ ะพัะธะฑะพะบ WebSocket ะฟะพะดะบะปััะตะฝะธะน
   - ะะปะตััั ะฟัะธ ะฟัะพะฑะปะตะผะฐั

2. **ะฃะปัััะธัั ะผะตััะธะบะธ:**
   - ะฆะตะฝััะฐะปะธะทะพะฒะฐะฝะฝะพะต ััะฐะฝะตะฝะธะต ะผะตััะธะบ
   - Dashboard ะดะปั ะฒะธะทัะฐะปะธะทะฐัะธะธ
   - ะญะบัะฟะพัั ะดะฐะฝะฝัั

### ะัะธะพัะธัะตั 4: ะะฟัะธะผะธะทะฐัะธะธ

1. **ะะฟัะธะผะธะทะฐัะธั batch queue:**
   - ะะฐัััะพะธัั ะพะฟัะธะผะฐะปัะฝัะต ะธะฝัะตัะฒะฐะปั ะทะฐะฟะธัะธ
   - ะะพะฝะธัะพัะธะฝะณ ัะฐะทะผะตัะฐ ะพัะตัะตะดะธ

2. **ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ:**
   - Retry ะปะพะณะธะบะฐ ะดะปั WebSocket ะฟะพะดะบะปััะตะฝะธะน
   - ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ FFmpeg
   - Graceful degradation ะฟัะธ ะฟัะพะฑะปะตะผะฐั

---

## ะะพะปะตะทะฝัะต ัััะปะบะธ

- [ะะพะบัะผะตะฝัะฐัะธั LiveKit Egress](https://docs.livekit.io/egress/)
- [ะะพะบัะผะตะฝัะฐัะธั Gladia API](https://docs.gladia.io/)
- [Railway Documentation](https://docs.railway.app/)
- [WebSocket API MDN](https://developer.mozilla.org/en-US/docs/Web/API/WebSocket)

---

**ะะพัะปะตะดะฝะตะต ะพะฑะฝะพะฒะปะตะฝะธะต:** 2024-12-28  
**ะะฒัะพั:** AI Assistant  
**ะกัะฐััั:** ะ ัะฐะทัะฐะฑะพัะบะต

