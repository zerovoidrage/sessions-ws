# Testing Guide

## Unit Tests

Проект использует **Vitest** для unit тестов.

### Запуск тестов

```bash
# Запустить все тесты
npm test

# Запустить тесты в watch режиме
npm run test:watch

# Запустить тесты с UI
npm run test:ui
```

### Структура тестов

- `src/lib/__tests__/rate-limit.test.ts` - Тесты для rate limiting
- `ws/server/__tests__/audio-validator.test.ts` - Тесты для валидации аудио чанков
- `src/hooks/__tests__/useMediaControls.test.ts` - Базовые тесты для хука управления медиа
- `src/modules/core/sessions/application/__tests__/createSession.test.ts` - Тесты для создания сессий

### Покрытие

Критические компоненты покрыты тестами:
- ✅ Rate limiting (полное покрытие)
- ✅ Аудио валидация (полное покрытие)
- ✅ Базовая валидация хуков и функций

## Load Testing

### WebSocket Server Load Test

Нагрузочный тест для проверки WebSocket сервера под нагрузкой.

#### Предварительные требования

1. Запусти WebSocket сервер:
   ```bash
   npm run dev:ws
   ```

2. (Опционально) Настрой переменные окружения:
   ```bash
   export WS_HOST=localhost
   export WS_PORT=3001
   export WS_PROTOCOL=ws
   export API_URL=http://localhost:3000  # Для получения токенов
   export TEST_SESSION_SLUG=
   ```

#### Запуск теста

```bash
# Стандартный тест (15 участников)
npm run load-test

# Кастомное количество участников
npm run load-test 20

# Запусти тест (10 видео, 20 аудио участников, 5 минут)
npm run load-test:livekit 10 20 5m
```

#### Два типа нагрузочных тестов

### 1. WebSocket транскрипция (`npm run load-test`)

Тестирует только WebSocket сервер транскрипции:
- ✅ Подключение к WebSocket транскрипции
- ✅ Отправка аудио чанков
- ✅ Получение транскриптов
- ✅ Batch очередь и запись в БД
- ❌ Не создает участников в LiveKit (нет карточек в UI)

### 2. LiveKit синтетические участники (`npm run load-test:livekit`)

Использует официальный LiveKit CLI для создания синтетических участников:
- ✅ Реальные подключения к LiveKit
- ✅ Синтетическое видео и аудио
- ✅ Карточки участников в UI
- ✅ Нагрузка на LiveKit сервер
- ❌ Не подключается к WebSocket транскрипции

**См. подробности:** [load-test/README_LIVEKIT.md](../load-test/README_LIVEKIT.md)

## Что тестируется (WebSocket транскрипция)

- Подключение 10-20 участников к WebSocket серверу
- Отправка аудио чанков (PCM16, 16kHz, каждые 100ms)
- Получение транскриптов от Gladia
- Обработка ошибок
- Метрики сервера (очередь батча, память)

#### Мониторинг

**В консоли** тест выводит метрики каждые 5 секунд:
- Количество подключенных участников
- Общее количество отправленных аудио чанков
- Общее количество полученных транскриптов
- Количество ошибок
- Длина очереди батча
- Использование памяти

**Метрики сервера** доступны на:
```
http://localhost:3001/metrics
```

Смотри:
- `queue.queueLength` - текущая длина очереди батча
- `queue.totalQueued` - всего добавлено в очередь
- `queue.totalFlushed` - всего записано в БД
- `queue.totalErrors` - количество ошибок

**Логи и Sentry**:
- Проверь логи WebSocket сервера на ошибки
- Проверь Sentry dashboard на критические ошибки

#### Ожидаемые результаты

При нормальной работе:
- ✅ Все участники успешно подключаются
- ✅ Транскрипты приходят регулярно
- ✅ Очередь батча не растет бесконечно (периодически flush)
- ✅ Нет критических ошибок в Sentry
- ✅ Память стабильна (нет утечек)
- ✅ CPU умеренная (не 100%)

## Troubleshooting

### Тесты не запускаются

- Убедись что все зависимости установлены: `npm install`
- Проверь что `jsdom` установлен (для React тестов)

### Load test не подключается

- Проверь что WebSocket сервер запущен
- Проверь URL и порт в переменных окружения
- Проверь что токен генерируется корректно (в реальном тесте нужен валидный JWT)

### Очередь растет бесконечно

- Проверь что batch flush работает (логи сервера)
- Проверь подключение к БД
- Проверь метрики на `/metrics`

