# Load Test для WebSocket сервера транскрипции

## Описание

Минимальный нагрузочный тест для проверки WebSocket сервера под нагрузкой:
- 10-20 фейковых участников в 1-2 комнатах
- Поток транскрипции (аудио чанки каждые 100ms)
- Мониторинг метрик (CPU, память, очередь батча)

## Запуск

### Предварительные требования

1. Убедись, что Next.js сервер запущен (для получения токенов):
   ```bash
   npm run dev
   ```

2. Убедись, что WebSocket сервер запущен:
   ```bash
   npm run dev:ws
   ```

3. Настрой переменные окружения (опционально):
   ```bash
   export WS_HOST=localhost
   export WS_PORT=3001
   export WS_PROTOCOL=ws
   export API_URL=http://localhost:3000  # Для получения токенов
   export TEST_SESSION_SLUG=your-session-slug  # Slug существующей сессии
   ```
   
   **ВАЖНО**: Сессия должна существовать в БД. Если её нет, создай её через UI или API перед запуском теста.

### Запуск теста

**ВАЖНО**: Перед запуском создай сессию через UI и запомни её slug!

```bash
# 1. Создай сессию через UI (например, slug будет "abc123xyz")

# 2. Запусти тест с существующей сессией
export TEST_SESSION_SLUG=abc123xyz
npm run load-test

# Или кастомное количество участников
npm run load-test 20

# Если сессия не указана, тест использует 'load-test-session' (которой может не быть)
```

### Что делает тест:

1. **Создает участников в БД** — каждый участник регистрируется через `/api/sessions/[slug]/participants/join`
2. **Подключается к WebSocket транскрипции** — отправляет фейковые аудио чанки и получает транскрипты
3. **Подключается к LiveKit комнате** (опционально) — если `ENABLE_LIVEKIT=true` и доступны браузерные API

### Опциональные настройки:

```bash
# Включить подключение к LiveKit комнате (требует браузерных API, может не работать в Node.js)
export ENABLE_LIVEKIT=true
npm run load-test

# Изменить API URL (по умолчанию http://localhost:3000)
export API_URL=http://localhost:3000
npm run load-test
```

**Примечание**: LiveKit подключение работает только в браузерном окружении. В Node.js участники будут созданы в БД и подключены к транскрипции, но не к LiveKit комнате (если нет полифиллов для браузерных API).

## Что тестируется

1. **Подключение участников**: Успешное подключение всех участников к WebSocket серверу
2. **Отправка аудио**: Отправка PCM16 аудио чанков (16kHz, моно) каждые 100ms
3. **Получение транскриптов**: Получение транскриптов от Gladia через WebSocket
4. **Обработка ошибок**: Подсчет ошибок подключения и обработки
5. **Метрики сервера**: 
   - Длина очереди батча (`/metrics`)
   - Использование памяти
   - Количество отправленных/полученных сообщений

## Мониторинг

### Метрики в консоли

Тест выводит метрики каждые 5 секунд:
- Количество подключенных участников
- Общее количество отправленных аудио чанков
- Общее количество полученных транскриптов
- Количество ошибок
- Длина очереди батча
- Использование памяти

### Проверка метрик сервера

Открой в браузере:
```
http://localhost:3001/metrics
```

Смотри:
- `queue.queueLength` - текущая длина очереди батча
- `queue.totalQueued` - всего добавлено в очередь
- `queue.totalFlushed` - всего записано в БД
- `queue.totalErrors` - количество ошибок

### Sentry / Логи

1. Проверь Sentry dashboard на наличие ошибок
2. Проверь логи WebSocket сервера на:
   - Ошибки подключения
   - Ошибки batch flush
   - Переполнение очереди

## Ожидаемые результаты

При нормальной работе:
- ✅ Все участники успешно подключаются
- ✅ Транскрипты приходят регулярно (не все, но большинство)
- ✅ Очередь батча не растет бесконечно (периодически flush)
- ✅ Нет критических ошибок в Sentry
- ✅ Память стабильна (нет утечек)
- ✅ CPU умеренная (не 100%)

## Troubleshooting

### Участники не подключаются

- Проверь, что WebSocket сервер запущен
- Проверь URL и порт в переменных окружения
- Проверь, что токен генерируется корректно (в реальном тесте нужен валидный JWT)

### Очередь растет бесконечно

- Проверь, что batch flush работает (логи сервера)
- Проверь подключение к БД
- Проверь метрики на `/metrics`

### Высокое использование памяти

- Уменьши количество участников
- Проверь, что соединения закрываются корректно
- Проверь логи на утечки памяти

